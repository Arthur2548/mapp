<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Map Creator: Ancient Realm</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS/JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet.Draw -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <!-- Turf.js -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@400;500;600;700&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        /* Custom Theme: Ancient Cute Minimal */
        :root {
            --paper-bg: #FDF6E3;
            --wood-dark: #5D4037;
            --wood-light: #8D6E63;
            --gold-accent: #D4AF37;
            --text-main: #4E342E;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--paper-bg);
            color: var(--text-main);
            overflow: hidden;
        }

        h1, h2, h3, .fantasy-font, .btn-ancient {
            font-family: 'Mali', cursive;
        }

        /* Map Container */
        #map {
            height: 100vh;
            width: 100%;
            z-index: 0;
            background-color: #A5D6F5;
        }

        /* UI Containers */
        .sidebar-left {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 300px;
            background: rgba(253, 246, 227, 0.98);
            backdrop-filter: blur(10px);
            border-right: 3px solid var(--wood-light);
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 4px 0 20px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
        }

        .sidebar-collapsed {
            transform: translateX(-300px);
        }

        .toggle-sidebar-btn {
            position: absolute;
            top: 20px;
            right: -36px;
            background: var(--wood-light);
            color: #fff;
            width: 36px;
            height: 48px;
            border-radius: 0 12px 12px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 4px 2px 8px rgba(0,0,0,0.15);
            font-family: 'Mali', cursive;
            font-size: 1.2rem;
            transition: background 0.2s;
        }
        .toggle-sidebar-btn:hover { background: var(--wood-dark); }

        /* Modern Toolbar (Vertical, Top Right) */
        .toolbar-vertical {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }

        .tool-btn {
            width: 44px;
            height: 44px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            color: var(--wood-dark);
            transition: all 0.2s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .tool-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            color: var(--wood-light);
            border-color: var(--wood-light);
        }
        .tool-btn:active { transform: scale(0.95); }
        .tool-btn span { font-size: 24px; }

        .leaflet-draw { display: none !important; } 
        
        /* Modal Styling */
        .modal-overlay {
            background-color: rgba(93, 64, 55, 0.6);
            backdrop-filter: blur(4px);
        }
        .modal-paper {
            background-color: #FFFDF5;
            border: 3px solid var(--wood-light);
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #D7CCC8; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #BCAAA4; }

        /* Map Label Styling */
        .map-label-container { text-align: center; pointer-events: none; }
        .map-label-text {
            font-family: 'Mali', cursive;
            text-shadow: -1.5px -1.5px 0 #fff, 1.5px -1.5px 0 #fff, -1.5px 1.5px 0 #fff, 1.5px 1.5px 0 #fff;
            font-weight: 700;
            display: inline-block;
            white-space: nowrap;
            letter-spacing: 0.5px;
        }

        /* Form Elements */
        .input-ancient {
            background: #fff;
            border: 2px solid #E0E0E0;
            border-radius: 10px;
            padding: 8px 12px;
            width: 100%;
            outline: none;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .input-ancient:focus {
            border-color: var(--gold-accent);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .btn-ancient {
            background: var(--wood-dark);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 8px 20px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 0 #3E2723;
        }
        .btn-ancient:hover {
            background: var(--wood-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #3E2723;
        }
        .btn-ancient:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #3E2723;
        }

        /* Icon Grid */
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        .icon-option {
            font-size: 24px;
            padding: 8px;
            border: 2px solid #eee;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .icon-option:hover { background-color: #f0f0f0; }
        .icon-option.selected {
            border-color: var(--wood-dark);
            background-color: #FFE0B2;
            transform: scale(1.1);
        }
        
        /* Popup Styling */
        .leaflet-popup-content-wrapper {
            border-radius: 16px;
            padding: 0;
            overflow: visible;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .leaflet-popup-content { margin: 0 !important; width: 280px !important; }
        .leaflet-popup-tip { background: white; }
        .popup-header-bg {
            height: 60px;
            background: linear-gradient(135deg, #FFEFBA 0%, #FFFFFF 100%);
            border-radius: 16px 16px 0 0;
            position: relative;
        }
        .popup-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: -30px;
            background-color: #fff;
            object-fit: cover;
            z-index: 10;
        }

        /* Legend Box */
        .legend-box {
            position: absolute;
            bottom: 30px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 900;
            border: 2px solid var(--wood-light);
            max-width: 250px;
            max-height: 300px;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Hierarchy Tree Style */
        .hierarchy-box {
            background: linear-gradient(to bottom, #fffdf5, #f5f0e1);
            border: 1px solid #e6dcc8;
            border-radius: 8px;
            padding: 8px 12px;
            margin-top: 8px;
            max-height: 120px;
            overflow-y: auto;
        }
        .hierarchy-title {
            font-size: 10px;
            font-weight: bold;
            color: #a1887f;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px dashed #d7ccc8;
            padding-bottom: 2px;
        }
        .h-item {
            display: flex;
            align-items: center;
            position: relative;
            padding-left: 12px;
            margin-bottom: 2px;
        }
        .h-line {
            position: absolute;
            left: 3px;
            top: 12px;
            bottom: -8px;
            width: 1px;
            background-color: #d7ccc8;
        }
        .h-item:last-child .h-line { display: none; }
        .h-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background-color: #d7ccc8;
            margin-right: 8px;
            z-index: 1;
            flex-shrink: 0;
        }
        .h-item.active .h-dot {
            background-color: #5D4037;
            border: 2px solid #D4AF37; /* Gold border */
            width: 9px;
            height: 9px;
            left: -1px;
            position: relative;
        }
        .h-info {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }
        .h-rank {
            font-size: 8px;
            color: #9e9e9e;
        }
        .h-name {
            font-size: 11px;
            font-weight: 600;
            color: #5d4037;
        }
        .h-item.active .h-name {
            color: #d32f2f;
            font-weight: 700;
        }
    </style>
</head>
<body>

    <!-- Left Sidebar -->
    <div id="sidebar-left" class="sidebar-left p-5">
        <div class="toggle-sidebar-btn" id="toggle-sidebar">‚óÄ</div>
        
        <!-- Header -->
        <div class="text-center mb-6 border-b-2 border-dotted border-[#8D6E63] pb-4">
            <h1 class="text-2xl font-bold text-[#5D4037] drop-shadow-sm">üìú ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ü‡∏ô‡∏ï‡∏≤‡∏ã‡∏µ</h1>
            <p id="user-id-display" class="text-xs text-gray-500 mt-1 font-mono">Guest Mode</p>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto space-y-5 pr-1 custom-scrollbar">
            
            <!-- Layer Control -->
            <div class="bg-white/60 p-4 rounded-2xl border border-white shadow-sm">
                <h3 class="font-bold text-[#5D4037] mb-3 flex items-center gap-2">
                    <span class="material-icons-round text-sm">layers</span> ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á & ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                </h3>
                <div class="flex gap-2 mb-3">
                    <button id="btn-map-nolabels" class="flex-1 text-xs py-2 rounded-lg bg-[#5D4037] text-white hover:bg-[#4E342E] transition">‡∏™‡∏∞‡∏≠‡∏≤‡∏î</button>
                    <button id="btn-map-osm" class="flex-1 text-xs py-2 rounded-lg bg-[#A1887F] text-white hover:bg-[#8D6E63] transition">OSM</button>
                    <button id="btn-map-sat" class="flex-1 text-xs py-2 rounded-lg bg-[#8D6E63] text-white hover:bg-[#5D4037] transition">‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°</button>
                </div>
                
                <div class="space-y-2">
                    <div class="flex items-center">
                        <input type="checkbox" id="toggle-original-labels" class="accent-[#5D4037] mr-2 h-4 w-4 rounded cursor-pointer">
                        <label for="toggle-original-labels" class="text-sm cursor-pointer select-none">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏∞‡∏≠‡∏≤‡∏î)</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="toggle-created-labels" checked class="accent-[#5D4037] mr-2 h-4 w-4 rounded cursor-pointer">
                        <label for="toggle-created-labels" class="text-sm cursor-pointer select-none">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</label>
                    </div>
                     <!-- NEW: Toggle Roads -->
                    <div class="flex items-center">
                        <input type="checkbox" id="toggle-roads" checked class="accent-[#5D4037] mr-2 h-4 w-4 rounded cursor-pointer">
                        <label for="toggle-roads" class="text-sm cursor-pointer select-none font-bold text-[#8D6E63]">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á/‡∏ñ‡∏ô‡∏ô</label>
                    </div>
                </div>
                
                <!-- Opacity Slider -->
                <div class="mt-4 pt-3 border-t border-gray-200">
                    <div class="flex justify-between text-xs font-bold text-[#5D4037] mb-1">
                        <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</span>
                        <span id="opacity-val">60%</span>
                    </div>
                    <input type="range" id="opacity-slider" min="0" max="1" step="0.05" value="0.6" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-[#5D4037]">
                </div>

                <!-- Global Stroke Color -->
                <div class="mt-3">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold text-[#5D4037]">‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</span>
                        <div class="flex items-center gap-2 bg-white px-2 py-1 rounded border border-gray-200">
                            <input type="color" id="global-stroke-color" value="#5D4037" class="w-6 h-6 border-0 p-0 rounded cursor-pointer bg-transparent">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filter -->
            <div class="bg-white/60 p-4 rounded-2xl border border-white shadow-sm">
                <h3 class="font-bold text-[#5D4037] mb-3 flex items-center gap-2">
                    <span class="material-icons-round text-sm">filter_alt</span> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ & ‡∏Å‡∏£‡∏≠‡∏á
                </h3>
                <div class="relative mb-3">
                    <span class="material-icons-round absolute left-2 top-2 text-gray-400 text-sm">search</span>
                    <input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." class="input-ancient pl-8 text-sm">
                </div>
                
                <!-- NEW: Level Filter -->
                <div class="mb-3">
                     <div class="font-bold text-[#5D4037] text-xs mb-1">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå</div>
                     <div id="filter-levels-container" class="grid grid-cols-2 gap-x-2 gap-y-1 max-h-24 overflow-y-auto custom-scrollbar">
                         <!-- JS Will Populate -->
                     </div>
                </div>

                <div class="text-xs font-bold text-[#5D4037] mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
                <div class="grid grid-cols-2 gap-y-1 text-sm">
                    <label class="flex items-center cursor-pointer"><input type="checkbox" checked class="filter-status accent-[#5D4037] mr-1" value="all"> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                    <label class="flex items-center cursor-pointer"><input type="checkbox" checked class="filter-status accent-[#5D4037] mr-1" value="independent"> ‡∏£‡∏±‡∏ê‡∏≠‡∏¥‡∏™‡∏£‡∏∞</label>
                    <label class="flex items-center cursor-pointer"><input type="checkbox" checked class="filter-status accent-[#5D4037] mr-1" value="annexed"> ‡∏ñ‡∏π‡∏Å‡∏ú‡∏ô‡∏ß‡∏Å</label>
                    <label class="flex items-center cursor-pointer"><input type="checkbox" class="filter-status accent-[#5D4037] mr-1" value="vassal"> ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä</label>
                    <label class="flex items-center cursor-pointer"><input type="checkbox" class="filter-status accent-[#5D4037] mr-1" value="colony"> ‡∏≠‡∏≤‡∏ì‡∏≤‡∏ô‡∏¥‡∏Ñ‡∏°</label>
                </div>
            </div>

            <!-- Color Mode -->
            <div class="bg-white/60 p-4 rounded-2xl border border-white shadow-sm">
                <h3 class="font-bold text-[#5D4037] mb-2 flex items-center gap-2">
                    <span class="material-icons-round text-sm">palette</span> ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏µ
                </h3>
                <select id="color-mode-select" class="input-ancient text-sm cursor-pointer">
                    <option value="entity">‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</option>
                    <option value="religion">‡∏ï‡∏≤‡∏°‡∏®‡∏≤‡∏™‡∏ô‡∏≤</option>
                    <option value="government">‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏≠‡∏ö‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</option>
                </select>
                <div id="color-mode-hint" class="hidden text-[10px] text-gray-500 mt-2 text-center bg-yellow-50 p-1 rounded">
                    <span class="material-icons-round text-[10px] align-middle">info</span> ‡∏î‡∏π‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á
                </div>
            </div>
        </div>
    </div>

    <!-- Vertical Toolbar -->
    <div class="toolbar-vertical">
        <div class="tool-btn" onclick="startDrawPolygon()" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà">
            <span class="material-icons-round text-green-600">terrain</span>
        </div>
        <div class="tool-btn" onclick="startDrawPolyline()" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á">
            <span class="material-icons-round text-amber-700">alt_route</span>
        </div>
        <div class="tool-btn" onclick="startDrawMarker()" title="‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î">
            <span class="material-icons-round text-red-500">place</span>
        </div>
        <div class="h-px bg-gray-300 mx-2 my-1"></div>
        <div class="tool-btn" onclick="toggleFullScreen()" title="‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠">
            <span class="material-icons-round">fullscreen</span>
        </div>
    </div>

    <!-- Map Area -->
    <div id="map"></div>

    <!-- Dynamic Legend Box -->
    <div id="legend-box" class="legend-box hidden">
        <div class="flex justify-between items-center mb-2 border-b border-gray-200 pb-1">
            <h4 class="font-bold text-[#5D4037] text-sm" id="legend-title">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏µ</h4>
            <button onclick="document.getElementById('legend-box').classList.add('hidden')" class="text-gray-400 hover:text-red-500">
                <span class="material-icons-round text-sm">close</span>
            </button>
        </div>
        <div id="legend-content" class="space-y-2 text-xs"></div>
    </div>

    <!-- Modal: Create/Edit Area -->
    <div id="modal-area" class="fixed inset-0 modal-overlay hidden z-[2000] flex items-center justify-center">
        <div class="modal-paper w-full max-w-2xl p-6 relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal('modal-area')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition">
                <span class="material-icons-round text-2xl">close</span>
            </button>
            
            <h2 class="text-2xl text-[#5D4037] font-bold mb-6 flex items-center gap-2 border-b border-dashed border-[#D7CCC8] pb-3">
                <span class="material-icons-round text-3xl text-[#D4AF37]">edit_location_alt</span>
                <span id="modal-title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Ç‡∏ï‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</span>
            </h2>

            <form id="form-area" class="space-y-5">
                <input type="hidden" id="area-id">
                
                <div class="flex gap-6 items-start">
                    <!-- Flag Upload -->
                    <div class="flex-shrink-0 flex flex-col items-center w-28">
                        <div class="relative group cursor-pointer" onclick="document.getElementById('inp-flag').click()">
                            <img id="preview-flag" src="" class="flag-circle hidden transition group-hover:brightness-90">
                            <div id="preview-flag-placeholder" class="flag-circle flex items-center justify-center bg-gray-100 text-gray-300 group-hover:bg-gray-200 transition">
                                <span class="material-icons-round text-4xl">add_photo_alternate</span>
                            </div>
                        </div>
                        <input type="file" id="inp-flag" class="hidden" accept="image/*">
                        <span class="text-[10px] text-gray-500 mt-2">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏≤</span>
                    </div>

                    <!-- Main Info -->
                    <div class="flex-grow space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-[#8D6E63] uppercase tracking-wider mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</label>
                                <input type="text" id="inp-name" class="input-ancient font-bold text-[#5D4037]" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏Ñ‡∏£‡∏î‡∏£‡∏≤‡∏Å‡πâ‡∏≠‡∏ô">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-[#8D6E63] uppercase tracking-wider mb-1 block">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (ID)</label>
                                <input type="text" id="inp-custom-id" class="input-ancient font-mono text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ZONE-01">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-[#8D6E63] uppercase tracking-wider mb-1 block">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå</label>
                                <select id="inp-level" class="input-ancient font-bold text-[#5D4037] bg-white cursor-pointer"></select>
                            </div>
                             <div>
                                <label class="text-xs font-bold text-[#8D6E63] uppercase tracking-wider mb-1 block">‡πÄ‡∏Ç‡∏ï‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÅ‡∏°‡πà</label>
                                <select id="inp-parent" class="input-ancient text-sm bg-white cursor-pointer">
                                    <option value="">-- ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞ / ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î --</option>
                                </select>
                            </div>
                        </div>
                         <div>
                             <label class="text-xs font-bold text-[#8D6E63] uppercase tracking-wider mb-1 block">‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</label>
                             <input type="text" id="inp-ruler" class="input-ancient" required>
                         </div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 pt-2">
                    <div>
                        <label class="text-xs font-bold text-[#8D6E63] mb-1 block">‡∏®‡∏≤‡∏™‡∏ô‡∏≤</label>
                        <select id="inp-religion" class="input-ancient text-sm bg-white">
                            <option>‡∏û‡∏∏‡∏ó‡∏ò</option><option>‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå</option><option>‡∏≠‡∏¥‡∏™‡∏•‡∏≤‡∏°</option>
                            <option>‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏ì‡πå‡∏Æ‡∏¥‡∏ô‡∏î‡∏π</option><option>‡∏®‡∏≤‡∏™‡∏ô‡∏≤‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-[#8D6E63] mb-1 block">‡∏£‡∏∞‡∏ö‡∏≠‡∏ö‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</label>
                        <select id="inp-gov" class="input-ancient text-sm bg-white">
                            <option>‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå</option><option>‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ò‡∏¥‡∏õ‡πÑ‡∏ï‡∏¢</option>
                            <option>‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ß‡∏ô‡∏¥‡∏™‡∏ï‡πå</option><option>‡∏õ‡∏£‡∏¥‡∏°‡∏¥‡∏ï‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå</option>
                        </select>
                    </div>
                    <div>
                         <label class="text-xs font-bold text-[#8D6E63] mb-1 block">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</label>
                         <div class="flex gap-2 mt-1.5 bg-white p-1 rounded-lg border border-gray-200">
                             <label class="flex-1 flex items-center justify-center gap-1 cursor-pointer py-1 rounded hover:bg-gray-50">
                                 <input type="radio" name="areaType" value="land" checked class="accent-[#5D4037]"> <span class="text-xs">‡∏î‡∏¥‡∏ô</span>
                             </label>
                             <label class="flex-1 flex items-center justify-center gap-1 cursor-pointer py-1 rounded hover:bg-gray-50">
                                 <input type="radio" name="areaType" value="water" class="accent-[#2980B9]"> <span class="text-xs">‡∏ô‡πâ‡∏≥</span>
                             </label>
                         </div>
                    </div>
                </div>

                <div class="pt-2 grid grid-cols-2 gap-4 border-t border-dashed border-[#D7CCC8]">
                    <div class="pt-2">
                        <label class="text-xs font-bold text-[#8D6E63] mb-1 block">‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏Ç‡∏ï</label>
                        <div class="flex items-center gap-2 bg-white p-2 rounded-lg border border-gray-200">
                            <input type="color" id="inp-color" class="w-10 h-8 border-0 rounded cursor-pointer bg-transparent">
                            <span class="text-xs text-gray-500">‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡πà‡∏á‡πÅ‡∏¢‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</span>
                        </div>
                    </div>
                    <div class="pt-2">
                        <label class="text-xs font-bold text-[#8D6E63] mb-1 block">‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</label>
                        <div class="flex items-center gap-2 bg-white p-2 rounded-lg border border-gray-200">
                            <input type="color" id="inp-label-color" class="w-10 h-8 border-0 rounded cursor-pointer bg-transparent" value="#4E342E">
                            <span class="text-xs text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-6 pt-4">
                    <button type="button" onclick="cancelDraw()" class="px-4 py-2 text-gray-500 hover:text-gray-700 font-bold font-sans text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn-ancient shadow-lg transform active:scale-95 transition flex items-center gap-2">
                        <span class="material-icons-round text-sm">save</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- War Room Modal -->
    <div id="modal-war" class="fixed inset-0 modal-overlay hidden z-[2100] flex items-center justify-center">
        <div class="modal-paper w-96 p-6 relative">
            <button onclick="closeModal('modal-war')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition">
                <span class="material-icons-round">close</span>
            </button>
            <h3 class="text-xl font-bold text-red-800 mb-4 flex items-center gap-2 border-b border-red-200 pb-2">
                <span class="material-icons-round">sports_kabaddi</span> ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°
            </h3>
            <div class="space-y-4">
                <div class="bg-red-50 p-3 rounded-lg border border-red-100">
                    <label class="text-xs font-bold text-red-700 block mb-1">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label>
                    <div id="war-target-name" class="font-bold text-gray-800 text-lg">---</div>
                    <input type="hidden" id="war-target-id">
                </div>
                <div class="text-center text-gray-400 font-bold text-xl my-1">VS</div>
                <div>
                    <label class="text-xs font-bold text-[#5D4037] block mb-1">‡∏ù‡πà‡∏≤‡∏¢‡∏£‡∏∏‡∏Å</label>
                    <select id="war-attacker-select" class="input-ancient w-full bg-white cursor-pointer"></select>
                </div>
            </div>
            <div class="mt-6">
                <label class="text-xs font-bold text-gray-500 block mb-2 text-center">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="confirmWarAction('annex')" class="py-2 rounded-lg bg-red-600 text-white text-xs font-bold hover:bg-red-700 shadow flex flex-col items-center">
                        <span class="material-icons-round text-base">flag</span> ‡∏ú‡∏ô‡∏ß‡∏Å
                    </button>
                    <button onclick="confirmWarAction('vassal')" class="py-2 rounded-lg bg-purple-600 text-white text-xs font-bold hover:bg-purple-700 shadow flex flex-col items-center">
                        <span class="material-icons-round text-base">security</span> ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä
                    </button>
                    <button onclick="confirmWarAction('colony')" class="py-2 rounded-lg bg-blue-600 text-white text-xs font-bold hover:bg-blue-700 shadow flex flex-col items-center">
                        <span class="material-icons-round text-base">public</span> ‡∏≠‡∏≤‡∏ì‡∏≤‡∏ô‡∏¥‡∏Ñ‡∏°
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: Road -->
    <div id="modal-road" class="fixed inset-0 modal-overlay hidden z-[2000] flex items-center justify-center">
        <div class="modal-paper w-96 p-6 relative">
            <button onclick="closeModal('modal-road')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition">
                <span class="material-icons-round">close</span>
            </button>
            <h3 class="text-xl font-bold text-[#5D4037] mb-4 flex items-center gap-2">
                <span class="material-icons-round">add_road</span> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
            </h3>
            <div class="space-y-3">
                <input type="hidden" id="road-id-hidden">
                <div>
                    <label class="text-xs font-bold text-[#8D6E63] mb-1 block">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ñ‡∏ô‡∏ô</label>
                    <input type="text" id="road-custom-id" placeholder="‡πÄ‡∏ä‡πà‡∏ô R-01" class="input-ancient">
                </div>
                <div>
                    <label class="text-xs font-bold text-[#8D6E63] mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</label>
                    <input type="text" id="road-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏ô‡∏ô / ‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á..." class="input-ancient">
                </div>
                <div>
                    <label class="text-xs font-bold text-[#8D6E63] mb-1 block">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                    <select id="road-type" class="input-ancient bg-white">
                        <option value="trade">‡∏ñ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏∂‡∏ö)</option>
                        <option value="army">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏±‡∏û (‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞)</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-[#8D6E63] mb-1 block">‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</label>
                    <input type="color" id="road-color" value="#5D4037" class="w-full h-10 rounded cursor-pointer">
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="cancelDraw()" class="px-4 py-2 text-gray-500 text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveRoad()" class="btn-ancient text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</button>
            </div>
        </div>
    </div>

    <!-- Modal Marker -->
    <div id="modal-marker" class="fixed inset-0 modal-overlay hidden z-[2000] flex items-center justify-center">
        <div class="modal-paper w-96 p-6 relative">
            <button onclick="closeModal('modal-marker')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition">
                <span class="material-icons-round">close</span>
            </button>
            <h3 class="text-xl font-bold text-[#5D4037] mb-4 flex items-center gap-2">
                <span class="material-icons-round">place</span> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
            </h3>
            <div class="space-y-4">
                <input type="text" id="marker-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..." class="input-ancient font-bold text-[#5D4037]">
                
                <div>
                    <label class="text-xs font-bold text-[#8D6E63] mb-1 block">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå</label>
                    <div id="marker-icon-grid" class="icon-grid bg-white p-2 rounded-lg border border-gray-200 h-32 overflow-y-auto custom-scrollbar">
                        <!-- Icons populated by JS -->
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-[#8D6E63] mb-1 block">‡∏™‡∏µ‡∏´‡∏°‡∏∏‡∏î</label>
                    <input type="color" id="marker-color" value="#D32F2F" class="w-full h-8 rounded cursor-pointer">
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="cancelDraw()" class="px-4 py-2 text-gray-500 text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveMarker()" class="btn-ancient text-sm">‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î</button>
            </div>
        </div>
    </div>

    <!-- NEW: Confirmation Modal -->
    <div id="modal-confirm" class="fixed inset-0 modal-overlay hidden z-[3000] flex items-center justify-center">
        <div class="modal-paper w-80 p-6 text-center transform scale-100 transition-all">
            <h3 class="text-xl font-bold text-[#5D4037] mb-2" id="confirm-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</h3>
            <p class="text-sm text-gray-600 mb-6" id="confirm-msg">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
            <div class="flex gap-2 justify-center">
                <button onclick="closeModal('modal-confirm')" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 text-sm font-bold hover:bg-gray-300">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="executePendingConfirm()" class="px-4 py-2 rounded-lg bg-[#5D4037] text-white text-sm font-bold hover:bg-[#4E342E] shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: If hosting externally, you MUST replace this with your own Firebase Config!
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAaHROgav2BOEsqTZRNhTVdJPSKZoYoIVI", 
            authDomain: "map2-d18dc.firebaseapp.com",
            projectId: "map2-d18dc",
            storageBucket: "map2-d18dc.firebasestorage.app",
            appId: "1:993020770694:web:281b572e2170f7f1209407"
        };
        const appId = firebaseConfig.projectId || "map2-d18dc";

        // Globals
        let db, auth, userId, map, drawnItems;
        let entities = []; 
        let currentDrawLayer = null;
        let mapLayers = {};
        let globalOpacity = 0.6;
        let globalStrokeColor = '#5D4037';
        let selectedMarkerIcon = 'üìç';
        let pendingConfirmAction = null; 

        // Constants
        const HIERARCHY = [
            { id: 'mahaAnachak', name: '‡∏°‡∏´‡∏≤‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£', rank: 9, defaultColor: '#884A51' },
            { id: 'anachak', name: '‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£', rank: 8, defaultColor: '#AD8B73' },
            { id: 'prathet', name: '‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®/‡∏£‡∏≤‡∏ä‡∏£‡∏±‡∏ê', rank: 7, defaultColor: '#CEAB93' },
            { id: 'monrath', name: '‡∏°‡∏ì‡∏£‡∏±‡∏ê (‡∏†‡∏≤‡∏Ñ)', rank: 6, defaultColor: '#E3CAA5' },
            { id: 'monthon', name: '‡∏°‡∏ì‡∏ë‡∏•', rank: 5, defaultColor: '#BB9981' },
            { id: 'jangwat', name: '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏ô‡∏Ñ‡∏£/‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', rank: 4, defaultColor: '#7E6B5A' },
            { id: 'amphoe', name: '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏≠‡∏≤‡πÄ‡∏Ç‡∏ï', rank: 3, defaultColor: '#56423A' },
            { id: 'tambon', name: '‡∏ï‡∏≥‡∏ö‡∏•/‡πÄ‡∏Ç‡∏ï', rank: 2, defaultColor: '#3A2E39' },
            { id: 'muban', name: '‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô/‡πÅ‡∏Ç‡∏ß‡∏á', rank: 1, defaultColor: '#251E3E' }
        ];

        const MARKER_ICONS = ['üìç','üè†','üå≤','‚õ∞Ô∏è','üè∞','‚õ∫','üèôÔ∏è','üëë','üíÄ','üõï','‚öì','‚öîÔ∏è','üíé','üåæ','ü©∏'];

        const COLORS = {
            religion: { '‡∏û‡∏∏‡∏ó‡∏ò': '#F1C40F', '‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå': '#3498DB', '‡∏≠‡∏¥‡∏™‡∏•‡∏≤‡∏°': '#2ECC71', '‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏ì‡πå‡∏Æ‡∏¥‡∏ô‡∏î‡∏π': '#E91E63', '‡∏®‡∏≤‡∏™‡∏ô‡∏≤‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°': '#95A5A6' },
            gov: { '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ò‡∏¥‡∏õ‡πÑ‡∏ï‡∏¢': '#2ECC71', '‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ß‡∏ô‡∏¥‡∏™‡∏ï‡πå': '#E74C3C', '‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå': '#8E44AD', '‡∏õ‡∏£‡∏¥‡∏°‡∏¥‡∏ï‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå': '#F39C12' }
        };

        // --- Init ---
        window.onload = async () => {
            // SAFE MODE: Run setupUI first to ensure UI is ready regardless of network
            try {
                initMap();
                setupUI();
            } catch(e) { console.error("UI/Map Init error:", e); }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                        else await signInAnonymously(auth);
                    } else {
                        userId = user.uid;
                        document.getElementById('user-id-display').innerText = `Lord ID: ${userId.substring(0,6)}`;
                        
                        // Hook up Firestore listener
                        const areasRef = collection(db, 'artifacts', appId, 'users', userId, 'fantasy_empires');
                        onSnapshot(areasRef, (snap) => {
                            entities = snap.docs.map(d => ({id: d.id, ...d.data()}));
                            renderMap();
                        }, (error) => console.error(error));
                    }
                });
            } catch (err) {
                console.error("Firebase connection failed:", err);
                // Removed alert as per request to prevent blocking UI
            }
        };

        function initMap() {
            if (map) return; 
            
            // 1. Clean Map (No Labels) - Using CartoDB Voyager No Labels
            const noLabelsLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            });

            // 2. Standard OpenStreetMap (Has Labels)
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            });

            // 3. Satellite
            const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });

            // 4. Labels Overlay (Only Labels) - to be used with Clean Map
            const labelsOnlyLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19,
                opacity: 0.7
            });

            // Set default to No Labels (Clean)
            map = L.map('map', { center: [13.7563, 100.5018], zoom: 6, zoomControl: false, layers: [noLabelsLayer] });

            mapLayers = { nolabels: noLabelsLayer, osm: osmLayer, sat: satLayer, labels: labelsOnlyLayer };
            drawnItems = L.featureGroup().addTo(map);

            map.addControl(new L.Control.Draw({
                edit: { featureGroup: drawnItems },
                draw: { polygon: true, polyline: true, marker: true, rectangle: false, circle: false, circlemarker: false }
            }));

            map.on(L.Draw.Event.CREATED, onDrawCreated);
            map.on(L.Draw.Event.EDITED, onDrawEdited);
        }

        function setupUI() {
            const toggleBtn = document.getElementById('toggle-sidebar');
            if(toggleBtn) toggleBtn.onclick = () => {
                document.getElementById('sidebar-left').classList.toggle('sidebar-collapsed');
                toggleBtn.innerText = document.getElementById('sidebar-left').classList.contains('sidebar-collapsed') ? '‚ñ∂' : '‚óÄ';
            };

            // Map Layer Buttons
            document.getElementById('btn-map-nolabels').onclick = () => { 
                map.removeLayer(mapLayers.osm); 
                map.removeLayer(mapLayers.sat); 
                map.addLayer(mapLayers.nolabels); 
                // Restore label preference
                if(document.getElementById('toggle-original-labels').checked) map.addLayer(mapLayers.labels);
            };
            
            document.getElementById('btn-map-osm').onclick = () => { 
                map.removeLayer(mapLayers.nolabels); 
                map.removeLayer(mapLayers.sat); 
                map.removeLayer(mapLayers.labels); // OSM has baked-in labels
                map.addLayer(mapLayers.osm); 
            };
            
            document.getElementById('btn-map-sat').onclick = () => { 
                map.removeLayer(mapLayers.nolabels); 
                map.removeLayer(mapLayers.osm); 
                map.removeLayer(mapLayers.labels);
                map.addLayer(mapLayers.sat); 
            };
            
            // Toggle Original Labels (Only works effectively on Clean Map / Sat)
            document.getElementById('toggle-original-labels').onchange = (e) => {
                // Only toggle if we aren't on standard OSM (which forces labels)
                if (!map.hasLayer(mapLayers.osm)) {
                    if(e.target.checked) map.addLayer(mapLayers.labels); 
                    else map.removeLayer(mapLayers.labels);
                }
            };

            // Filters & Toggles
            document.getElementById('toggle-created-labels')?.addEventListener('change', renderMap);
            document.getElementById('toggle-roads')?.addEventListener('change', renderMap);
            
            // Populate Hierarchy Filter (SAFE)
            const filterContainer = document.getElementById('filter-levels-container');
            if(filterContainer && HIERARCHY) {
                filterContainer.innerHTML = ''; // clear
                HIERARCHY.forEach(h => {
                    const div = document.createElement('div');
                    div.innerHTML = `<label class="flex items-center text-xs cursor-pointer"><input type="checkbox" checked class="filter-level accent-[#5D4037] mr-1" value="${h.id}"> ${h.name}</label>`;
                    filterContainer.appendChild(div);
                });
            }

            // Sliders & Colors
            document.getElementById('opacity-slider')?.addEventListener('input', (e) => {
                globalOpacity = parseFloat(e.target.value);
                document.getElementById('opacity-val').innerText = Math.round(globalOpacity*100) + '%';
                renderMap();
            });
            document.getElementById('global-stroke-color')?.addEventListener('input', (e) => {
                globalStrokeColor = e.target.value;
                renderMap();
            });

            // Color Mode
            document.getElementById('color-mode-select')?.addEventListener('change', (e) => {
                const mode = e.target.value;
                const hint = document.getElementById('color-mode-hint');
                const legendBox = document.getElementById('legend-box');
                if (mode === 'religion' || mode === 'government') {
                    hint?.classList.remove('hidden'); legendBox?.classList.remove('hidden'); updateLegend(mode);
                } else {
                    hint?.classList.add('hidden'); legendBox?.classList.add('hidden');
                }
                renderMap();
            });

            // Populate Rank Dropdown
            const levelSelect = document.getElementById('inp-level');
            if(levelSelect && HIERARCHY) {
                levelSelect.innerHTML = '';
                HIERARCHY.forEach(h => {
                    const opt = document.createElement('option');
                    opt.value = h.id; opt.text = h.name;
                    levelSelect.appendChild(opt);
                });
                levelSelect.onchange = (e) => {
                    const lvl = HIERARCHY.find(h => h.id === e.target.value);
                    if(lvl) document.getElementById('inp-color').value = lvl.defaultColor;
                    updateParentSelect(lvl ? lvl.rank : 0);
                };
            }

            // Marker Icons
            const iconGrid = document.getElementById('marker-icon-grid');
            if(iconGrid && MARKER_ICONS) {
                iconGrid.innerHTML = '';
                MARKER_ICONS.forEach(icon => {
                    const el = document.createElement('div');
                    el.className = 'icon-option';
                    el.innerText = icon;
                    el.onclick = () => {
                        document.querySelectorAll('.icon-option').forEach(i => i.classList.remove('selected'));
                        el.classList.add('selected');
                        selectedMarkerIcon = icon;
                    };
                    if(icon === 'üìç') el.classList.add('selected');
                    iconGrid.appendChild(el);
                });
            }

            // Listeners
            const formArea = document.getElementById('form-area');
            if(formArea) formArea.onsubmit = saveArea;
            
            document.querySelectorAll('.filter-status, .filter-level, #search-input').forEach(el => {
                el.addEventListener('change', renderMap);
                if(el.id === 'search-input') el.addEventListener('keyup', renderMap);
            });
            
            // Image Preview
            document.getElementById('inp-flag')?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        document.getElementById('preview-flag').src = evt.target.result;
                        document.getElementById('preview-flag').classList.remove('hidden');
                        document.getElementById('preview-flag-placeholder').classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Labels & Roads Toggles
            document.getElementById('toggle-created-labels')?.addEventListener('change', renderMap);
            document.getElementById('toggle-roads')?.addEventListener('change', renderMap);
        }

        function updateLegend(mode) {
            const container = document.getElementById('legend-content');
            if(!container) return;
            container.innerHTML = '';
            const data = mode === 'religion' ? COLORS.religion : COLORS.gov;
            document.getElementById('legend-title').innerText = mode === 'religion' ? '‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏®‡∏≤‡∏™‡∏ô‡∏≤' : '‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏≠‡∏ö‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á';
            for (const [key, color] of Object.entries(data)) {
                container.innerHTML += `<div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full border border-gray-300 shadow-sm" style="background-color: ${color}"></span><span>${key}</span></div>`;
            }
            container.innerHTML += `<div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full border border-gray-300 shadow-sm" style="background-color: #ccc"></span><span>‡∏≠‡∏∑‡πà‡∏ô ‡πÜ / ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span></div>`;
        }

        // --- Hierarchy Helpers ---
        function getAllAncestors(ent) {
            const ancestors = [];
            let current = ent;
            let depth = 0;
            while (current.parentId && depth < 20) {
                const parent = entities.find(e => e.id === current.parentId);
                if (parent) { ancestors.push(parent); current = parent; } else { break; }
                depth++;
            }
            return ancestors.reverse();
        }

        function getDescendants(parentIds) {
            let descendants = [];
            let queue = [...parentIds];
            let visited = new Set(parentIds);
            let limit = 0;
            while(queue.length > 0 && limit < 5000) {
                const pid = queue.shift();
                const children = entities.filter(e => e.parentId === pid);
                children.forEach(c => {
                    if(!visited.has(c.id)) { visited.add(c.id); descendants.push(c); queue.push(c.id); }
                });
                limit++;
            }
            return descendants;
        }

        // --- Render Logic ---
        function renderMap() {
            if(!map || !drawnItems) return;
            drawnItems.clearLayers();
            const colorModeSelect = document.getElementById('color-mode-select');
            const colorMode = colorModeSelect ? colorModeSelect.value : 'entity';
            const searchInput = document.getElementById('search-input');
            const searchTxt = searchInput ? searchInput.value.toLowerCase() : '';
            
            const selectedStatus = Array.from(document.querySelectorAll('.filter-status:checked')).map(cb => cb.value);
            const selectedLevels = Array.from(document.querySelectorAll('.filter-level:checked')).map(cb => cb.value);
            
            const toggleLabels = document.getElementById('toggle-created-labels');
            const showCreatedLabels = toggleLabels ? toggleLabels.checked : true;
            
            const toggleRoads = document.getElementById('toggle-roads');
            const showRoads = toggleRoads ? toggleRoads.checked : true;

            const sortedEntities = [...entities].sort((a, b) => getRank(b.level) - getRank(a.level));

            let allowedIds = null;
            if (searchTxt) {
                const directMatches = entities.filter(e => {
                    const nameMatch = e.name.toLowerCase().includes(searchTxt);
                    const originalMatch = e.originalName && e.originalName.toLowerCase().includes(searchTxt);
                    const annexedByMatch = e.annexedByName && e.annexedByName.toLowerCase().includes(searchTxt);
                    return nameMatch || originalMatch || annexedByMatch;
                });
                const directMatchIds = directMatches.map(e => e.id);
                const descendants = getDescendants(directMatchIds);
                allowedIds = new Set([...directMatchIds, ...descendants.map(d => d.id)]);
            }

            sortedEntities.forEach(ent => {
                if (allowedIds && !allowedIds.has(ent.id)) return;
                if (ent.type === 'area' && !selectedLevels.includes(ent.level)) return;

                let status = 'independent';
                if (ent.isAnnexed) status = 'annexed';
                else if (ent.isColony) status = 'colony';
                else if (ent.isVassal) status = 'vassal';
                
                if (!selectedStatus.includes('all') && !selectedStatus.includes(status)) return;

                try {
                    const geoJson = JSON.parse(ent.geoJson);
                    
                    if (ent.type === 'road') {
                        if(!showRoads) return;
                        L.geoJSON(geoJson, {
                            style: { color: ent.color, weight: 4, dashArray: ent.roadType === 'army' ? '10, 15' : null, opacity: 0.9 }
                        }).bindPopup(`
                            <div class="text-center">
                                <span class="bg-gray-100 text-gray-500 text-[10px] px-1 rounded font-mono">#${ent.customId || 'N/A'}</span>
                                <div class="font-bold text-[#5D4037] text-lg">${ent.name}</div>
                                <div class="text-xs text-gray-500 mb-2">${ent.roadType==='army'?'‚öîÔ∏è ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏±‡∏û':'üõí ‡∏ñ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤'}</div>
                                <button onclick="window.confirmDelete('${ent.id}')" class="text-red-500 text-xs hover:text-red-700 underline cursor-pointer">‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</button>
                            </div>
                        `).addTo(drawnItems);
                        return;
                    }
                    
                    if (ent.type === 'marker') {
                        const icon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="font-size:32px; color:${ent.color}; filter: drop-shadow(2px 2px 0 white);">${ent.icon}</div>`,
                            iconSize: [30, 30], iconAnchor: [15, 30]
                        });
                        L.geoJSON(geoJson, {
                            pointToLayer: (f, l) => L.marker(l, {icon: icon})
                        }).bindPopup(`
                            <div class="text-center font-bold text-[#5D4037]">
                                <div class="text-2xl mb-1">${ent.icon}</div>
                                <div class="mb-1">${ent.name}</div>
                                <button onclick="window.confirmDelete('${ent.id}')" class="text-red-500 text-xs hover:text-red-700 underline cursor-pointer">‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î</button>
                            </div>
                        `).addTo(drawnItems);
                        return;
                    }

                    let fillColor = ent.color;
                    if (colorMode === 'religion') fillColor = COLORS.religion[ent.religion] || '#ccc';
                    if (colorMode === 'government') fillColor = COLORS.gov[ent.government] || '#ccc';
                    if (ent.isWater) fillColor = '#85C1E9'; 
                    else if (colorMode === 'entity' && (ent.isAnnexed || ent.isVassal)) fillColor = ent.color;

                    const layer = L.geoJSON(geoJson, {
                        style: {
                            color: ent.isWater ? '#2980B9' : globalStrokeColor,
                            weight: ent.isWater ? 1 : 1.5,
                            dashArray: ent.isWater || ent.isColony ? '6, 6' : null, 
                            fillColor: fillColor,
                            fillOpacity: ent.isWater ? 0.4 : globalOpacity
                        },
                        onEachFeature: (f, l) => {
                            l.options.entityId = ent.id;
                            if (showCreatedLabels && !ent.isWater && getRank(ent.level) >= 1) {
                                let center;
                                try {
                                    const turfCenter = turf.pointOnSurface(geoJson);
                                    center = [turfCenter.geometry.coordinates[1], turfCenter.geometry.coordinates[0]];
                                } catch(e) { center = l.getBounds().getCenter(); }

                                const subLabel = ent.isColony ? `<span class="text-[8px] bg-white/90 px-1 rounded text-red-600 border border-red-200">(‡∏≠‡∏≤‡∏ì‡∏≤‡∏ô‡∏¥‡∏Ñ‡∏°‡∏Ç‡∏≠‡∏á ${ent.colonyOfName})</span>` : '';
                                const labelText = ent.isAnnexed ? ent.annexedByName : ent.name;
                                const labelMarker = L.marker(center, {
                                    icon: L.divIcon({
                                        className: 'map-label-container',
                                        html: `<div class="map-label-text" style="color:${ent.labelColor || '#4E342E'}">${labelText}</div><br>${subLabel}`,
                                        iconSize: [120, 40], iconAnchor: [60, 20]
                                    })
                                });
                                drawnItems.addLayer(labelMarker);
                            }
                            l.bindPopup(createPopupContent(ent));
                        }
                    });
                    drawnItems.addLayer(layer);

                } catch (e) { console.error("Render entity error", e); }
            });
        }

        function createPopupContent(ent) {
            const flag = ent.flag || 'https://cdn-icons-png.flaticon.com/512/1458/1458514.png';
            const ancestors = getAllAncestors(ent);
            const fullHierarchy = [...ancestors, ent];
            
            let hierarchyHtml = '';
            if (fullHierarchy.length > 0) {
                hierarchyHtml = `<div class="hierarchy-box custom-scrollbar"><div class="hierarchy-title">‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</div>`;
                fullHierarchy.forEach((item, idx) => {
                    const isActive = (idx === fullHierarchy.length - 1);
                    hierarchyHtml += `<div class="h-item ${isActive ? 'active' : ''}"><div class="h-line"></div><div class="h-dot"></div><div class="h-info"><span class="h-rank">${getHierarchyName(item.level)}</span><span class="h-name">${item.name}</span></div></div>`;
                });
                hierarchyHtml += `</div>`;
            }

            let statusBadge = '<span class="bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded-full border border-green-200">‡∏£‡∏±‡∏ê‡∏≠‡∏¥‡∏™‡∏£‡∏∞</span>';
            if (ent.isWater) statusBadge = '<span class="bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded-full border border-blue-200 font-bold">üåä ‡∏ô‡πà‡∏≤‡∏ô‡∏ô‡πâ‡∏≥</span>';

            let extraInfo = '';
            let displayName = ent.name;
            const displayId = (ent.customId || (ent.id ? ent.id.substring(0,6) : '???'));

            if (ent.isAnnexed) {
                statusBadge = '<span class="bg-orange-100 text-orange-700 text-[10px] px-2 py-0.5 rounded-full border border-orange-200">‡∏ñ‡∏π‡∏Å‡∏ú‡∏ô‡∏ß‡∏Å</span>';
                displayName = ent.annexedByName;
                extraInfo = `<div class="text-[10px] text-red-500 mt-1 flex items-center justify-center gap-1">‡πÄ‡∏î‡∏¥‡∏°: ${ent.originalName || ent.name}</div>`;
            } else if (ent.isVassal) {
                statusBadge = '<span class="bg-purple-100 text-purple-700 text-[10px] px-2 py-0.5 rounded-full border border-purple-200">‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä</span>';
                extraInfo = `<div class="text-[10px] text-purple-500 mt-1">(‡∏Ç‡∏≠‡∏á ${ent.vassalOfName})</div>`;
            } else if (ent.isColony) {
                statusBadge = '<span class="bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded-full border border-blue-200">‡∏≠‡∏≤‡∏ì‡∏≤‡∏ô‡∏¥‡∏Ñ‡∏°</span>';
                extraInfo = `<div class="text-[10px] text-blue-500 mt-1">(‡∏Ç‡∏≠‡∏á ${ent.colonyOfName})</div>`;
            }

            return `
                <div class="font-sans relative">
                    <div class="popup-header-bg"></div>
                    <img src="${flag}" class="popup-avatar">
                    <div class="pt-8 px-4 pb-4 text-center">
                        <div class="mb-1"><span class="text-[10px] font-mono text-gray-400 bg-gray-100 px-1 rounded">#${displayId}</span></div>
                        <h3 class="text-xl font-bold text-[#5D4037] leading-tight fantasy-font">${displayName}</h3>
                        ${extraInfo}
                        <div class="mt-2 mb-2">${statusBadge}</div>
                        ${hierarchyHtml}
                        <div class="grid grid-cols-2 gap-2 text-left text-xs bg-[#FFFDF5] p-2 rounded-lg border border-[#EFEBE9] mt-2">
                            <div class="col-span-2 flex justify-between border-b border-dashed border-gray-200 pb-1 mb-1">
                                <span class="text-gray-400">‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå</span>
                                <span class="font-bold text-[#5D4037]">${getHierarchyName(ent.level)}</span>
                            </div>
                            <div class="col-span-2 mb-1">
                                <span class="text-gray-400 block mb-0.5">‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</span>
                                <span class="font-bold text-[#8D6E63]">${ent.ruler}</span>
                            </div>
                            <div class="flex items-center gap-1 text-gray-600"><span class="material-icons-round text-sm text-yellow-600">self_improvement</span> ${ent.religion}</div>
                             <div class="flex items-center gap-1 text-gray-600"><span class="material-icons-round text-sm text-blue-600">gavel</span> ${ent.government}</div>
                        </div>
                        <div class="mt-3 flex gap-2 justify-center pt-2 border-t border-gray-100">
                             <button onclick="window.openEditModal('${ent.id}')" class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><span class="material-icons-round text-sm">edit</span></button>
                            <button onclick="window.confirmDelete('${ent.id}')" class="w-8 h-8 flex items-center justify-center rounded-full bg-red-50 text-red-600 hover:bg-red-100" title="‡∏•‡∏ö"><span class="material-icons-round text-sm">delete</span></button>
                            ${(!ent.isColony && !ent.isVassal && !ent.isAnnexed) ? 
                                `<button onclick="window.openWarModal('${ent.id}')" class="h-8 px-3 rounded-full bg-[#5D4037] text-white text-xs hover:bg-[#4E342E] flex items-center gap-1" title="‡∏¢‡∏∏‡∏ó‡∏ò‡∏Å‡∏≤‡∏£"><span class="material-icons-round text-sm">sports_kabaddi</span> ‡∏¢‡∏∏‡∏ó‡∏ò‡∏Å‡∏≤‡∏£</button>` : 
                                `<button onclick="window.declareIndependence('${ent.id}')" class="h-8 px-3 rounded-full bg-green-600 text-white text-xs hover:bg-green-700 flex items-center gap-1"><span class="material-icons-round text-sm">flag</span> ‡∏Å‡∏π‡πâ‡πÄ‡∏≠‡∏Å‡∏£‡∏≤‡∏ä</button>`
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Drawing Handlers ---
        window.startDrawPolygon = () => new L.Draw.Polygon(map).enable();
        window.startDrawPolyline = () => new L.Draw.Polyline(map).enable();
        window.startDrawMarker = () => new L.Draw.Marker(map).enable();
        
        window.toggleFullScreen = async () => {
            try {
                if (!document.fullscreenElement) {
                    await document.documentElement.requestFullscreen();
                } else {
                    await document.exitFullscreen();
                }
            } catch (err) {
                console.warn("Fullscreen denied:", err);
                showConfirmModal("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå", null, true);
            }
        };

        function onDrawCreated(e) {
            currentDrawLayer = e.layer;
            drawnItems.addLayer(currentDrawLayer); 
            if (e.layerType === 'polygon') {
                document.getElementById('modal-area').classList.remove('hidden');
                document.getElementById('modal-title').innerText = "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Ç‡∏ï‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á";
                document.getElementById('form-area').reset();
                document.getElementById('area-id').value = ''; 
                document.getElementById('preview-flag').classList.add('hidden');
                document.getElementById('preview-flag-placeholder').classList.remove('hidden');
                document.getElementById('inp-level').dispatchEvent(new Event('change')); 
            } else if (e.layerType === 'polyline') {
                document.getElementById('modal-road').classList.remove('hidden');
            } else if (e.layerType === 'marker') {
                document.getElementById('modal-marker').classList.remove('hidden');
            }
        }

        function onDrawEdited(e) {
            e.layers.eachLayer(async (layer) => {
                if(layer.options.entityId) await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'fantasy_empires', layer.options.entityId), { geoJson: JSON.stringify(layer.toGeoJSON()) }, { merge: true });
            });
        }

        // --- Save Functions ---
        window.saveRoad = async () => {
             const data = {
                name: document.getElementById('road-name').value || '‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏£‡πâ‡∏ä‡∏∑‡πà‡∏≠',
                customId: document.getElementById('road-custom-id').value || null,
                roadType: document.getElementById('road-type').value,
                color: document.getElementById('road-color').value,
                geoJson: JSON.stringify(currentDrawLayer.toGeoJSON()),
                type: 'road', level: 'road'
            };
            await setDoc(doc(collection(db, 'artifacts', appId, 'users', userId, 'fantasy_empires')), data);
            closeModal('modal-road'); currentDrawLayer = null;
        }

        window.saveMarker = async () => {
            const name = document.getElementById('marker-name').value || '‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç';
            const color = document.getElementById('marker-color').value;
            const data = {
                name: name,
                icon: selectedMarkerIcon,
                color: color,
                geoJson: JSON.stringify(currentDrawLayer.toGeoJSON()),
                type: 'marker', level: 'marker'
            };
            await setDoc(doc(collection(db, 'artifacts', appId, 'users', userId, 'fantasy_empires')), data);
            closeModal('modal-marker'); currentDrawLayer = null;
        }

        async function saveArea(e) {
            e.preventDefault();
            const id = document.getElementById('area-id').value;
            const data = {
                name: document.getElementById('inp-name').value,
                customId: document.getElementById('inp-custom-id').value || null,
                level: document.getElementById('inp-level').value,
                parentId: document.getElementById('inp-parent').value || null,
                ruler: document.getElementById('inp-ruler').value,
                religion: document.getElementById('inp-religion').value,
                government: document.getElementById('inp-gov').value,
                color: document.getElementById('inp-color').value,
                labelColor: document.getElementById('inp-label-color').value,
                isWater: document.querySelector('input[name="areaType"]:checked').value === 'water',
                flag: document.getElementById('preview-flag').src.includes('data:') ? document.getElementById('preview-flag').src : null,
                type: 'area'
            };
            if (!id) {
                data.geoJson = JSON.stringify(currentDrawLayer.toGeoJSON());
                data.createdAt = new Date().toISOString();
                data.originalName = data.name; data.originalRuler = data.ruler; data.originalColor = data.color;
                await setDoc(doc(collection(db, 'artifacts', appId, 'users', userId, 'fantasy_empires')), data);
            } else {
                await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'fantasy_empires', id), data, { merge: true });
            }
            closeModal('modal-area'); currentDrawLayer = null;
        }

        // --- War & Management ---
        window.openWarModal = (targetId) => {
            const target = entities.find(e => e.id === targetId);
            if (!target) return;
            document.getElementById('war-target-id').value = targetId;
            document.getElementById('war-target-name').innerText = target.name;
            const attackerSelect = document.getElementById('war-attacker-select');
            attackerSelect.innerHTML = '';
            const myEmpires = entities.filter(e => !e.isWater && !e.isAnnexed && !e.isVassal && !e.isColony && e.id !== targetId && e.type === 'area');
            if (myEmpires.length === 0) { 
                showConfirmModal("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°", null, true);
                return; 
            }
            myEmpires.forEach(e => {
                const opt = document.createElement('option'); opt.value = e.id; opt.text = `${e.name} (${getHierarchyName(e.level)})`; attackerSelect.appendChild(opt);
            });
            document.getElementById('modal-war').classList.remove('hidden');
        };

        window.confirmWarAction = async (type) => {
            const targetId = document.getElementById('war-target-id').value;
            const attackerId = document.getElementById('war-attacker-select').value;
            const target = entities.find(e => e.id === targetId);
            const attacker = entities.find(e => e.id === attackerId);
            if (!target || !attacker) return;
            const updateData = {};
            if (!target.originalColor) updateData.originalColor = target.color;
            if (!target.originalName) updateData.originalName = target.name;
            if (!target.originalRuler) updateData.originalRuler = target.ruler;

            if (type === 'annex') { updateData.color = attacker.color; updateData.ruler = attacker.ruler; updateData.isAnnexed = true; updateData.annexedByName = attacker.name; }
            else if (type === 'vassal') { updateData.color = attacker.color; updateData.isVassal = true; updateData.vassalOfName = attacker.name; }
            else if (type === 'colony') { updateData.isColony = true; updateData.colonyOfName = attacker.name; }
            await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'fantasy_empires', targetId), updateData, { merge: true });
            closeModal('modal-war');
        };

        // --- NEW: Custom Confirm Modal Logic ---
        window.showConfirmModal = (title, msg, actionFn, isAlert = false) => {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-msg').innerText = msg;
            pendingConfirmAction = actionFn;
            const confirmBtn = document.querySelector('#modal-confirm button:last-child');
            const cancelBtn = document.querySelector('#modal-confirm button:first-child');
            
            if(isAlert) {
                confirmBtn.innerText = "‡∏ï‡∏Å‡∏•‡∏á";
                cancelBtn.classList.add('hidden');
                confirmBtn.onclick = () => closeModal('modal-confirm');
            } else {
                confirmBtn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô";
                cancelBtn.classList.remove('hidden');
                confirmBtn.onclick = executePendingConfirm;
            }
            
            document.getElementById('modal-confirm').classList.remove('hidden');
        }

        window.executePendingConfirm = async () => {
            if (pendingConfirmAction) await pendingConfirmAction();
            closeModal('modal-confirm');
            pendingConfirmAction = null;
        }

        // --- Replaced Functions using Custom Confirm ---
        window.declareIndependence = async (id) => {
            showConfirmModal("‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏≠‡∏Å‡∏£‡∏≤‡∏ä", "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏≠‡∏Å‡∏£‡∏≤‡∏ä‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", async () => {
                const ent = entities.find(e => e.id === id);
                const updateData = {
                    color: ent.originalColor || ent.color, ruler: ent.originalRuler || ent.ruler,
                    isAnnexed: false, isVassal: false, isColony: false,
                    annexedByName: null, vassalOfName: null, colonyOfName: null
                };
                await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'fantasy_empires', id), updateData, { merge: true });
            });
        };

        window.confirmDelete = async (id) => {
            showConfirmModal("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö", "‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", async () => {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'fantasy_empires', id));
            });
        }

        window.openEditModal = (id) => {
            const ent = entities.find(e => e.id === id);
            if (!ent) return;
            document.getElementById('modal-area').classList.remove('hidden');
            document.getElementById('modal-title').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏Ç‡∏ï‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á";
            document.getElementById('area-id').value = ent.id;
            document.getElementById('inp-name').value = ent.name;
            document.getElementById('inp-custom-id').value = ent.customId || '';
            document.getElementById('inp-level').value = ent.level;
            updateParentSelect(getRank(ent.level));
            document.getElementById('inp-parent').value = ent.parentId || "";
            document.getElementById('inp-ruler').value = ent.ruler;
            document.getElementById('inp-religion').value = ent.religion;
            document.getElementById('inp-gov').value = ent.government;
            document.getElementById('inp-color').value = ent.color;
            document.getElementById('inp-label-color').value = ent.labelColor || '#4E342E';
            
            if (ent.flag) {
                document.getElementById('preview-flag').src = ent.flag; document.getElementById('preview-flag').classList.remove('hidden'); document.getElementById('preview-flag-placeholder').classList.add('hidden');
            } else {
                 document.getElementById('preview-flag').classList.add('hidden'); document.getElementById('preview-flag-placeholder').classList.remove('hidden');
            }
            const typeRadios = document.getElementsByName('areaType');
            for(let r of typeRadios) { r.checked = (r.value === (ent.isWater ? 'water' : 'land')); }
        }

        // Helpers
        window.cancelDraw = () => { if (currentDrawLayer && !document.getElementById('area-id').value) drawnItems.removeLayer(currentDrawLayer); closeModal('modal-area'); closeModal('modal-road'); closeModal('modal-marker'); currentDrawLayer = null; };
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        function updateParentSelect(currentRank) {
            const parentSelect = document.getElementById('inp-parent');
            if(!parentSelect) return;
            parentSelect.innerHTML = '<option value="">-- ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞ / ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î --</option>';
            entities.filter(e => getRank(e.level) > currentRank && !e.isWater).forEach(p => {
                const opt = document.createElement('option'); opt.value = p.id; opt.text = `${p.name} (${getHierarchyName(p.level)})`; parentSelect.appendChild(opt);
            });
        }
        function getRank(levelId) { return HIERARCHY.find(x => x.id === levelId)?.rank || 0; }
        function getHierarchyName(id) { return HIERARCHY.find(x => x.id === id)?.name || id; }
    </script>
</body>
</html>
