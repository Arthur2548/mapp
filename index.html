<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Map Creator: Enchanted Realm (Map Sheet Edition)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS/JS (2D Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet.Draw -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <!-- Turf.js (For Geometry Merging & Simplify) -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <!-- CesiumJS (3D Globe) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cesium/1.105.0/Cesium.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cesium/1.105.0/Widgets/widgets.css" rel="stylesheet">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@300;400;500;600;700&family=Sarabun:wght[300;400;600]&display=swap" rel="stylesheet">
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        /* Custom Theme: Cute Fantasy */
        :root {
            --paper-bg: #FFFBF0;
            --wood-dark: #6D4C41;
            --wood-light: #A1887F;
            --gold-accent: #FFB74D;
            --text-main: #4E342E;
            --cute-pink: #FFAB91;
            --cute-blue: #81D4FA;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--paper-bg);
            color: var(--text-main);
            overflow: hidden;
            margin: 0; padding: 0;
        }

        h1, h2, h3, h4, .fantasy-font, .btn-ancient, .cute-font {
            font-family: 'Mali', cursive;
        }

        /* Map Container */
        #map-container {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
            background-color: #B3E5FC;
            position: absolute;
            top: 0; left: 0;
            transition: opacity 0.5s ease;
        }

        /* Custom Cursor for Freehand Mode */
        .cursor-pen {
            cursor: url('https://api.iconify.design/mdi:fountain-pen-tip.svg?color=%235D4037&width=32&height=32') 0 32, crosshair !important;
        }
        .cursor-pen .leaflet-interactive {
            cursor: url('https://api.iconify.design/mdi:fountain-pen-tip.svg?color=%235D4037&width=32&height:32') 0 32, crosshair !important;
        }

        #cesiumContainer {
            height: 100%;
            width: 100%;
            z-index: 0;
            position: absolute;
            top: 0; left: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        /* Active/Inactive States */
        .mode-2d #map { z-index: 10; opacity: 1; pointer-events: auto; }
        .mode-2d #cesiumContainer { z-index: 0; opacity: 0; pointer-events: none; }
        
        .mode-3d #map { z-index: 0; opacity: 0; pointer-events: none; }
        .mode-3d #cesiumContainer { z-index: 10; opacity: 1; pointer-events: auto; }

        /* UI Containers */
        .sidebar-left {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 340px;
            background: rgba(255, 251, 240, 0.95);
            backdrop-filter: blur(12px);
            border-right: 2px dashed var(--wood-light);
            z-index: 1000;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 4px 0 25px rgba(93, 64, 55, 0.1);
            display: flex;
            flex-direction: column;
        }

        .sidebar-collapsed {
            transform: translateX(-340px);
        }

        .toggle-sidebar-btn {
            position: absolute;
            top: 20px;
            right: -40px;
            background: #fff;
            color: var(--wood-dark);
            width: 40px;
            height: 48px;
            border-radius: 0 16px 16px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 4px 2px 10px rgba(0,0,0,0.1);
            font-family: 'Mali', cursive;
            font-size: 1.2rem;
            transition: all 0.2s;
            border: 2px solid var(--wood-light);
            border-left: none;
        }
        .toggle-sidebar-btn:hover { background: var(--wood-dark); color: #fff; }

        /* Modern Toolbar */
        .toolbar-vertical {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
            align-items: flex-end; /* Align to right for submenu */
        }

        .tool-group {
            position: relative;
            display: flex;
            align-items: center;
            flex-direction: row;
            gap: 10px;
        }

        /* Submenu Animation */
        .tool-submenu {
            display: flex;
            gap: 8px;
            opacity: 0;
            transform: translateX(20px);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            margin-right: 4px;
        }
        .tool-submenu.active {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }

        .tool-btn {
            width: 48px;
            height: 48px;
            background: white;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(93, 64, 55, 0.15);
            color: var(--wood-dark);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 2px solid white;
            cursor: pointer;
            position: relative;
            z-index: 2;
        }
        .tool-btn:hover, .tool-btn.active {
            transform: scale(1.1) rotate(-5deg);
            color: var(--wood-light);
            border-color: var(--gold-accent);
        }
        .tool-btn span { font-size: 26px; }

        .tool-btn-sub {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: #FFF8E1;
            border: 2px solid #FFE0B2;
            color: #5D4037;
        }
        .tool-btn-sub:hover {
            background: #FFECB3;
            transform: scale(1.1);
        }

        /* Compass - Moved down to allow Draw menu to open freely */
        .compass-container {
            position: absolute;
            top: 90px; /* Moved down from 20px */
            right: 80px;
            width: 60px;
            height: 60px;
            z-index: 950;
            transition: all 0.3s;
            cursor: pointer;
        }
        .compass-container:hover { transform: scale(1.1); }
        .compass-img {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
            transition: transform 0.1s;
        }
        .hidden-compass { opacity: 0; pointer-events: none; }
        
        .compass-tooltip {
            position: absolute;
            top: 140px; /* Adjusted position */
            right: 80px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .compass-container:hover + .compass-tooltip { opacity: 1; }

        /* Globe Toggle Button (‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠) */
        .globe-toggle-btn {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 80px; /* Increased size */
            height: 80px; /* Increased size */
            border-radius: 50%;
            background: white;
            border: 4px solid var(--wood-dark);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }
        .globe-toggle-btn:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        }
        .globe-toggle-btn img {
            width: 100%; /* Ensure icon scales with button */
            height: 100%;
        }
        .globe-tooltip {
            position: absolute;
            bottom: 110px; /* Adjusted position for larger button */
            right: 30px;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--wood-dark);
            font-weight: bold;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        .globe-toggle-btn:hover + .globe-tooltip { opacity: 1; }

        .leaflet-draw { display: none !important; } 
        
        /* Modal & UI Elements */
        .modal-overlay {
            background-color: rgba(78, 52, 46, 0.4);
            backdrop-filter: blur(8px);
            transition: opacity 0.3s;
        }
        
        .modal-paper {
            background: #FFFBF0;
            border-radius: 30px;
            box-shadow: 0 25px 60px rgba(93, 64, 55, 0.25);
            border: 4px solid white;
            outline: 2px dashed #E0E0E0;
            animation: modalPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }

        .modal-paper-auth {
            background: linear-gradient(135deg, #FFFBF0 0%, #FFF3E0 100%);
            border: none;
            outline: none;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            position: relative;
        }

        @keyframes modalPop {
            0% { transform: scale(0.8) translateY(20px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        /* Animation for Bottom Bar */
        @keyframes bounceUp {
            0% { transform: translate(-50%, 100%); opacity: 0; }
            80% { transform: translate(-50%, -10%); opacity: 1; }
            100% { transform: translate(-50%, 0); opacity: 1; }
        }
        .animate-bounce-up { animation: bounceUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }

        /* Input Styling */
        .input-cute {
            background: #fff;
            border: 2px solid #EEE;
            border-radius: 16px;
            padding: 12px 16px;
            width: 100%;
            outline: none;
            transition: all 0.2s;
            font-size: 0.95rem;
            color: #5D4037;
            font-family: 'Sarabun', sans-serif;
        }
        .input-cute:focus {
            border-color: var(--cute-pink);
            box-shadow: 0 4px 12px rgba(255, 171, 145, 0.2);
            transform: translateY(-1px);
        }
        
        .input-group { position: relative; z-index: 1; }
        .input-group .icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #BCAAA4;
            transition: color 0.2s;
        }
        .input-group:focus-within .icon { color: var(--cute-pink); }
        .input-group input { padding-left: 44px; }

        /* Buttons */
        .btn-cute {
            background: linear-gradient(to right, #6D4C41, #5D4037);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            font-family: 'Mali', cursive;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 4px 10px rgba(93, 64, 55, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-cute:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(93, 64, 55, 0.3);
            filter: brightness(1.1);
        }
        .btn-cute:active { transform: translateY(1px); }

        .btn-cute-outline {
            background: white;
            color: #6D4C41;
            border: 2px solid #EEE;
        }
        .btn-cute-outline:hover {
            border-color: #6D4C41;
            background: #FFF8E1;
        }

        /* --- FANTASY POPUP STYLING --- */
        .leaflet-popup-content-wrapper {
            background: rgba(255, 253, 245, 0.95);
            border-radius: 24px;
            padding: 0;
            overflow: visible;
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.2), 0 4px 10px rgba(0,0,0,0.1);
            border: 2px solid #FFF;
        }
        .leaflet-popup-content { margin: 0 !important; width: 320px !important; }
        .leaflet-popup-tip { background: #FFF; }
        
        /* Sparkle Animation */
        @keyframes floatSparkle {
            0% { transform: translate(0, 0) scale(0); opacity: 0; }
            50% { opacity: 1; transform: translate(10px, -10px) scale(1); }
            100% { transform: translate(20px, -20px) scale(0); opacity: 0; }
        }
        .sparkle-icon {
            position: absolute;
            color: #FFB74D;
            font-size: 10px;
            animation: floatSparkle 2s infinite ease-in-out;
            pointer-events: none;
            z-index: 10;
        }
        .s1 { top: -5px; left: 10%; animation-delay: 0s; }
        .s2 { top: 10px; right: 5%; animation-delay: 0.5s; font-size: 14px; color: #FFD54F; }
        .s3 { bottom: 20%; left: -5px; animation-delay: 1s; font-size: 8px; }

        /* Icon Grid */
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 8px;
        }
        .icon-option {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #eee;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        .icon-option img { width: 24px; height: 24px; object-fit: contain; }
        .icon-option:hover { background-color: #FFF3E0; border-color: #FFCC80; }
        .icon-option.selected {
            border-color: #6D4C41;
            background-color: #FFE0B2;
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .icon-category-title {
            font-size: 11px;
            font-weight: bold;
            color: #8D6E63;
            margin-top: 8px;
            margin-bottom: 4px;
            border-bottom: 1px dashed #D7CCC8;
            padding-bottom: 2px;
        }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #D7CCC8; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #BCAAA4; }

        /* Color Swatch in Popup */
        .color-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            background: #FFF;
            border-radius: 12px;
            font-size: 11px;
            color: #616161;
            border: 1px solid #F0F0F0;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .swatch-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.1);
            display: inline-block;
        }

        /* Hierarchy Path in Popup */
        .hierarchy-path {
            font-size: 10px;
            color: #795548;
            background-color: #FFF8E1;
            padding: 4px 8px;
            border-radius: 8px;
            margin-top: 4px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
            border: 1px dashed #FFE0B2;
        }
        .h-node::after { content: "‚Ä∫"; margin-left: 4px; color: #BCAAA4; }
        .h-node:last-child::after { content: ""; }
        .h-node:last-child { font-weight: bold; color: #5D4037; }

        /* Cesium Widget Cleanups */
        .cesium-widget-credits { display: none !important; }
        .cesium-viewer-toolbar { display: none !important; }
        .cesium-viewer-animationContainer { display: none !important; }
        .cesium-viewer-timelineContainer { display: none !important; }

        /* Fix for Popups in Edit Mode (Disable pointer events on Map when in edit mode) */
        .leaflet-editing {
            cursor: default !important; /* Reset cursor when handles are active */
        }

        /* Custom style for selected path in edit mode (simulate gold dashed line) */
        /* NOTE: Leaflet Draw uses L.Path.SVG.prototype.setStyles, which overwrites these.
           The main logic must be applied via selectedPathOptions during L.Control.Draw init.
        */
        .leaflet-edit-marker-selected {
            /* This is the class for the vertices, not the path itself */
            border: 2px solid #FFD700 !important;
        }
        
        /* New Management HUD */
        #management-hud {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 900;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            padding: 10px 20px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid #EEE;
        }
        .stat-item {
            text-align: center;
            border-right: 1px solid #EEE;
            padding: 0 15px;
        }
        .stat-item:last-child { border-right: none; }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            font-family: 'Mali', cursive;
            line-height: 1;
        }
        .stat-label {
            font-size: 0.75rem;
            color: #8D6E63;
        }
        
        /* New Fantasy Dark Popup Style */
        .modal-fantasy-dark {
            background-color: rgba(18, 18, 18, 0.95);
            backdrop-filter: blur(8px);
        }
        .modal-paper-dark {
            background: linear-gradient(145deg, #2c3e50, #34495e);
            color: #ecf0f1;
            border: 4px solid #f1c40f;
            outline: 2px dashed #95a5a6;
            animation: modalPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .popup-title-dark {
             color: #ffd700;
             text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
    </style>
</head>
<body class="mode-2d">

    <!-- Management HUD (Removed Stats as requested) -->
    <div id="management-hud" class="hidden">
        <div class="flex gap-4 items-center">
            <!-- Stats removed: ‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥‡∏´‡∏•‡∏ß‡∏á, ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£, ‡∏°‡∏≤‡∏ô‡∏≤‡∏™‡∏∞‡∏™‡∏° -->
        </div>
    </div>
    
    <!-- Left Sidebar -->
    <div id="sidebar-left" class="sidebar-left p-5">
        <div class="toggle-sidebar-btn" id="toggle-sidebar">‚óÄ</div>
        
        <!-- Header -->
        <div class="text-center mb-6 pb-4 border-b-2 border-dashed border-[#E0E0E0]">
            <h1 class="text-2xl font-bold text-[#5D4037] drop-shadow-sm mb-2 flex justify-center items-center gap-2">
                <span class="text-3xl">üó∫Ô∏è</span> ‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏£‡∏£‡∏î‡∏¥‡∏ô‡∏§‡∏°‡∏¥‡∏ï‡∏£‡πå
            </h1>
            
            <!-- Auth Status -->
            <div id="auth-container">
                <div id="logged-in-view" class="hidden animate-fade-in">
                    <div class="bg-white/50 rounded-2xl p-3 border border-white shadow-sm mb-2">
                         <p id="user-display-name" class="text-sm font-bold text-[#5D4037]">Lord ...</p>
                         <p id="user-id-display" class="text-[10px] text-gray-500 font-mono">ID: ...</p>
                    </div>
                    <button onclick="window.logoutUser()" class="text-xs text-red-400 hover:text-red-600 font-bold bg-red-50 px-3 py-1 rounded-full transition">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
                <div id="logged-out-view" class="space-y-2 px-2">
                    <button onclick="document.getElementById('modal-login').classList.remove('hidden')" class="btn-cute w-full text-sm py-2"><span class="material-icons-round text-sm">login</span> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button onclick="document.getElementById('modal-register').classList.remove('hidden')" class="btn-cute btn-cute-outline w-full text-sm py-2"><span class="material-icons-round text-sm">person_add</span> ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>

        <!-- NEW: Map Sheet Management -->
        <div class="bg-white/60 p-4 rounded-2xl border border-white shadow-sm transition hover:shadow-md mb-4">
            <h3 class="font-bold text-[#5D4037] mb-3 flex items-center gap-2 text-sm">
                <span class="material-icons-round text-blue-500">article</span> ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (Map Sheet)
            </h3>
            <div class="space-y-3">
                <div class="flex gap-2">
                    <select id="map-sheet-select" class="input-cute cursor-pointer text-sm flex-1" onchange="switchMapSheet(this.value)">
                        <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>
                    </select>
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÄ‡∏•‡πá‡∏Å) -->
                    <button id="btn-delete-map" onclick="confirmDeleteMapSheet()" class="w-10 h-10 rounded-xl bg-red-100 text-red-500 flex items-center justify-center hover:bg-red-200 transition" title="‡∏•‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ" disabled>
                        <span class="material-icons-round text-xl">delete</span>
                    </button>
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° (+) -->
                    <button onclick="document.getElementById('modal-new-map').classList.remove('hidden')" class="w-10 h-10 rounded-xl bg-[#5D4037] text-white flex items-center justify-center hover:bg-[#4E342E] transition" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà">
                        <span class="material-icons-round text-xl">add</span>
                    </button>
                </div>
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß -->
            </div>
        </div>

        <!-- Tools / Filters -->
        <div class="flex-1 overflow-y-auto space-y-4 pr-1 custom-scrollbar">
            <!-- Mode Switcher (NEW: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Management HUD ‡πÅ‡∏™‡∏î‡∏á) -->
            <div class="bg-white/60 p-4 rounded-2xl border border-white shadow-sm transition hover:shadow-md">
                 <h3 class="font-bold text-[#5D4037] mb-3 flex items-center gap-2 text-sm">
                    <span class="material-icons-round text-purple-500">all_inclusive</span> ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                </h3>
                 <div class="flex gap-2">
                    <button onclick="setMode('creative')" id="btn-mode-creative" class="flex-1 text-xs py-2 rounded-xl bg-[#5D4037] text-white shadow-sm font-bold active">üé® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå</button>
                    <button onclick="setMode('management')" id="btn-mode-management" class="flex-1 text-xs py-2 rounded-xl bg-gray-100 text-gray-500 hover:bg-gray-200 transition">üëë ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</button>
                    <button class="flex-1 text-xs py-2 rounded-xl bg-gray-100 text-gray-400 cursor-not-allowed">‚öîÔ∏è ‡πÄ‡∏Å‡∏°</button>
                </div>
            </div>

            <!-- Layer Control -->
            <div class="bg-white/60 p-4 rounded-2xl border border-white shadow-sm transition hover:shadow-md">
                <h3 class="font-bold text-[#5D4037] mb-3 flex items-center gap-2 text-sm">
                    <span class="material-icons-round text-amber-500">layers</span> ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á & ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                </h3>
                <div class="flex gap-2 mb-3 bg-gray-100 p-1 rounded-xl">
                    <button id="btn-map-nolabels" class="flex-1 text-xs py-1.5 rounded-lg bg-white text-[#5D4037] shadow-sm font-bold">‡∏™‡∏∞‡∏≠‡∏≤‡∏î</button>
                    <button id="btn-map-sat" class="flex-1 text-xs py-1.5 rounded-lg text-gray-500 hover:bg-gray-200 transition">‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°</button>
                </div>
                
                <div class="space-y-2 pl-1">
                     <div class="flex items-center">
                        <input type="checkbox" id="toggle-roads" checked class="accent-[#5D4037] mr-2 h-4 w-4 rounded cursor-pointer">
                        <label for="toggle-roads" class="text-sm cursor-pointer select-none text-[#5D4037] font-medium">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á/‡∏ñ‡∏ô‡∏ô</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="toggle-created-labels" checked class="accent-[#5D4037] mr-2 h-4 w-4 rounded cursor-pointer">
                        <label for="toggle-created-labels" class="text-sm cursor-pointer select-none text-gray-600">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="toggle-compass" checked class="accent-[#5D4037] mr-2 h-4 w-4 rounded cursor-pointer">
                        <label for="toggle-compass" class="text-sm cursor-pointer select-none text-gray-600">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏¥‡∏®</label>
                    </div>
                </div>
                
                <div class="mt-4 border-t border-gray-100 pt-3">
                    <div class="flex justify-between text-xs font-bold text-gray-400 mb-1">
                        <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</span>
                        <span id="opacity-val">60%</span>
                    </div>
                    <input type="range" id="opacity-slider" min="0" max="1" step="0.05" value="0.6" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-[#5D4037]">
                </div>

                <div class="mt-3">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold text-[#5D4037]">‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</span>
                        <div class="flex items-center gap-2 bg-white px-2 py-1 rounded border border-gray-200">
                            <input type="color" id="global-stroke-color" value="#5D4037" class="w-6 h-6 border-0 p-0 rounded cursor-pointer bg-transparent">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="bg-white/60 p-4 rounded-2xl border border-white shadow-sm transition hover:shadow-md">
                <h3 class="font-bold text-[#5D4037] mb-3 flex items-center gap-2 text-sm">
                    <span class="material-icons-round text-blue-400">filter_alt</span> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ & ‡∏Å‡∏£‡∏≠‡∏á
                </h3>
                <div class="input-group mb-3">
                    <span class="material-icons-round icon">search</span>
                    <input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á, ‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå..." class="input-cute py-2 text-sm">
                </div>
                
                <div class="mb-3">
                     <div class="font-bold text-[#8D6E63] text-[11px] uppercase tracking-wider mb-2 flex justify-between items-center">
                         <span>‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</span>
                         <button onclick="toggleAllLevels(true)" class="text-[9px] text-blue-500 hover:underline">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                     </div>
                     <div id="filter-levels-container" class="grid grid-cols-1 gap-1 max-h-40 overflow-y-auto custom-scrollbar pl-1"></div>
                </div>

                <!-- Status Filter -->
                <div class="mb-1 border-t border-dashed border-gray-200 pt-2 mt-2">
                     <div class="font-bold text-[#8D6E63] text-[11px] uppercase tracking-wider mb-2 flex justify-between items-center">
                         <span>‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
                         <button onclick="toggleAllStatuses(true)" class="text-[9px] text-blue-500 hover:underline">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                     </div>
                     <div class="grid grid-cols-2 gap-1 pl-1">
                        <label class="flex items-center text-xs cursor-pointer hover:bg-white/50 p-1 rounded"><input type="checkbox" checked class="filter-status accent-[#5D4037] mr-2" value="independent"> üïäÔ∏è ‡∏£‡∏±‡∏ê‡∏≠‡∏¥‡∏™‡∏£‡∏∞</label>
                        <label class="flex items-center text-xs cursor-pointer hover:bg-white/50 p-1 rounded"><input type="checkbox" checked class="filter-status accent-[#5D4037] mr-2" value="annexed"> üè≥Ô∏è ‡∏ñ‡∏π‡∏Å‡∏ú‡∏ô‡∏ß‡∏Å</label>
                        <label class="flex items-center text-xs cursor-pointer hover:bg-white/50 p-1 rounded"><input type="checkbox" checked class="filter-status accent-[#5D4037] mr-2" value="vassal"> üõ°Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä</label>
                        <label class="flex items-center text-xs cursor-pointer hover:bg-white/50 p-1 rounded"><input type="checkbox" checked class="filter-status accent-[#5D4037] mr-2" value="colony"> ‚öì ‡∏≠‡∏≤‡∏ì‡∏≤‡∏ô‡∏¥‡∏Ñ‡∏°</label>
                     </div>
                </div>
            </div>

            <!-- Color Modes -->
            <div class="bg-white/60 p-4 rounded-2xl border border-white shadow-sm transition hover:shadow-md">
                <h3 class="font-bold text-[#5D4037] mb-2 flex items-center gap-2 text-sm">
                    <span class="material-icons-round text-pink-400">palette</span> ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏µ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                </h3>
                <select id="color-mode-select" class="input-cute text-sm cursor-pointer py-2">
                    <option value="entity">‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (Original/Local)</option>
                    <option value="political">‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á (Political State)</option> <!-- NEW MODE -->
                    <option value="religion">‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏®‡∏≤‡∏™‡∏ô‡∏≤</option>
                    <option value="government">‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏≠‡∏ö‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</option>
                    <option value="rank">‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô)</option>
                </select>
            </div>

            <!-- New Credit Section -->
            <div class="mt-6 pt-4 border-t border-dashed border-[#E0E0E0] text-center opacity-70 pb-4">
                <div class="text-[10px] text-[#8D6E63] font-mono">‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢</div>
                <div class="text-sm font-bold text-[#5D4037] mt-1">‡∏ô‡∏≤‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏´‡∏°‡∏≤‡∏¢‡∏°‡∏±‡πà‡∏ô</div>
            </div>
        </div>
    </div>

    <!-- Compass UI -->
    <div id="compass" class="compass-container" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏¥‡∏®‡πÄ‡∏´‡∏ô‡∏∑‡∏≠">
        <img src="https://api.iconify.design/noto:compass.svg" class="compass-img" id="compass-icon">
    </div>
    <div class="compass-tooltip">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠ Reset ‡∏ó‡∏¥‡∏®</div>

    <!-- Vertical Toolbar -->
    <div class="toolbar-vertical">
        <!-- New Draw Menu Group -->
        <div class="tool-group">
            <div id="draw-submenu" class="tool-submenu">
                <!-- ‡πÉ‡∏ä‡πâ checkModeAndDraw ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏°‡∏µ Map Sheet ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏∑‡πà‡∏ô -->
                <div class="tool-btn tool-btn-sub" onclick="checkModeAndDraw('polygon_freehand')" title="‡∏ß‡∏≤‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤ (‡∏≠‡∏¥‡∏™‡∏£‡∏∞)">
                    <span class="material-icons-round text-amber-800">edit</span>
                </div>
                <div class="tool-btn tool-btn-sub" onclick="checkModeAndDraw('polygon_point')" title="‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏à‡∏∏‡∏î (‡∏ó‡∏µ‡∏•‡∏∞‡∏à‡∏∏‡∏î)">
                    <span class="material-icons-round text-blue-600">timeline</span>
                </div>
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á -->
                <div id="btn-edit-geom" class="tool-btn tool-btn-sub" onclick="toggleEditGeometry()" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á (‡∏î‡∏∂‡∏á‡πÄ‡∏™‡πâ‡∏ô/‡∏Ç‡∏¢‡∏≤‡∏¢)">
                    <span class="material-icons-round text-pink-600">architecture</span>
                </div>
            </div>
            
            <div class="tool-btn" onclick="toggleDrawMenu()" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö)">
                <span class="material-icons-round text-emerald-500">terrain</span>
            </div>
        </div>

        <div class="tool-btn" onclick="checkModeAndDraw('polyline')" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á">
            <span class="material-icons-round text-amber-700">alt_route</span>
        </div>
        <div class="tool-btn" onclick="checkModeAndDraw('marker')" title="‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î">
            <span class="material-icons-round text-rose-500">place</span>
        </div>
        
        <!-- Feature ‡πÉ‡∏´‡∏°‡πà: Multi-Select / Union -->
        <div class="h-px bg-white/50 mx-2 my-1"></div>
        <div class="tool-btn" id="btn-multi-select" onclick="window.toggleMultiSelectMode()" title="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏£‡∏ß‡∏°/‡∏¢‡∏∂‡∏î)">
            <span class="material-icons-round text-purple-600">playlist_add_check</span>
        </div>
        
        <div class="h-px bg-white/50 mx-2 my-1"></div>
        <div class="tool-btn" onclick="toggleFullScreen()" title="‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠">
            <span class="material-icons-round text-gray-600">fullscreen</span>
        </div>
    </div>

    <!-- Map Area -->
    <div id="map-container">
        <div id="map"></div>
        <div id="cesiumContainer"></div>
        
        <!-- CUSTOM CESIUM POPUP -->
        <div id="cesium-popup" class="absolute hidden bg-white rounded-2xl shadow-2xl z-[2000] w-[300px] pointer-events-auto transition-opacity duration-200 border-2 border-white/50">
            <div id="cesium-popup-content"></div>
            <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-white transform rotate-45 border-b-2 border-r-2 border-gray-100"></div> 
        </div>
    </div>

    <!-- Globe Toggle -->
    <div class="globe-toggle-btn" onclick="toggleGlobeMode()">
        <img src="https://api.iconify.design/noto:globe-showing-asia-australia.svg" id="globe-btn-icon">
    </div>
    <div class="globe-tooltip">‡∏™‡∏•‡∏±‡∏ö 2D / 3D</div>

    <!-- Selection Action Bar (NEW UI) -->
    <div id="selection-bar" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white/95 backdrop-blur px-6 py-3 rounded-2xl shadow-2xl z-[2000] hidden border border-purple-100 flex items-center gap-4 animate-bounce-up">
        <div class="text-[#5D4037]">
            <span class="text-xs font-bold text-gray-400 block">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>
            <div class="flex items-baseline gap-1">
                <span class="text-xl font-bold cute-font text-purple-600" id="selection-count">0</span>
                <span class="text-xs">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</span>
            </div>
        </div>
        <div class="h-8 w-px bg-gray-200"></div>
        <button onclick="openUnionModal()" class="btn-cute bg-gradient-to-r from-purple-600 to-indigo-600 text-white text-sm py-2 px-4 shadow-lg hover:shadow-purple-200">
            <span class="material-icons-round text-base">account_balance</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô
        </button>
        <button onclick="window.toggleMultiSelectMode()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 hover:bg-red-100 hover:text-red-500 flex items-center justify-center transition">
            <span class="material-icons-round text-sm">close</span>
        </button>
    </div>

    <!-- Legend Box -->
    <div id="legend-box" class="fixed bottom-6 right-32 bg-white/90 backdrop-blur p-4 rounded-2xl shadow-xl z-[900] hidden border border-white max-w-[200px] animate-fade-up">
        <div class="flex justify-between items-center mb-2 border-b border-gray-100 pb-2">
            <h4 class="font-bold text-[#5D4037] text-xs" id="legend-title">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏µ</h4>
            <button onclick="document.getElementById('legend-box').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><span class="material-icons-round text-sm">close</span></button>
        </div>
        <div id="legend-content" class="space-y-1.5 text-[11px]"></div>
    </div>

    <!-- Modal: The Grand Proclamation (NEW) -->
    <div id="modal-proclamation" class="fixed inset-0 modal-fantasy-dark hidden z-[4000] flex items-center justify-center">
        <div class="modal-paper-dark w-full max-w-3xl p-8 relative max-h-[90vh] overflow-y-auto custom-scrollbar">
            <!-- Proclamation Header -->
            <div class="text-center mb-6 border-b-2 border-yellow-600 pb-3">
                <h1 class="text-4xl popup-title-dark font-bold cute-font mb-1">‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤</h1>
                <p class="text-yellow-300 text-sm italic">‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏ô‡∏∏‡∏†‡∏≤‡∏û‡πÅ‡∏´‡πà‡∏á‡∏õ‡∏ê‡∏û‡∏µ</p>
            </div>
            
            <div id="proclamation-content" class="text-lg leading-relaxed text-gray-200 space-y-4">
                <!-- Content will be injected here -->
            </div>
            
            <div class="text-center mt-8 pt-4 border-t border-gray-700">
                <button onclick="closeModal('modal-proclamation')" class="btn-cute bg-gradient-to-r from-yellow-600 to-amber-700 text-white px-8 py-3 shadow-xl">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≠‡∏°‡∏ô‡∏≥</button>
            </div>
        </div>
    </div>

    <!-- Modal: Player Setup (NEW) -->
    <div id="modal-player-setup" class="fixed inset-0 modal-overlay hidden z-[3000] flex items-center justify-center">
        <div class="modal-paper w-96 p-8 relative text-center">
             <div class="w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-white"><span class="material-icons-round text-3xl">account_circle</span></div>
            <h2 class="text-2xl text-[#5D4037] font-bold mb-2 cute-font">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô</h2>
            <p class="text-sm text-gray-500 mb-6">‡∏ó‡πà‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡∏ô‡∏µ‡πâ! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</p>
            <form id="form-player-setup" onsubmit="setPlayerName(event)" class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô/‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</label>
                    <input type="text" id="player-name-input" class="input-cute font-bold text-[#5D4037] text-center" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô">
                </div>
                <button type="submit" class="btn-cute w-full mt-2 bg-gradient-to-r from-amber-600 to-red-600">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</button>
            </form>
        </div>
    </div>
    
    <!-- Modal: Village Ruler Naming (NEW) -->
    <div id="modal-village-ruler" class="fixed inset-0 modal-overlay hidden z-[3000] flex items-center justify-center">
        <div class="modal-paper w-96 p-8 relative text-center">
             <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-white"><span class="material-icons-round text-3xl">village</span></div>
            <h2 class="text-2xl text-[#5D4037] font-bold mb-2 cute-font">‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô</h2>
            <p class="text-sm text-gray-500 mb-6">‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô <span id="new-player-title" class="font-bold text-emerald-600"></span> ‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á <span id="village-to-rename" class="font-bold text-[#5D4037]"></span> ‡πÅ‡∏ó‡∏ô‡∏ó‡πà‡∏≤‡∏ô</p>
            <form id="form-village-ruler" onsubmit="saveNewVillageRuler(event)" class="space-y-4">
                <input type="hidden" id="village-id-to-rename">
                <div>
                    <label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                    <input type="text" id="village-ruler-name-input" class="input-cute font-bold text-[#5D4037] text-center" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô">
                </div>
                <button type="submit" class="btn-cute w-full mt-2 bg-gradient-to-r from-emerald-600 to-teal-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </form>
        </div>
    </div>

    <!-- Modal: Sovereign Ruler Setup (NEW) -->
    <div id="modal-sovereign-ruler" class="fixed inset-0 modal-overlay hidden z-[3000] flex items-center justify-center">
        <div class="modal-paper w-[500px] p-8 relative text-center">
             <div class="w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-white"><span class="material-icons-round text-3xl">gavel</span></div>
            <h2 class="text-2xl text-[#5D4037] font-bold mb-2 cute-font">‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏∏‡∏Ç‡πÅ‡∏´‡πà‡∏á‡∏£‡∏±‡∏ê</h2>
            <p class="text-sm text-gray-500 mb-6">‡∏ó‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡πÄ‡∏õ‡πá‡∏ô <span id="sovereign-rank-display" class="font-bold text-red-600"></span> ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏ö‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏∏‡∏Ç</p>
            <form id="form-sovereign-ruler" onsubmit="saveSovereignRuler(event)" class="space-y-4 text-left">
                <input type="hidden" id="sovereign-new-id">
                <input type="hidden" id="sovereign-new-level">
                
                <div>
                    <label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏£‡∏∞‡∏ö‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</label>
                    <select id="sovereign-gov-type" class="input-cute" onchange="updateSovereignRulerTitle()">
                        <option value="‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå">‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå (Monarchy)</option>
                        <option value="‡∏õ‡∏£‡∏¥‡∏°‡∏¥‡∏ï‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå">‡∏õ‡∏£‡∏¥‡∏°‡∏¥‡∏ï‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå (Constitutional Monarchy)</option>
                        <option value="‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ò‡∏¥‡∏õ‡πÑ‡∏ï‡∏¢">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ò‡∏¥‡∏õ‡πÑ‡∏ï‡∏¢ (Republic)</option>
                        <option value="‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ß‡∏ô‡∏¥‡∏™‡∏ï‡πå">‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ß‡∏ô‡∏¥‡∏™‡∏ï‡πå (Communist State)</option>
                    </select>
                </div>

                <div>
                    <label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block" id="ruler-title-label">‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏° / ‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏∏‡∏Ç</label>
                    <input type="text" id="sovereign-ruler-name-input" class="input-cute font-bold text-[#5D4037]" required placeholder="‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏° ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ">
                    <p class="text-[10px] text-gray-400 mt-1 pl-1">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: <span id="sovereign-ruler-title-display">‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå</span></p>
                </div>
                <button type="submit" class="btn-cute w-full mt-4 bg-gradient-to-r from-red-600 to-amber-600">‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤</button>
            </form>
        </div>
    </div>

    <!-- Modal: Login -->
    <div id="modal-login" class="fixed inset-0 modal-overlay hidden z-[3000] flex items-center justify-center">
        <div class="modal-paper modal-paper-auth w-[380px] p-8">
            <button onclick="closeModal('modal-login')" class="absolute top-4 right-4 text-gray-400 hover:text-rose-500 transition z-10"><span class="material-icons-round">close</span></button>
            <div class="relative z-10 text-center">
                <div class="w-20 h-20 bg-white rounded-full mx-auto mb-4 flex items-center justify-center shadow-lg border-4 border-[#FFF3E0]">
                    <span class="material-icons-round text-4xl text-[#5D4037]">lock_open</span>
                </div>
                <h2 class="text-2xl text-[#5D4037] font-bold mb-1 cute-font">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤!</h2>
                <p class="text-gray-500 text-xs mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡πÅ‡∏´‡πà‡∏á‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                <form id="form-login" class="space-y-4">
                    <div class="input-group"><span class="material-icons-round icon">person</span><input type="text" id="login-username" class="input-cute" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ"></div>
                    <div class="input-group"><span class="material-icons-round icon">vpn_key</span><input type="password" id="login-password" class="input-cute" required placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"></div>
                    <button type="submit" class="btn-cute w-full mt-2 shadow-lg hover:shadow-xl">‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏°‡∏¥‡∏ï‡∏¥</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Register -->
    <div id="modal-register" class="fixed inset-0 modal-overlay hidden z-[3000] flex items-center justify-center">
        <div class="modal-paper modal-paper-auth w-[420px] p-8 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <button onclick="closeModal('modal-register')" class="absolute top-4 right-4 text-gray-400 hover:text-rose-500 transition z-10"><span class="material-icons-round">close</span></button>
            <div class="relative z-10">
                <h2 class="text-2xl text-[#5D4037] font-bold mb-6 text-center cute-font">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
                <form id="form-register" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏ä‡∏∑‡πà‡∏≠</label><input type="text" id="reg-firstname" class="input-cute" required></div>
                        <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="reg-lastname" class="input-cute" required></div>
                    </div>
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><div class="input-group"><span class="material-icons-round icon">email</span><input type="email" id="reg-email" class="input-cute" required placeholder="hello@example.com"></div></div>
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label><div class="input-group"><span class="material-icons-round icon">face</span><input type="text" id="reg-username" class="input-cute" required placeholder="Display Name"></div></div>
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><div class="input-group"><span class="material-icons-round icon">lock</span><input type="password" id="reg-password" class="input-cute" required placeholder="******"></div></div>
                    <button type="submit" class="btn-cute w-full mt-4 bg-gradient-to-r from-emerald-600 to-teal-600">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Create/Edit Area -->
    <div id="modal-area" class="fixed inset-0 modal-overlay hidden z-[2000] flex items-center justify-center">
        <div class="modal-paper w-full max-w-2xl p-6 relative max-h-[90vh] overflow-y-auto">
            <button onclick="cancelDraw()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition border-2 border-transparent hover:border-red-200 rounded-full w-8 h-8 flex items-center justify-center" title="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á"><span class="material-icons-round text-2xl">close</span></button>
            <h2 class="text-2xl text-[#5D4037] font-bold mb-6 flex items-center gap-2 border-b border-dashed border-[#E0E0E0] pb-3 cute-font"><span class="material-icons-round text-3xl text-amber-400">edit_location_alt</span><span id="modal-title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Ç‡∏ï‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</span></h2>
            <form id="form-area" class="space-y-5">
                <input type="hidden" id="area-id">
                <div class="flex gap-6 items-start">
                    <div class="flex-shrink-0 flex flex-col items-center w-28">
                        <div class="relative group cursor-pointer w-24 h-24 rounded-full overflow-hidden border-4 border-white shadow-md bg-gray-50" onclick="document.getElementById('inp-flag').click()">
                            <img id="preview-flag" src="" class="w-full h-full object-cover hidden transition group-hover:brightness-90">
                            <div id="preview-flag-placeholder" class="w-full h-full flex flex-col items-center justify-center text-gray-300 group-hover:bg-gray-100 transition"><span class="material-icons-round text-3xl">add_photo_alternate</span><span class="text-[10px] mt-1">‡∏£‡∏π‡∏õ‡∏ò‡∏á/‡∏ï‡∏£‡∏≤</span></div>
                        </div>
                        <input type="file" id="inp-flag" class="hidden" accept="image/*">
                    </div>
                    <div class="flex-grow space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</label><input type="text" id="inp-name" class="input-cute font-bold text-[#5D4037]" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏Ñ‡∏£‡∏î‡∏£‡∏≤‡∏Å‡πâ‡∏≠‡∏ô"></div>
                            <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏£‡∏´‡∏±‡∏™ (ID)</label><input type="text" id="inp-custom-id" class="input-cute font-mono text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ZONE-01"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå</label><select id="inp-level" class="input-cute cursor-pointer"></select></div>
                             <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡πÄ‡∏Ç‡∏ï‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÅ‡∏°‡πà</label><select id="inp-parent" class="input-cute text-sm cursor-pointer"><option value="">-- ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞ / ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î --</option></select></div>
                        </div>
                         <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</label><input type="text" id="inp-ruler" class="input-cute" required></div>
                         <p id="ruler-name-note" class="text-xs text-red-500 hidden">‚ö†Ô∏è ‡∏ó‡πà‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏£‡∏Å‡∏ô‡∏µ‡πâ ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô: <span class="font-bold" id="ruler-name-display"></span></p>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4 pt-2">
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏®‡∏≤‡∏™‡∏ô‡∏≤</label><select id="inp-religion" class="input-cute text-sm"><option>‡∏û‡∏∏‡∏ó‡∏ò</option><option>‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå</option><option>‡∏≠‡∏¥‡∏™‡∏•‡∏≤‡∏°</option><option>‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏ì‡πå‡∏Æ‡∏¥‡∏ô‡∏î‡∏π</option><option>‡∏®‡∏≤‡∏™‡∏ô‡∏≤‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°</option></select></div>
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏£‡∏∞‡∏ö‡∏≠‡∏ö‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</label><select id="inp-gov" class="input-cute text-sm"><option>‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå</option><option>‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ò‡∏¥‡∏õ‡πÑ‡∏ï‡∏¢</option><option>‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ß‡∏ô‡∏¥‡∏™‡∏ï‡πå</option><option>‡∏õ‡∏£‡∏¥‡∏°‡∏¥‡∏ï‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå</option></select></div>
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</label><div class="flex gap-2 mt-1"><label class="flex-1 flex items-center justify-center gap-1 cursor-pointer py-2 rounded-xl border border-gray-200 bg-white hover:bg-amber-50 transition"><input type="radio" name="areaType" value="land" checked class="accent-[#5D4037]"> <span class="text-xs font-bold">‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô</span></label><label class="flex-1 flex items-center justify-center gap-1 cursor-pointer py-2 rounded-xl border border-gray-200 bg-white hover:bg-blue-50 transition"><input type="radio" name="areaType" value="water" class="accent-[#2980B9]"> <span class="text-xs font-bold text-blue-600">‡∏ô‡πà‡∏≤‡∏ô‡∏ô‡πâ‡∏≥</span></label></div></div>
                </div>
                <div class="pt-4 grid grid-cols-2 gap-4 border-t border-dashed border-[#E0E0E0] mt-4">
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏Ç‡∏ï</label><div class="flex items-center gap-2 bg-white p-2 rounded-xl border border-gray-200"><input type="color" id="inp-color" class="w-10 h-8 border-0 rounded cursor-pointer bg-transparent"><span class="text-xs text-gray-500">‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡πà‡∏á‡πÅ‡∏¢‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</span></div></div>
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</label><div class="flex items-center gap-2 bg-white p-2 rounded-xl border border-gray-200"><input type="color" id="inp-label-color" class="w-10 h-8 border-0 rounded cursor-pointer bg-transparent" value="#4E342E"><span class="text-xs text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span></div></div>
                </div>
                <div class="flex justify-end items-center mt-6 gap-3">
                    <button type="button" onclick="cancelDraw()" class="px-5 py-2 text-gray-500 hover:text-gray-700 font-bold rounded-xl hover:bg-gray-100 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn-cute"><span class="material-icons-round text-sm">save</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal: Road -->
    <div id="modal-road" class="fixed inset-0 modal-overlay hidden z-[2000] flex items-center justify-center">
        <div class="modal-paper w-96 p-6 relative">
            <button onclick="cancelDraw()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition"><span class="material-icons-round">close</span></button>
            <h3 class="text-xl font-bold text-[#5D4037] mb-4 flex items-center gap-2 cute-font"><span class="material-icons-round text-amber-700">add_road</span> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</h3>
            <div class="space-y-3">
                <input type="hidden" id="road-id-hidden">
                <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</label><input type="text" id="road-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏ô‡∏ô / ‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á..." class="input-cute"></div>
                <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="road-type" class="input-cute bg-white"><option value="trade">‡∏ñ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏∂‡∏ö)</option><option value="army">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏±‡∏û (‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞)</option></select></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</label><input type="color" id="road-color" value="#5D4037" class="w-full h-10 rounded-lg cursor-pointer border-2 border-white shadow-sm"></div>
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤: <span id="road-weight-val">4</span></label><input type="range" id="road-weight" min="1" max="15" value="4" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-[#5D4037] mt-2"></div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="cancelDraw()" class="px-4 py-2 text-gray-500 text-sm font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveRoad()" class="btn-cute text-sm px-6">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Modal Marker -->
    <div id="modal-marker" class="fixed inset-0 modal-overlay hidden z-[2000] flex items-center justify-center">
        <div class="modal-paper w-[500px] p-6 relative max-h-[90vh] overflow-y-auto">
            <button onclick="cancelDraw()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition"><span class="material-icons-round">close</span></button>
            <h3 class="text-xl font-bold text-[#5D4037] mb-4 flex items-center gap-2 cute-font"><span class="material-icons-round text-rose-500">place</span> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</h3>
            <div class="space-y-4">
                <div class="input-group"><span class="material-icons-round icon">edit</span><input type="text" id="marker-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..." class="input-cute font-bold text-[#5D4037]"></div>
                
                <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <label class="text-xs font-bold text-[#8D6E63] ml-1 mb-2 block">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏î‡πà‡∏ß‡∏ô (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå)</label>
                    <div id="quick-icons-container" class="h-48 overflow-y-auto custom-scrollbar p-1 icon-grid"></div>
                </div>

                <div class="bg-white p-3 rounded-xl border border-gray-200">
                    <label class="text-[10px] font-bold text-gray-400 ml-1 mb-1 block">‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (Iconify)</label>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="icon-search-query" placeholder="‡πÄ‡∏ä‡πà‡∏ô dragon, sword, magic..." class="input-cute text-sm py-1.5 px-3">
                        <button onclick="searchIcons()" class="bg-[#5D4037] text-white rounded-xl px-3 hover:bg-[#4E342E]"><span class="material-icons-round">search</span></button>
                    </div>
                    <div id="icon-results" class="flex gap-2 overflow-x-auto pb-2 custom-scrollbar min-h-[40px]"></div>
                </div>

                <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏™‡∏µ‡∏´‡∏°‡∏∏‡∏î</label><input type="color" id="marker-color" value="#E53935" class="w-full h-8 rounded-lg cursor-pointer border-2 border-white shadow-sm"></div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="cancelDraw()" class="px-4 py-2 text-gray-500 text-sm font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveMarker()" class="btn-cute text-sm px-6">‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="modal-confirm" class="fixed inset-0 modal-overlay hidden z-[3000] flex items-center justify-center">
        <div class="modal-paper w-80 p-6 text-center transform scale-100 transition-all">
            <div class="w-12 h-12 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-3"><span class="material-icons-round text-2xl">priority_high</span></div>
            <h3 class="text-lg font-bold text-[#5D4037] mb-2 cute-font" id="confirm-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</h3>
            <p class="text-sm text-gray-600 mb-6" id="confirm-msg">...</p>
            <div class="flex gap-2 justify-center">
                <button class="px-4 py-2 rounded-xl bg-gray-100 text-gray-600 text-sm font-bold hover:bg-gray-200 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="executePendingConfirm()" class="px-4 py-2 rounded-xl bg-[#5D4037] text-white text-sm font-bold hover:bg-[#4E342E] shadow-lg transition">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>
    
    <!-- War Room Modal (Single Target) -->
    <div id="modal-war" class="fixed inset-0 modal-overlay hidden z-[2100] flex items-center justify-center">
        <div class="modal-paper w-96 p-6 relative">
            <button onclick="closeModal('modal-war')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition"><span class="material-icons-round">close</span></button>
            <h3 class="text-xl font-bold text-red-800 mb-4 flex items-center gap-2 border-b border-red-200 pb-2 cute-font"><span class="material-icons-round">sports_kabaddi</span> ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°</h3>
            <div class="space-y-4">
                <div class="bg-red-50 p-3 rounded-xl border border-red-100"><label class="text-xs font-bold text-red-700 block mb-1">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label><div id="war-target-name" class="font-bold text-gray-800 text-lg">---</div><input type="hidden" id="war-target-id"></div>
                <div class="text-center text-gray-300 font-bold text-xl my-1">VS</div>
                <div><label class="text-xs font-bold text-[#5D4037] block mb-1 ml-2">‡∏ù‡πà‡∏≤‡∏¢‡∏£‡∏∏‡∏Å (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)</label><select id="war-attacker-select" class="input-cute w-full bg-white cursor-pointer"></select></div>
            </div>
            <div id="war-actions" class="mt-6">
                <label class="text-xs font-bold text-gray-500 block mb-2 text-center">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="confirmWarAction('annex')" class="py-2 rounded-xl bg-red-500 text-white text-xs font-bold hover:bg-red-600 shadow transition flex flex-col items-center gap-1" id="war-btn-annex"><span class="material-icons-round text-base">flag</span> ‡∏ú‡∏ô‡∏ß‡∏Å</button>
                    <button onclick="confirmWarAction('vassal')" class="py-2 rounded-xl bg-purple-500 text-white text-xs font-bold hover:bg-purple-600 shadow transition flex flex-col items-center gap-1" id="war-btn-vassal"><span class="material-icons-round text-base">security</span> ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä</button>
                    <button onclick="confirmWarAction('colony')" class="py-2 rounded-xl bg-blue-500 text-white text-xs font-bold hover:bg-blue-600 shadow transition flex flex-col items-center gap-1" id="war-btn-colony"><span class="material-icons-round text-base">public</span> ‡∏≠‡∏≤‡∏ì‡∏≤‡∏ô‡∏¥‡∏Ñ‡∏°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: The Grand Unification (Merge/Annex) -->
    <div id="modal-union" class="fixed inset-0 modal-overlay hidden z-[3000] flex items-center justify-center">
        <div class="modal-paper w-[500px] p-0 overflow-hidden">
            <!-- Header Tabs -->
            <div class="flex bg-gray-50 border-b border-gray-200">
                <button onclick="switchUnionTab('merge')" id="tab-merge" class="flex-1 py-4 text-sm font-bold text-[#5D4037] border-b-2 border-[#5D4037] bg-white transition flex items-center justify-center gap-2">
                    <span class="material-icons-round text-amber-500">category</span> ‡∏´‡∏•‡∏≠‡∏°‡∏£‡∏ß‡∏°‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô (Merge)
                </button>
                <button onclick="switchUnionTab('annex')" id="tab-annex" class="flex-1 py-4 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:bg-gray-100 transition flex items-center justify-center gap-2">
                    <span class="material-icons-round text-red-500">flag</span> ‡∏ú‡∏ô‡∏ß‡∏Å/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á (Annex)
                </button>
            </div>

            <div class="p-6">
                <!-- Content: Merge -->
                <div id="content-merge" class="space-y-4">
                    <div class="bg-amber-50 p-3 rounded-xl border border-amber-100 text-xs text-amber-800">
                        <span class="font-bold">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:</span> ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏Ç‡∏ï‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô <b>1 ‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡πÉ‡∏´‡∏°‡πà</b> (Polygon ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
                    </div>
                    <form id="form-merge" onsubmit="executeMerge(event)">
                        <div class="space-y-3">
                            <div><label class="text-xs font-bold text-[#8D6E63] ml-2">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡πÉ‡∏´‡∏°‡πà</label><input type="text" id="merge-name" class="input-cute" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏´‡∏£‡∏≤‡∏ä‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£..."></div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs font-bold text-[#8D6E63] ml-2">‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</label><input type="text" id="merge-ruler" class="input-cute" required></div>
                                <div><label class="text-xs font-bold text-[#8D6E63] ml-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå</label><select id="merge-level" class="input-cute"></select></div>
                            </div>
                            <div><label class="text-xs font-bold text-[#8D6E63] ml-2">‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏Ç‡∏ï</label><input type="color" id="merge-color" class="w-full h-10 rounded-lg cursor-pointer border-2 border-white shadow-sm"></div>
                            <p id="merge-level-note" class="text-xs text-red-500 hidden">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏≠‡∏°‡∏£‡∏ß‡∏°‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≥‡∏ö‡∏• ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≥‡∏ô‡∏±‡∏ô</p>
                            <p id="merge-sub-rank-note" class="text-xs text-blue-500 hidden">üí° ‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Ç‡∏ï‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏¢‡πà‡∏≠‡∏¢‡∏Ñ‡∏á‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏≠‡∏≥‡∏ô‡∏≤‡∏à</p>
                        </div>
                        <button type="submit" class="btn-cute w-full mt-6 bg-gradient-to-r from-amber-600 to-orange-600">‚ú® ‡∏£‡πà‡∏≤‡∏¢‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏´‡∏•‡∏≠‡∏°‡∏£‡∏ß‡∏°</button>
                    </form>
                </div>

                <!-- Content: Annex -->
                <div id="content-annex" class="hidden space-y-4">
                    <div class="bg-red-50 p-3 rounded-xl border border-red-100 text-xs text-red-800">
                        <span class="font-bold">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:</span> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πà‡∏≠‡∏¢‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏°‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏Ç‡∏ï ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° <b>"‡∏ú‡∏π‡πâ‡∏ô‡∏≥"</b> ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-bold text-[#8D6E63] ml-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥ (Conqueror)</label>
                            <select id="annex-leader-select" class="input-cute w-full bg-white cursor-pointer"></select>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 pt-2">
                            <button onclick="executeAnnex('annex')" class="p-3 rounded-xl border-2 border-red-100 hover:border-red-500 bg-white hover:bg-red-50 transition text-center group">
                                <span class="material-icons-round text-2xl text-red-400 group-hover:text-red-600 block mb-1">gavel</span>
                                <div class="text-xs font-bold text-gray-600">‡∏ú‡∏ô‡∏ß‡∏Å‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô</div>
                                <div class="text-[10px] text-gray-400">(‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)</div>
                            </button>
                            <button onclick="executeAnnex('vassal')" class="p-3 rounded-xl border-2 border-purple-100 hover:border-purple-500 bg-white hover:bg-purple-50 transition text-center group">
                                <span class="material-icons-round text-2xl text-purple-400 group-hover:text-purple-600 block mb-1">security</span>
                                <div class="text-xs font-bold text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä</div>
                                <div class="text-[10px] text-gray-400">(‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô)</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="closeModal('modal-union')" class="absolute top-2 right-2 text-gray-400 hover:text-red-500"><span class="material-icons-round">close</span></button>
        </div>
    </div>
    
    <!-- Modal: New Map Sheet -->
    <div id="modal-new-map" class="fixed inset-0 modal-overlay hidden z-[3000] flex items-center justify-center">
        <div class="modal-paper w-96 p-6 relative">
            <button onclick="closeModal('modal-new-map')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition"><span class="material-icons-round">close</span></button>
            <h3 class="text-xl font-bold text-[#5D4037] mb-4 flex items-center gap-2 cute-font"><span class="material-icons-round text-blue-500">add_to_photos</span> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà</h3>
            <form id="form-new-map" onsubmit="createNewMapSheet(event)">
                <label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</label>
                <input type="text" id="new-map-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ú‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å, ‡∏¢‡∏∏‡∏Ñ‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°..." class="input-cute mb-4" required>
                <button type="submit" class="btn-cute w-full">‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
            </form>
        </div>
    </div>

    <!-- Modal: Sub-Region Management (NEW FEATURE 2) -->
    <div id="modal-sub-regions" class="fixed inset-0 modal-overlay hidden z-[2100] flex items-center justify-center">
        <div class="modal-paper w-[600px] p-6 relative">
            <button onclick="closeModal('modal-sub-regions')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition"><span class="material-icons-round">close</span></button>
            <h3 class="text-xl font-bold text-[#5D4037] mb-4 flex items-center gap-2 border-b border-dashed pb-2 cute-font">
                <span class="material-icons-round text-amber-600">account_balance_wallet</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏ï‡∏¢‡πà‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á <span id="sub-region-parent-name" class="text-amber-600"></span>
            </h3>
            <input type="hidden" id="sub-region-parent-id">
            
            <div id="sub-region-list" class="space-y-3 max-h-80 overflow-y-auto custom-scrollbar p-2 border rounded-xl bg-gray-50">
                <div class="text-center text-gray-400 p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ç‡∏ï‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</div>
            </div>

            <!-- Promotion Buttons (NEW FEATURE: Complex Promotion) -->
            <div id="promotion-section" class="mt-4 pt-4 border-t border-dashed">
                <h4 class="font-bold text-[#5D4037] text-sm mb-2 flex items-center gap-2"><span class="material-icons-round text-yellow-600">military_tech</span> ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©</h4>
                <div id="promotion-buttons" class="flex flex-wrap gap-3">
                    <!-- Buttons will be rendered here by JavaScript -->
                    <p class="text-xs text-gray-500">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡πÄ‡∏õ‡πá‡∏ô **‡πÅ‡∏Ç‡∏ß‡∏á, ‡∏≠‡∏≤‡πÄ‡∏Ç‡∏ï, ‡πÄ‡∏°‡∏∑‡∏≠‡∏á, ‡∏ô‡∏Ñ‡∏£** ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                </div>
            </div>

            <div class="mt-4 pt-4 border-t border-dashed">
                <h4 class="font-bold text-[#5D4037] text-sm mb-2 flex items-center gap-2"><span class="material-icons-round text-purple-500">fork_right</span> ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î/‡∏ú‡∏ô‡∏ß‡∏Å‡πÄ‡∏Ç‡∏ï‡∏¢‡πà‡∏≠‡∏¢</h4>
                <div class="flex gap-2">
                    <select id="transfer-child-select" class="input-cute flex-1 text-sm"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏¢‡πà‡∏≠‡∏¢ --</option></select>
                    <select id="transfer-target-select" class="input-cute flex-1 text-sm"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡πÅ‡∏°‡πà‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á --</option></select>
                    <button onclick="executeTransfer()" class="btn-cute bg-purple-600 px-4 text-sm"><span class="material-icons-round text-sm">swap_horiz</span> ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</button>
                </div>
                <p class="text-[10px] text-gray-500 mt-1 pl-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Ç‡∏ï‡∏¢‡πà‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡∏ï‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, onSnapshot, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('Debug');

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAaHROgav2BOEsqTZRNhTVdJPSKZoYoIVI",
            authDomain: "map2-d18dc.firebaseapp.com",
            projectId: "map2-d18dc",
            storageBucket: "map2-d18dc.firebasestorage.app",
            appId: "1:993020770694:web:281b572e2170f7f1209407"
        };
        const appId = firebaseConfig.projectId || "map2-d18dc";

        // Globals
        let db, auth, userId;
        let map, drawnItems; // Leaflet
        let viewer; // Cesium
        
        // ** NEW GLOBALS FOR EDIT MODE **
        let isEditMode = false;     // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°
        let editingLayer = null;    // ‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Layer ‡πÑ‡∏´‡∏ô‡∏≠‡∏¢‡∏π‡πà
        let editingLayerId = null;  // ID ‡∏Ç‡∏≠‡∏á Layer ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ highlight)
        // ********************************

        let entities = []; 
        let currentDrawLayer = null;
        let mapLayers = {};
        let globalOpacity = 0.6;
        let globalStrokeColor = '#5D4037';
        let selectedMarkerIconUrl = 'https://api.iconify.design/twemoji/round-pushpin.svg';
        let pendingConfirmAction = null; 
        let is3DMode = false;
        let selectedCesiumEntity = null;
        
        // ** FIX: Declare currentMode and initialize it **
        let currentMode = 'creative'; 

        // --- NEW GLOBALS for Freehand ---
        let isFreehand = false;
        let freehandPath = [];
        let tempLine = null;

        // --- NEW GLOBALS for Unification ---
        let isMultiSelectMode = false;
        let selectedIds = new Set();
        
        // --- NEW GLOBALS for Map Sheets ---
        let currentMapSheetId = null; // ID of the currently selected map sheet
        let mapSheets = [];           // Array of all map sheets for the current user
        let unsubscribeMapListener = null; // To manage the dynamic map data listener

        // --- NEW GLOBAL for Player Management ---
        let playerState = {
            name: '',
            title: '‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô', // Default title
            highestRank: 'muban' // Highest rank of area player is ruler of, initialized to muban
        }; 
        
        // --- UPDATED HIERARCHY FOR COMPLEX PROMOTION (Fully defined as per request) ---
        const HIERARCHY = [
             // 9-7: Kingdom Level
            { id: 'mahaAnachak', name: '‡∏°‡∏´‡∏≤‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£ (Empire)', rank: 9, defaultColor: '#884A51', rulerTitle: '‡∏û‡∏£‡∏∞‡∏à‡∏±‡∏Å‡∏£‡∏û‡∏£‡∏£‡∏î‡∏¥', warCapable: true, govType: 'sovereign' },
            { id: 'anachak', name: '‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£ (Kingdom)', rank: 8, defaultColor: '#F1C40F', rulerTitle: '‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏≤', warCapable: true, govType: 'sovereign' },
            { id: 'prathet', name: '‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®/‡∏£‡∏≤‡∏ä‡∏£‡∏±‡∏ê (State)', rank: 7, defaultColor: '#E74C3C', rulerTitle: '‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå', warCapable: true, govType: 'sovereign' },
             // 6-5: Provincial Level
            { id: 'monrath', name: '‡∏°‡∏ì‡∏£‡∏±‡∏ê (Region)', rank: 6, defaultColor: '#F39C12', rulerTitle: '‡∏£‡∏±‡∏ê‡∏≤‡∏ò‡∏¥‡∏Å‡∏£‡∏ì', warCapable: false }, // Updated title
            { id: 'monthon', name: '‡∏°‡∏ì‡∏ë‡∏• (Province)', rank: 5, defaultColor: '#E91E63', rulerTitle: '‡∏°‡∏ì‡∏ë‡∏•‡∏≤‡∏ò‡∏¥‡∏õ‡∏±‡∏ï‡∏¢‡πå', warCapable: false }, // Updated title
             // 4: City/Jangwat Level - Added 'City Proper'
            { id: 'nakorn', name: '‡∏ô‡∏Ñ‡∏£ (City)', rank: 4.5, defaultColor: '#2C3E50', rulerTitle: '‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ô‡∏Ñ‡∏£‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏•', warCapable: true, warType: 'annexOnly' }, // Updated title
            { id: 'jangwat', name: '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (Province)', rank: 4, defaultColor: '#2ECC71', rulerTitle: '‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', warCapable: false }, // Updated title
             // 3: District Level - Added 'City Proper'
            { id: 'muang', name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á (City Proper)', rank: 3.5, defaultColor: '#7D3C98', rulerTitle: '‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á', warCapable: false }, // Updated title
            { id: 'amphoe', name: '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ (District)', rank: 3, defaultColor: '#8E44AD', rulerTitle: '‡∏ô‡∏≤‡∏¢‡∏≠‡∏≥‡πÄ‡∏†‡∏≠', warCapable: false }, // Updated title
             // 2: Sub-district Level - Added 'Arch District'
            { id: 'archKhet', name: '‡∏≠‡∏≤‡πÄ‡∏Ç‡∏ï (Arch District)', rank: 2.5, defaultColor: '#16A085', rulerTitle: '‡∏Å‡∏≥‡∏ô‡∏±‡∏ô', warCapable: false }, // Updated title
            { id: 'tambon', name: '‡∏ï‡∏≥‡∏ö‡∏• (Sub-district)', rank: 2, defaultColor: '#95A5A6', rulerTitle: '‡∏Å‡∏≥‡∏ô‡∏±‡∏ô', warCapable: false }, // Updated title
             // 1: Village Level - Added 'Sub-district Zone'
            { id: 'kwaeng', name: '‡πÅ‡∏Ç‡∏ß‡∏á (Sub-district Zone)', rank: 1.5, defaultColor: '#F08080', rulerTitle: '‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô', warCapable: false }, // Updated title
            { id: 'muban', name: '‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô (Village)', rank: 1, defaultColor: '#3498DB', rulerTitle: '‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô', warCapable: false } // Updated title
        ];

        const RANK_COLORS = {};
        HIERARCHY.forEach(h => RANK_COLORS[h.id] = h.defaultColor);

        const COLORS = {
            religion: { '‡∏û‡∏∏‡∏ó‡∏ò': '#F1C40F', '‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå': '#3498DB', '‡∏≠‡∏¥‡∏™‡∏•‡∏≤‡∏°': '#2ECC71', '‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏ì‡πå‡∏Æ‡∏¥‡∏ô‡∏î‡∏π': '#E91E63', '‡∏®‡∏≤‡∏™‡∏ô‡∏≤‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°': '#95A5A6' },
            gov: { '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ò‡∏¥‡∏õ‡πÑ‡∏ï‡∏¢': '#2ECC71', '‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ß‡∏ô‡∏¥‡∏™‡∏ï‡πå': '#E74C3C', '‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå': '#8E44AD', '‡∏õ‡∏£‡∏¥‡∏°‡∏¥‡∏ï‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå': '#F39C12' },
            rank: RANK_COLORS
        };
        
        // --- Sovereign Ruler Logic ---
        function getSovereignRulerTitle(gov) {
            switch (gov) {
                case '‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå':
                case '‡∏õ‡∏£‡∏¥‡∏°‡∏¥‡∏ï‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå':
                    return { title: '‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå', formal: true, govTitle: '‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå' };
                case '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ò‡∏¥‡∏õ‡πÑ‡∏ï‡∏¢':
                    return { title: '‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ', formal: false, govTitle: '‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ' };
                case '‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ß‡∏ô‡∏¥‡∏™‡∏ï‡πå':
                    return { title: '‡∏ó‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥', formal: false, govTitle: '‡∏ó‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥' };
                default:
                    return { title: '‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î', formal: false, govTitle: '‡∏ú‡∏π‡πâ‡∏ô‡∏≥' };
            }
        }
        
        // --- Proclamation Templates (NEW) ---
        const PROCLAMATION_TEMPLATES = {
            muban: { title: "‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô", text: (player, area) => `
                <p>üèûÔ∏è <strong>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô</strong>: ‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏û‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏à ‡πÄ‡∏ä‡∏¥‡∏î‡∏ä‡∏π ${player} ‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏™‡∏•‡∏∞‡πÅ‡∏£‡∏á‡∏Å‡∏≤‡∏¢‡πÅ‡∏£‡∏á‡πÉ‡∏à‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</p>
                <p>‡∏Ç‡∏≠‡∏°‡∏≠‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‚Äú‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô‚Äù ‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏∏‡∏°‡∏ä‡∏ô${area} ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô‡∏ô‡∏≥‡∏û‡∏≤‡∏ú‡∏π‡πâ‡∏Ñ‡∏ô‡∏™‡∏π‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏á‡∏ö‡∏™‡∏∏‡∏Ç ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ß‡∏¥‡∏ñ‡∏µ‡πÅ‡∏´‡πà‡∏á‡∏ö‡∏£‡∏£‡∏û‡∏Å‡∏≤‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏≤‡∏ö‡∏ô‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏≤‡∏ô</p>
                <p class="text-right text-yellow-500 font-bold cute-font mt-4">‡∏Ç‡∏≠‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÅ‡∏´‡πà‡∏á‡πÄ‡∏ó‡∏û‡∏≤‡∏£‡∏±‡∏Å‡∏©‡πå‡πÅ‡∏•‡∏∞‡∏î‡∏ß‡∏á‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏´‡πà‡∏á‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡∏à‡∏á‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏™‡∏°‡∏≠‡πÑ‡∏õ.</p>
            `},
            kwaeng: { title: "‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô", text: (player, area) => `
                <p>üèûÔ∏è <strong>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏¢‡∏Å‡∏ê‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ç‡∏ß‡∏á</strong>: ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≠‡∏á ${player} ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏´‡πà‡∏á‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô ‡∏ö‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏¢‡∏Å‡∏ê‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡πÅ‡∏Ç‡∏ß‡∏á‚Äù ${area} ‡πÇ‡∏î‡∏¢‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô‡∏î‡∏≥‡∏£‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‚Äú‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô‚Äù</p>
                <p>‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏î‡∏π‡πÅ‡∏•‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡∏û‡∏≤‡πÅ‡∏Ç‡∏ß‡∏á‡∏ô‡∏µ‡πâ‡∏™‡∏π‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á</p>
                <p class="text-right text-yellow-500 font-bold cute-font mt-4">‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡πÅ‡∏´‡πà‡∏á‡∏†‡∏π‡∏ú‡∏≤‡∏à‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡πÅ‡∏´‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô.</p>
            `},
            tambon: { title: "‡∏Å‡∏≥‡∏ô‡∏±‡∏ô", text: (player, area) => `
                <p>üè° <strong>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏≥‡∏ô‡∏±‡∏ô</strong>: ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÉ‡∏ô‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏î‡∏µ ‡∏ö‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏¢‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≥‡∏ö‡∏• ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÉ‡∏ô‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏ß‡∏á‡∏à‡∏∂‡∏á‡∏•‡∏á‡∏°‡∏ï‡∏¥‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏£‡∏µ‡∏¢‡∏á</p>
                <p>‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á ${player} ‡∏î‡∏≥‡∏£‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‚Äú‡∏Å‡∏≥‡∏ô‡∏±‡∏ô‚Äù‡∏ï‡∏≥‡∏ö‡∏•${area} ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏´‡πà‡∏á‡∏ï‡∏≥‡∏ö‡∏• ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ ‡∏û‡πà‡∏≠‡∏Ñ‡πâ‡∏≤ ‡∏ß‡∏≤‡∏ì‡∏¥‡∏ä‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏ß‡∏á</p>
                <p class="text-right text-yellow-500 font-bold cute-font mt-4">‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏´‡πà‡∏á‡∏ß‡∏≤‡∏£‡∏µ‡πÅ‡∏•‡∏∞‡∏û‡∏™‡∏∏‡∏ò‡∏≤‡∏à‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏Ñ‡∏π‡πà‡∏ï‡∏≥‡∏ö‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô.</p>
            `},
            archKhet: { title: "‡∏Å‡∏≥‡∏ô‡∏±‡∏ô", text: (player, area) => `
                <p>üõ°Ô∏è <strong>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏¢‡∏Å‡∏ê‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≤‡πÄ‡∏Ç‡∏ï</strong>: ‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏™‡∏±‡∏¢‡∏ó‡∏±‡∏®‡∏ô‡πå‡∏Ç‡∏≠‡∏á ${player} ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ú‡∏ô‡∏ß‡∏Å‡∏£‡∏ß‡∏°‡πÄ‡∏Ç‡∏ï‡∏ï‡∏≥‡∏ö‡∏•‡∏¢‡πà‡∏≠‡∏¢‡∏à‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∂‡∏Å‡πÅ‡∏ú‡πà‡∏ô ‡∏à‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏¢‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏≠‡∏≤‡πÄ‡∏Ç‡∏ï‚Äù ${area} ‡πÇ‡∏î‡∏¢‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô‡∏î‡∏≥‡∏£‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‚Äú‡∏Å‡∏≥‡∏ô‡∏±‡∏ô‚Äù</p>
                <p>‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÑ‡∏õ‡∏ó‡∏±‡πà‡∏ß‡∏ó‡∏∏‡∏Å‡∏ó‡∏¥‡∏® ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏Ç‡πá‡∏á‡∏¢‡∏¥‡πà‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤</p>
                <p class="text-right text-yellow-500 font-bold cute-font mt-4">‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏•‡∏±‡∏á‡πÅ‡∏´‡πà‡∏á‡πÑ‡∏ü‡πÅ‡∏•‡∏∞‡πÇ‡∏•‡∏´‡∏∞‡∏à‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏π‡∏ô‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÅ‡∏´‡πà‡∏á‡∏ó‡πà‡∏≤‡∏ô.</p>
            `},
            amphoe: { title: "‡∏ô‡∏≤‡∏¢‡∏≠‡∏≥‡πÄ‡∏†‡∏≠", text: (player, area) => `
                <p>üõ°Ô∏è <strong>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏≤‡∏¢‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</strong>: ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏±‡∏Å‡∏©‡πå ${player} ‡πÑ‡∏î‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏ô‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡∏ö‡∏•‡∏£‡πà‡∏°‡πÄ‡∏¢‡πá‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏∏‡∏Ç ‡∏à‡∏∂‡∏á‡∏ó‡∏£‡∏á‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏≥‡∏£‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‚Äú‡∏ô‡∏≤‡∏¢‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‚Äù ${area}</p>
                <p>‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ô‡∏µ‡πâ‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏π‡πÅ‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∏‡∏ï‡∏¥‡∏ò‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏ï‡∏¥‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏ô‡∏≥‡∏û‡∏≤‡πÄ‡∏™‡∏°‡∏≠</p>
                <p class="text-right text-yellow-500 font-bold cute-font mt-4">‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏¢‡∏ü‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏¢‡∏∏‡∏≠‡∏±‡∏ô‡∏ó‡∏£‡∏á‡∏û‡∏•‡∏±‡∏á‡∏à‡∏á‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏™‡∏π‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à.</p>
            `},
            muang: { title: "‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á", text: (player, area) => `
                <p>üèÆ <strong>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á</strong>: ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏î‡πâ‡∏ß‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡∏≤‡∏Å‡∏≤‡∏£ ‡∏ú‡∏π‡πâ‡∏Ñ‡∏ô ‡πÅ‡∏•‡∏∞‡∏®‡∏¥‡∏•‡∏õ‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏° ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏á‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∂‡∏á‡∏Ç‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á ${player} ‡πÉ‡∏´‡πâ‡∏î‡∏≥‡∏£‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‚Äú‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á‚Äù ${area}</p>
                <p>‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡∏ú‡∏±‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏´‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏®‡∏¥‡∏•‡∏õ‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°</p>
                <p class="text-right text-yellow-500 font-bold cute-font mt-4">‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÇ‡∏ä‡∏Ñ‡∏•‡∏≤‡∏†‡∏à‡∏á‡∏´‡∏•‡∏±‡πà‡∏á‡πÑ‡∏´‡∏•‡∏™‡∏π‡πà‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏•.</p>
            `},
            jangwat: { title: "‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î", text: (player, area) => `
                <p>üè∞ <strong>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</strong>: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏ß‡∏á‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á ‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏à‡∏∂‡∏á‡∏Ç‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á ${player} ‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‚Äù ${area}</p>
                <p>‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏á‡∏≠‡∏Å‡∏á‡∏≤‡∏°‡πÉ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏∏‡∏Å‡∏ó‡∏¥‡∏®‡∏≤‡∏ô‡∏∏‡∏ó‡∏¥‡∏®</p>
                <p class="text-right text-yellow-500 font-bold cute-font mt-4">‡∏Ç‡∏≠‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÅ‡∏´‡πà‡∏á‡∏ü‡πâ‡∏≤‡∏î‡∏¥‡∏ô‡∏Ñ‡∏∏‡πâ‡∏°‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡∏Ø ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô‡∏ô‡∏≥‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏û‡∏π‡∏ô‡∏™‡∏∏‡∏Ç.</p>
            `},
            nakorn: { title: "‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ô‡∏Ñ‡∏£‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏•", text: (player, area) => `
                <p>‚õ©Ô∏è <strong>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏Ñ‡∏£‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏•</strong>: ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏ç‡πà‡πÇ‡∏ï‡∏î‡πâ‡∏ß‡∏¢‡∏®‡∏¥‡∏•‡∏õ‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏£‡∏¢‡∏ò‡∏£‡∏£‡∏° ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏ã‡∏£‡πâ ‡∏à‡∏∂‡∏á‡∏Ç‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á ${player} ‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ô‡∏Ñ‡∏£‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏•‚Äù ‡πÅ‡∏´‡πà‡∏á‡∏ô‡∏Ñ‡∏£${area}</p>
                <p>‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ô‡∏µ‡πâ‡∏ó‡πà‡∏≤‡∏ô‡∏à‡∏±‡∏Å‡∏°‡∏µ‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏î‡∏π‡πÅ‡∏•‡∏ô‡∏Ñ‡∏£‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏µ‡∏ä‡∏≤‡∏ç‡∏≤‡∏ì‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏™‡∏π‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏´‡∏ç‡πà</p>
                <p class="text-right text-yellow-500 font-bold cute-font mt-4">‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏µ‡∏ä‡∏≤‡∏ç‡∏≤‡∏ì‡πÅ‡∏•‡∏∞‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÅ‡∏´‡πà‡∏á‡πÄ‡∏ó‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏à‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏ó‡πà‡∏≤‡∏ô.</p>
            `},
            monthon: { title: "‡∏°‡∏ì‡∏ë‡∏•‡∏≤‡∏ò‡∏¥‡∏õ‡∏±‡∏ï‡∏¢‡πå", text: (player, area) => `
                <p>‚öúÔ∏è <strong>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏°‡∏ì‡∏ë‡∏•‡∏≤‡∏ò‡∏¥‡∏õ‡∏±‡∏ï‡∏¢‡πå</strong>: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏≤‡∏¢‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏ì‡∏ë‡∏• ‡∏à‡∏∂‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á ${player} ‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏°‡∏ì‡∏ë‡∏•‡∏≤‡∏ò‡∏¥‡∏õ‡∏±‡∏ï‡∏¢‡πå‚Äù ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏°‡∏ì‡∏ë‡∏•${area}</p>
                <p>‡∏Ç‡∏≠‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÅ‡∏´‡πà‡∏á‡∏ü‡πâ‡∏≤‡∏î‡∏¥‡∏ô‡∏Ñ‡∏∏‡πâ‡∏°‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡∏Ø ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô‡∏ô‡∏≥‡∏°‡∏ì‡∏ë‡∏•‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏û‡∏π‡∏ô‡∏™‡∏∏‡∏Ç</p>
                <p class="text-right text-yellow-500 font-bold cute-font mt-4">‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏•‡∏±‡∏á‡∏ò‡∏≤‡∏ï‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏µ‡πà ‡∏î‡∏¥‡∏ô ‡∏ô‡πâ‡∏≥ ‡∏•‡∏° ‡πÑ‡∏ü ‡∏à‡∏á‡πÄ‡∏Å‡∏∑‡πâ‡∏≠‡∏´‡∏ô‡∏∏‡∏ô‡∏ó‡πà‡∏≤‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á.</p>
            `},
            monrath: { title: "‡∏£‡∏±‡∏ê‡∏≤‡∏ò‡∏¥‡∏Å‡∏£‡∏ì", text: (player, area) => `
                <p>üåü <strong>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏±‡∏ê‡∏≤‡∏ò‡∏¥‡∏Å‡∏£‡∏ì</strong>: ‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÅ‡∏´‡πà‡∏á‡∏°‡∏ì‡∏ë‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á ‡∏Ç‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á ${player} ‡∏Ç‡∏∂‡πâ‡∏ô‡∏î‡∏≥‡∏£‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‚Äú‡∏£‡∏±‡∏ê‡∏≤‡∏ò‡∏¥‡∏Å‡∏£‡∏ì‚Äù ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏°‡∏ì‡∏£‡∏±‡∏ê${area}</p>
                <p>‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏ì‡∏£‡∏±‡∏ê‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ä‡∏±‡∏¢‡πÅ‡∏´‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏∂‡πà‡∏á‡∏û‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏ä‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏π‡πà‡πÄ‡∏´‡∏•‡πà‡∏≤</p>
                <p class="text-right text-yellow-500 font-bold cute-font mt-4">‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ö‡∏≤‡∏£‡∏°‡∏µ‡πÅ‡∏•‡∏∞‡∏û‡∏•‡∏±‡∏á‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÅ‡∏´‡πà‡∏á‡∏°‡∏ì‡∏£‡∏±‡∏ê‡∏ô‡∏µ‡πâ‡∏à‡∏á‡πÅ‡∏ú‡πà‡πÑ‡∏û‡∏®‡∏≤‡∏•‡πÑ‡∏õ‡∏ó‡∏±‡πà‡∏ß‡∏ó‡∏¥‡∏®.</p>
            `}
        };
        
        window.showProclamationModal = (levelId, entityName, rulerName) => {
            const template = PROCLAMATION_TEMPLATES[levelId];
            if (!template) {
                console.error("No proclamation template found for level:", levelId);
                showToast(`üéâ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${getHierarchyName(levelId)} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                return;
            }
            
            document.getElementById('proclamation-content').innerHTML = template.text(rulerName, entityName);
            document.getElementById('modal-proclamation').classList.remove('hidden');
        };

        const IMPORTANT_ICONS = {
            "‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á": ['twemoji:house', 'twemoji:castle', 'twemoji:japanese-castle', 'twemoji:classical-building', 'twemoji:derelict-house', 'twemoji:hut', 'twemoji:tent', 'twemoji:stadium', 'twemoji:factory', 'twemoji:hospital', 'twemoji:school', 'twemoji:place-of-worship', 'twemoji:shinto-shrine'],
            "‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥": ['twemoji:deciduous-tree', 'twemoji:evergreen-tree', 'twemoji:palm-tree', 'twemoji:cactus', 'twemoji:sheaf-of-rice', 'twemoji:herb', 'twemoji:mountain', 'twemoji:snow-capped-mountain', 'twemoji:volcano', 'twemoji:rock', 'twemoji:ocean', 'twemoji:water-wave'],
            "‡∏Å‡∏≤‡∏£‡∏ó‡∏´‡∏≤‡∏£ & ‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á": ['twemoji:crossed-swords', 'twemoji:shield', 'twemoji:bow-and-arrow', 'twemoji:dagger', 'twemoji:crown', 'twemoji:skull-and-crossbones', 'twemoji:flag-in-hole', 'twemoji:chequered-flag', 'twemoji:triangular-flag', 'twemoji:fleur-de-lis'],
            "‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£ & ‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥": ['twemoji:gem-stone', 'twemoji:coin', 'twemoji:money-bag', 'twemoji:pick', 'twemoji:hammer-and-pick', 'twemoji:wood', 'twemoji:oil-drum', 'twemoji:fishing-pole', 'twemoji:anchor', 'twemoji:compass'],
            "‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå & ‡πÅ‡∏ü‡∏ô‡∏ï‡∏≤‡∏ã‡∏µ": ['twemoji:crystal-ball', 'twemoji:magic-wand', 'twemoji:sparkles', 'twemoji:star', 'twemoji:crescent-moon', 'twemoji:scroll', 'twemoji:book', 'twemoji:candle', 'twemoji:amphora', 'twemoji:coffin']
        };
        
        // Helper function to get the base collection reference for map sheets
        function getMapSheetCollectionRef() {
            if (!window.userId) return null;
            return collection(db, 'artifacts', appId, 'users', window.userId, 'map_sheets');
        }

        // Helper function to get the data collection reference for the current map sheet
        function getEntityCollectionRef() {
            if (!window.userId || !currentMapSheetId) return null;
            return collection(db, 'artifacts', appId, 'users', window.userId, 'map_sheets', currentMapSheetId, 'fantasy_empires');
        }

        // Helper function to get the player state document reference
        function getPlayerStateDocRef() {
             if (!window.userId) return null;
             return doc(db, 'artifacts', appId, 'users', window.userId, 'player_state', 'data');
        }


        // --- Initialization ---
        window.onload = async () => {
            initMap();
            setupUI();
            
            if (location.hostname !== 'localhost' && !firebaseConfig.apiKey) {
                 showConfirmModal("‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î", null, true);
                 return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    toggleAuthUI(user);
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('user-display-name').innerText = `Lord ${user.displayName || user.email}`;
                        document.getElementById('user-id-display').innerText = `ID: ${window.userId.substring(0,6)}`;
                        
                        // Load player state first
                        await loadPlayerState();

                        // Start listening for map sheets when user logs in
                        subscribeToMapSheets(); 

                    } else {
                        // Clear map when user logs out
                        mapSheets = [];
                        currentMapSheetId = null;
                        renderMapSheetSelect();
                        if (unsubscribeMapListener) unsubscribeMapListener();
                        drawnItems.clearLayers();
                        entities = [];
                        playerState = { name: '', title: '‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô', highestRank: 'muban' }; // Reset state
                    }
                });
            } catch (err) { console.error("Firebase connection failed:", err); }
        };

        // --- Player State Management (NEW) ---
        async function loadPlayerState() {
             if (!window.userId) return;
             try {
                 const docRef = getPlayerStateDocRef();
                 const docSnap = await getDoc(docRef);
                 if (docSnap.exists()) {
                     playerState = { ...playerState, ...docSnap.data() };
                     console.log("Player State Loaded:", playerState);
                 }
             } catch (err) { console.error("Error loading player state:", err); }
        }
        
        async function savePlayerState(merge = true) {
            if (!window.userId) return;
            try {
                const docRef = getPlayerStateDocRef();
                await setDoc(docRef, playerState, { merge: merge });
            } catch (err) { console.error("Error saving player state:", err); }
        }

        function toggleAuthUI(user) {
            const loggedInView = document.getElementById('logged-in-view');
            const loggedOutView = document.getElementById('logged-out-view');
            const sheetSelect = document.getElementById('map-sheet-select');
            if(user) {
                loggedInView.classList.remove('hidden');
                loggedOutView.classList.add('hidden');
                sheetSelect.disabled = false;
            } else {
                loggedInView.classList.add('hidden');
                loggedOutView.classList.remove('hidden');
                sheetSelect.disabled = true;
            }
        }

        // --- Map Sheet Management ---

        function subscribeToMapSheets() {
            const sheetsRef = getMapSheetCollectionRef();
            if(!sheetsRef) return;

            onSnapshot(sheetsRef, (snap) => {
                mapSheets = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a, b) => a.name.localeCompare(b.name));
                
                let shouldSwitch = false;
                
                if (mapSheets.length > 0) {
                    const currentSheetExists = mapSheets.find(s => s.id === currentMapSheetId);
                    if (!currentMapSheetId || !currentSheetExists) {
                        // Automatically select the first map sheet if none is active or the current one was deleted
                        currentMapSheetId = mapSheets[0].id;
                        shouldSwitch = true;
                    }
                    document.getElementById('btn-delete-map').disabled = false;
                } else {
                    // Create a default sheet if none exist (Only if the user is logged in)
                    if (window.userId) {
                        createNewMapSheet(null, "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô");
                    }
                    document.getElementById('btn-delete-map').disabled = true;
                    currentMapSheetId = null; 
                }
                
                renderMapSheetSelect();
                if (shouldSwitch || (mapSheets.length > 0 && !unsubscribeMapListener)) {
                    switchMapSheet(currentMapSheetId);
                }
            });
        }
        
        function renderMapSheetSelect() {
            const select = document.getElementById('map-sheet-select');
            select.innerHTML = '';
            
            if (mapSheets.length === 0) {
                 select.innerHTML = '<option value="">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà</option>';
                 return;
            }

            mapSheets.forEach(sheet => {
                const opt = document.createElement('option');
                opt.value = sheet.id;
                opt.innerText = sheet.name;
                if (sheet.id === currentMapSheetId) opt.selected = true;
                select.appendChild(opt);
            });
        }

        window.switchMapSheet = (newId) => {
            if (!newId) return;
            if (newId === currentMapSheetId) return;
            
            currentMapSheetId = newId;
            // Clear map visuals immediately
            drawnItems.clearLayers();
            entities = [];
            
            // Re-subscribe to the new map's data
            subscribeToMapData();
            showToast(`‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: ${mapSheets.find(s => s.id === newId)?.name}`);
        };

        function subscribeToMapData() {
            // Unsubscribe from old listener if exists
            if (unsubscribeMapListener) unsubscribeMapListener();
            
            const areasRef = getEntityCollectionRef();
            if (!areasRef) {
                // If no currentMapSheetId (e.g., waiting for first sheet creation), do nothing
                return; 
            }
            
            // Set up new listener
            unsubscribeMapListener = onSnapshot(areasRef, (snap) => {
                entities = snap.docs.map(d => ({id: d.id, ...d.data()}));
                
                // NEW: Update player's highest rank based on created areas (for management mode)
                updatePlayerHighestRank(); 

                renderMap(); // 2D
                if(is3DMode) renderCesium(); // 3D
                // Removed calculateAggregateStats as requested
            }, (error) => {
                console.error("Error subscribing to map data:", error);
                entities = [];
                renderMap();
            });
        }

        // NEW: Function to check and update player's highest owned rank
        function updatePlayerHighestRank() {
             if (currentMode !== 'management' || !playerState.name) return;

             const ownedAreas = entities.filter(e => e.type === 'area' && !e.isWater && e.ruler === playerState.name);
             if (ownedAreas.length === 0) return; // No owned areas yet

             let maxRank = 0;
             let highestRankId = 'muban';
             let highestRankTitle = '‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô';

             ownedAreas.forEach(area => {
                 const rank = getRank(area.level);
                 if (rank > maxRank) {
                     maxRank = rank;
                     highestRankId = area.level;
                     highestRankTitle = HIERARCHY.find(h => h.id === highestRankId)?.rulerTitle || '‡∏ú‡∏π‡πâ‡∏ô‡∏≥';
                 }
             });
             
             // Check for promotion only if the current title is lower
             if (maxRank > getRank(playerState.highestRank)) {
                 playerState.highestRank = highestRankId;
                 playerState.title = highestRankTitle;
                 savePlayerState(); // Save the new state
                 // Note: Proclamation is now triggered in executeMerge/executeSpecialPromotion
             }
        }


        window.createNewMapSheet = async (e, defaultName = null) => {
            if (e) e.preventDefault();
            if(!window.userId) { showConfirmModal("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà", null, true); return; }

            const nameInput = document.getElementById('new-map-name');
            const newName = defaultName || nameInput.value;
            
            if (!newName) return;
            
            closeModal('modal-new-map');
            if (e) nameInput.value = ''; // Only clear if not default creation
            
            try {
                const sheetsRef = getMapSheetCollectionRef();
                await addDoc(sheetsRef, { 
                    name: newName, 
                    createdAt: new Date().toISOString()
                });
                showToast(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà: ${newName} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            } catch (err) {
                showConfirmModal("‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", err.message, null, true);
            }
        };
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renameMapModal ‡πÅ‡∏•‡∏∞ renameMapSheet ‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å

        window.confirmDeleteMapSheet = () => {
             if (mapSheets.length <= 1) {
                  showConfirmModal("‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÅ‡∏ú‡πà‡∏ô", null, true);
                  return;
             }
             const currentSheet = mapSheets.find(s => s.id === currentMapSheetId);
             if (!currentSheet) return;
             
             showConfirmModal(`‡∏•‡∏ö '${currentSheet.name}'`, "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", 
                 () => deleteMapSheet(currentSheet.id)
             );
        }

        async function deleteMapSheet(sheetId) {
             if(!window.userId) return;
             
             try {
                // 1. Delete all entities in the sheet's subcollection
                const entityDocs = await getDocs(collection(db, 'artifacts', appId, 'users', window.userId, 'map_sheets', sheetId, 'fantasy_empires'));
                const batch = writeBatch(db);
                entityDocs.forEach((d) => batch.delete(d.ref));
                await batch.commit();

                // 2. Delete the map sheet document itself
                await deleteDoc(doc(getMapSheetCollectionRef(), sheetId));
                
                showToast("‡∏•‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                
                // onSnapshot will handle switching to the next available sheet
             } catch (err) {
                 showConfirmModal("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ${err.message}`, null, true);
             }
        }

        // --- Management HUD Logic (Simplified as stats are removed) ---
        // Removed calculateAggregateStats as it is no longer needed.

        // --- Map Setup (2D) ---
        function initMap() {
            if (map) return;
            
            const noLabelsLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            });
            const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });

            const corner1 = L.latLng(-85, -180);
            const corner2 = L.latLng(85, 180);
            const bounds = L.latLngBounds(corner1, corner2);

            map = L.map('map', { 
                center: [13.7563, 100.5018], 
                zoom: 6, 
                zoomControl: false, 
                layers: [noLabelsLayer],
                maxBounds: bounds,
                maxBoundsViscosity: 1.0,
                minZoom: 3
            });

            mapLayers = { nolabels: noLabelsLayer, sat: satLayer };
            drawnItems = L.featureGroup().addTo(map);

            map.addControl(new L.Control.Draw({
                edit: { featureGroup: drawnItems },
                draw: { polygon: true, polyline: true, marker: true, rectangle: false, circle: false, circlemarker: false }
            }));

            map.on(L.Draw.Event.CREATED, onDrawCreated);
            map.on(L.Draw.Event.EDITED, onDrawEdited);
            
           // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Leaflet Draw ‡∏ú‡∏™‡∏°‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥ .editing ‡πÉ‡∏´‡πâ Layer ‡πÉ‡∏ô drawnItems
           // ** ‡∏õ‡∏£‡∏±‡∏ö style ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ **
           new L.EditToolbar.Edit(map, {
                featureGroup: drawnItems,
                selectedPathOptions: {
                    dashArray: '10, 10', // ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö
                    fill: true,
                    fillColor: '#FFD700', // ‡∏™‡∏µ‡∏ó‡∏≠‡∏á
                    fillOpacity: 0.1, // ‡πÉ‡∏™‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
                    color: '#FFD700', // ‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏≠‡∏á
                    weight: 3, // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤
                    maintainColor: false
                }
            });

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î ESC ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠ Layer ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ editingLayer ‡∏ñ‡∏π‡∏Å reset)
            map.on('editable:disable', (e) => {
                 if (e.layer === editingLayer) {
                    editingLayer = null;
                    editingLayerId = null;
                    renderMap(); // Force re-render to remove highlight
                 }
            });
        }

        // --- Cesium Setup (3D) ---
        function initCesium() {
            if(viewer) return;

            viewer = new Cesium.Viewer('cesiumContainer', {
                animation: false,
                baseLayerPicker: false,
                fullscreenButton: false,
                vrButton: false,
                geocoder: false,
                homeButton: false,
                infoBox: false,
                sceneModePicker: false,
                selectionIndicator: true,
                timeline: false,
                navigationHelpButton: false,
                imageryProvider: new Cesium.ArcGisMapServerImageryProvider({
                    url : 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer'
                })
            });

            viewer.scene.globe.enableLighting = true;
            viewer.scene.screenSpaceCameraController.enableCollisionDetection = false;
            
            const popupDiv = document.getElementById('cesium-popup');
            const popupContent = document.getElementById('cesium-popup-content');
            
            viewer.screenSpaceEventHandler.setInputAction((click) => {
                const pickedObject = viewer.scene.pick(click.position);
                if (Cesium.defined(pickedObject) && pickedObject.id && pickedObject.id.entityDataId) {
                    selectedCesiumEntity = pickedObject.id;
                    const ent = entities.find(e => e.id === selectedCesiumEntity.entityDataId);
                    
                    if (ent) {
                        const visuals = getEntityVisuals(ent);
                        popupContent.innerHTML = createPopupContent(ent, visuals.fillColor, visuals.colorContext);
                        popupDiv.classList.remove('hidden');
                    }
                } else {
                    selectedCesiumEntity = null;
                    popupDiv.classList.add('hidden');
                }
            }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

            viewer.scene.postRender.addEventListener(() => {
                if (selectedCesiumEntity && !popupDiv.classList.contains('hidden')) {
                    let position;
                    if(selectedCesiumEntity.position) {
                        position = selectedCesiumEntity.position.getValue(viewer.clock.currentTime);
                    } else if(selectedCesiumEntity.centerPosition) {
                        position = selectedCesiumEntity.centerPosition;
                    }

                    if (position) {
                        const canvasPosition = Cesium.SceneTransforms.wgs84ToWindowCoordinates(viewer.scene, position);
                        if (canvasPosition) {
                            popupDiv.style.top = (canvasPosition.y - popupDiv.offsetHeight - 20) + 'px';
                            popupDiv.style.left = (canvasPosition.x - popupDiv.offsetWidth / 2) + 'px';
                        }
                    }
                }
            });

            syncCameraTo2D();
        }

        function syncCameraTo2D() {
            if(!map || !viewer) return;
            const center = map.getCenter();
            viewer.camera.flyTo({
                destination : Cesium.Cartesian3.fromDegrees(center.lng, center.lat, 5000000),
                duration: 1.5
            });
        }

        window.toggleGlobeMode = () => {
            is3DMode = !is3DMode;
            const body = document.body;
            const btnIcon = document.getElementById('globe-btn-icon');
            
            if(is3DMode) {
                body.classList.remove('mode-2d'); body.classList.add('mode-3d');
                btnIcon.src = "https://api.iconify.design/noto:map-of-japan.svg";
                if(!viewer) initCesium();
                renderCesium();
                viewer.scene.postRender.addEventListener(updateCompass3D);
            } else {
                body.classList.remove('mode-3d'); body.classList.add('mode-2d');
                btnIcon.src = "https://api.iconify.design/noto:globe-showing-asia-australia.svg";
                if(viewer) viewer.scene.postRender.removeEventListener(updateCompass3D);
                document.getElementById('compass-icon').style.transform = 'rotate(0deg)';
            }
        }

        function updateCompass3D() {
            if(!viewer) return;
            const heading = viewer.camera.heading;
            const deg = Cesium.Math.toDegrees(heading);
            document.getElementById('compass-icon').style.transform = `rotate(${-deg}deg)`;
        }

        // --- UI Setup ---
        function setupUI() {
            const toggleBtn = document.getElementById('toggle-sidebar');
            if(toggleBtn) toggleBtn.onclick = () => {
                const sb = document.getElementById('sidebar-left');
                sb.classList.toggle('sidebar-collapsed');
                toggleBtn.innerText = sb.classList.contains('sidebar-collapsed') ? '‚ñ∂' : '‚óÄ';
            };

            document.getElementById('btn-map-nolabels').onclick = (e) => { 
                map.removeLayer(mapLayers.sat); map.addLayer(mapLayers.nolabels);
                updateLayerBtnStyle(e.target, document.getElementById('btn-map-sat'));
            };
            document.getElementById('btn-map-sat').onclick = (e) => { 
                map.removeLayer(mapLayers.nolabels); map.addLayer(mapLayers.sat); 
                updateLayerBtnStyle(e.target, document.getElementById('btn-map-nolabels'));
            };

            function updateLayerBtnStyle(active, inactive) {
                active.className = "flex-1 text-xs py-1.5 rounded-lg bg-white text-[#5D4037] shadow-sm font-bold";
                inactive.className = "flex-1 text-xs py-1.5 rounded-lg text-gray-500 hover:bg-gray-200 transition";
            }

            document.getElementById('toggle-created-labels')?.addEventListener('change', renderMap);
            document.getElementById('toggle-roads')?.addEventListener('change', () => { renderMap(); if(is3DMode) renderCesium(); });
            document.getElementById('toggle-compass')?.addEventListener('change', (e) => {
                const compass = document.getElementById('compass');
                if(e.target.checked) compass.classList.remove('hidden-compass');
                else compass.classList.add('hidden-compass');
            });
            
            document.getElementById('compass').onclick = () => {
                if(is3DMode && viewer) {
                    const center = viewer.camera.positionCartographic;
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromRadians(center.longitude, center.latitude, center.height),
                        orientation: { heading: 0, pitch: -Cesium.Math.PI_OVER_TWO, roll: 0 },
                        duration: 1.0
                    });
                }
            };

            document.getElementById('opacity-slider')?.addEventListener('input', (e) => {
                globalOpacity = parseFloat(e.target.value);
                document.getElementById('opacity-val').innerText = Math.round(globalOpacity*100) + '%';
                renderMap();
                if(is3DMode) renderCesium();
            });
            
            document.getElementById('global-stroke-color')?.addEventListener('input', (e) => {
                globalStrokeColor = e.target.value;
                renderMap(); if(is3DMode) renderCesium();
            });

            document.getElementById('color-mode-select')?.addEventListener('change', (e) => {
                const mode = e.target.value;
                const legendBox = document.getElementById('legend-box');
                if (mode === 'religion' || mode === 'government' || mode === 'rank' || mode === 'political') {
                    legendBox.classList.remove('hidden'); updateLegend(mode);
                } else {
                    legendBox.classList.add('hidden');
                }
                renderMap();
                if(is3DMode) renderCesium();
            });

            // Hierarchy Filter Logic
            const filterContainer = document.getElementById('filter-levels-container');
            if(filterContainer && HIERARCHY) {
                filterContainer.innerHTML = '';
                HIERARCHY.forEach(h => {
                    const div = document.createElement('div');
                    // Checkbox for special ranks should be distinct
                    const isSpecial = h.id === 'nakorn' || h.id === 'muang' || h.id === 'archKhet' || h.id === 'kwaeng';
                    div.innerHTML = `<label class="flex items-center text-xs cursor-pointer hover:bg-white/50 p-1 rounded"><input type="checkbox" checked class="filter-level accent-[#5D4037] mr-2" value="${h.id}"> ${isSpecial ? '‚≠ê' : ''} ${h.name}</label>`;
                    filterContainer.appendChild(div);
                });
                document.querySelectorAll('.filter-level').forEach(el => el.addEventListener('change', () => { renderMap(); if(is3DMode) renderCesium(); }));
            }

            // Status Filter Listener
            document.querySelectorAll('.filter-status').forEach(el => el.addEventListener('change', () => { renderMap(); if(is3DMode) renderCesium(); }));


            const formArea = document.getElementById('form-area');
            if(formArea) formArea.onsubmit = saveArea;

            document.getElementById('road-weight')?.addEventListener('input', (e) => {
                document.getElementById('road-weight-val').innerText = e.target.value;
            });

            const levelSelect = document.getElementById('inp-level');
            if(levelSelect) {
                levelSelect.innerHTML = ''; // Clear default options
                HIERARCHY.forEach(h => {
                    const opt = document.createElement('option'); opt.value = h.id; opt.text = h.name; levelSelect.appendChild(opt);
                });
                levelSelect.onchange = (e) => {
                    const lvl = HIERARCHY.find(h => h.id === e.target.value);
                    if(lvl) document.getElementById('inp-color').value = lvl.defaultColor;
                    updateParentSelect(lvl ? lvl.rank : 0);
                };
            }

            renderImportantIcons(); 
            document.getElementById('search-input')?.addEventListener('keyup', () => { renderMap(); if(is3DMode) renderCesium(); });
        }

        window.setMode = (mode) => {
            document.getElementById('btn-mode-creative').classList.remove('active', 'bg-[#5D4037]', 'text-white');
            document.getElementById('btn-mode-creative').classList.add('bg-gray-100', 'text-gray-500');
            document.getElementById('btn-mode-management').classList.remove('active', 'bg-[#5D4037]', 'text-white');
            document.getElementById('btn-mode-management').classList.add('bg-gray-100', 'text-gray-500');
            document.getElementById('management-hud').classList.add('hidden'); // Ensure HUD is hidden

            if (mode === 'creative') {
                document.getElementById('btn-mode-creative').classList.add('active', 'bg-[#5D4037]', 'text-white');
                document.getElementById('btn-mode-creative').classList.remove('bg-gray-100', 'text-gray-500');
            } else if (mode === 'management') {
                // NEW MANAGEMENT MODE LOGIC
                document.getElementById('btn-mode-management').classList.add('active', 'bg-[#5D4037]', 'text-white');
                document.getElementById('btn-mode-management').classList.remove('bg-gray-100', 'text-gray-500');
                
                if (!playerState.name) {
                    // Open setup modal if name is not set
                    document.getElementById('modal-player-setup').classList.remove('hidden');
                }
            }
            currentMode = mode;
        }
        
        // NEW: Function to handle player name setup
        window.setPlayerName = (e) => {
            e.preventDefault();
            const name = document.getElementById('player-name-input').value.trim();
            if (!name) return;

            playerState.name = name;
            playerState.title = '‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô'; // Reset title if needed, or ensure it's set
            playerState.highestRank = 'muban';
            savePlayerState();

            closeModal('modal-player-setup');
            
            // Show welcome popup with player's name
            const welcomeMsg = `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏õ‡∏ê‡∏°‡∏ö‡∏ó‡πÅ‡∏´‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á ‡∏ó‡πà‡∏≤‡∏ô${playerState.title} ${playerState.name} "‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏π‡πà‡∏°‡∏´‡∏≤‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£ ‡∏°‡∏¥‡∏≠‡∏≤‡∏à‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÅ‡∏•‡∏∞‡∏°‡∏¥‡∏≠‡∏≤‡∏à‡∏•‡∏±‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ‡∏ó‡πà‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà ‡∏à‡∏á‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á '‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô' ‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡∏£‡∏ß‡∏°‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≥‡∏ö‡∏• ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡∏à‡∏∞‡πÉ‡∏ù‡πà‡∏ù‡∏±‡∏ô‡∏ñ‡∏∂‡∏á‡∏™‡∏¥‡πà‡∏á‡πÉ‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÉ‡∏à‡∏õ‡∏≠‡∏á"`;
            showConfirmModal("‡∏õ‡∏ê‡∏°‡∏ö‡∏ó‡πÅ‡∏´‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á", welcomeMsg, null, true);
        }
        
        // NEW: Function to save the new ruler name for a village after promotion
        window.saveNewVillageRuler = async (e) => {
            e.preventDefault();
            if(!validateAuth()) return;
            const villageId = document.getElementById('village-id-to-rename').value;
            const newRulerName = document.getElementById('village-ruler-name-input').value.trim();
            
            if (!villageId || !newRulerName) return;
            
            try {
                // Update the single village's ruler name
                const docRef = doc(getEntityCollectionRef(), villageId);
                await setDoc(docRef, { ruler: newRulerName, originalRuler: newRulerName }, { merge: true });
                showToast(`‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô ${newRulerName} ‡πÅ‡∏´‡πà‡∏á‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô ${document.getElementById('village-to-rename').innerText} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            } catch (error) {
                 console.error("Error setting new village ruler:", error);
                 showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô");
            }
            closeModal('modal-village-ruler');
        }
        
        window.updateSovereignRulerTitle = () => {
            const gov = document.getElementById('sovereign-gov-type').value;
            const { title, formal } = getSovereignRulerTitle(gov);
            
            document.getElementById('sovereign-ruler-title-display').innerText = title;
            document.getElementById('ruler-title-label').innerText = formal ? "‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏° / ‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏∏‡∏Ç (‡∏£‡∏≤‡∏ä‡∏≤‡∏®‡∏±‡∏û‡∏ó‡πå)" : "‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏∏‡∏Ç";
        }

        window.saveSovereignRuler = async (e) => {
            e.preventDefault();
            if(!validateAuth()) return;
            
            const newId = document.getElementById('sovereign-new-id').value;
            const newLevel = document.getElementById('sovereign-new-level').value;
            const rulerName = document.getElementById('sovereign-ruler-name-input').value.trim();
            const govType = document.getElementById('sovereign-gov-type').value;
            
            const ent = entities.find(e => e.id === newId);
            if (!ent) { showToast("Error: Entity not found."); return; }

            const { title, formal, govTitle } = getSovereignRulerTitle(govType);

            try {
                // 1. Update the newly merged entity with final ruler data
                await setDoc(doc(getEntityCollectionRef(), newId), {
                    ruler: rulerName, 
                    government: govType,
                    originalRuler: rulerName
                }, { merge: true });

                // 2. Update player state (If the player is establishing their highest rank sovereign state)
                playerState.highestRank = newLevel;
                playerState.title = govTitle; // Use the government title for the player's status
                await savePlayerState();
                
                // 3. Construct and display the welcome popup
                let welcomeMsg = "";
                let popupTitle = "";
                let countryName = ent.name || "‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå";
                let rankName = getHierarchyName(newLevel);
                
                // Set the modal style to dark/fantasy for the welcome message
                document.getElementById('modal-confirm').querySelector('.modal-paper').classList.add('modal-paper-dark');
                document.getElementById('modal-confirm').querySelector('.modal-overlay').classList.add('modal-fantasy-dark');

                if (formal) {
                    popupTitle = "üëë ‡∏Ç‡∏≠‡∏ñ‡∏ß‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏û‡∏£‡∏ä‡∏±‡∏¢‡∏°‡∏á‡∏Ñ‡∏•";
                    welcomeMsg = `‡∏Ç‡∏≠‡∏ñ‡∏ß‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏û‡∏£ ${rulerName} ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô‡∏ß‡πÇ‡∏£‡∏Å‡∏≤‡∏™‡πÄ‡∏ñ‡∏•‡∏¥‡∏á‡∏ñ‡∏ß‡∏±‡∏•‡∏¢‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡πÄ‡πÄ‡∏´‡πà‡∏á‡∏£‡∏≤‡∏ä‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£${rankName} ${countryName} ‡∏Ç‡∏≠‡∏û‡∏£‡∏∞‡∏≠‡∏á‡∏Ñ‡πå‡∏ó‡∏£‡∏á‡∏û‡∏£‡∏∞‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏¢‡∏¥‡πà‡∏á‡∏¢‡∏∑‡∏ô‡∏ô‡∏≤‡∏ô`;
                } else {
                    popupTitle = `üì¢ ‡∏Ç‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏î‡∏µ`;
                    
                    let occasion = govType === '‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ß‡∏ô‡∏¥‡∏™‡∏ï‡πå' ? '‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î' : '‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÇ‡∏≠‡∏Å‡∏≤‡∏®‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å';
                    let stateType = govType === '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ò‡∏¥‡∏õ‡πÑ‡∏ï‡∏¢' ? '‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏£‡∏±‡∏ê' : (govType === '‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ß‡∏ô‡∏¥‡∏™‡∏ï‡πå' ? '‡∏£‡∏±‡∏ê‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ß‡∏ô‡∏¥‡∏™‡∏ï‡πå' : rankName);

                    welcomeMsg = `‡∏Ç‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏Å‡∏±‡∏ö ${rulerName} ${occasion} ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô${title}‡πÅ‡∏´‡πà‡∏á${stateType} ${countryName} ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏ö‡∏£‡∏∑‡πà‡∏ô`;
                }

                showConfirmModal(popupTitle, welcomeMsg, () => {
                     closeModal('modal-sovereign-ruler');
                     window.toggleMultiSelectMode(); // ‡πÉ‡∏ä‡πâ window. ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Global
                     // Remove dark style after closing
                     document.getElementById('modal-confirm').querySelector('.modal-paper').classList.remove('modal-paper-dark');
                     document.getElementById('modal-confirm').querySelector('.modal-overlay').classList.remove('modal-fantasy-dark');
                }, true);
                
            } catch (error) {
                showConfirmModal("‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", error.message, null, true);
            }
        }


        window.toggleAllLevels = (check) => {
            document.querySelectorAll('.filter-level').forEach(cb => cb.checked = check);
            renderMap(); if(is3DMode) renderCesium();
        };

        window.toggleAllStatuses = (check) => {
            document.querySelectorAll('.filter-status').forEach(cb => cb.checked = check);
            renderMap(); if(is3DMode) renderCesium();
        };

        window.checkModeAndDraw = (type) => {
            // UPDATED: Check for Map Sheet
            if (!currentMapSheetId) {
                showConfirmModal("‚ö†Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏î (Map Sheet)", null, true);
                return;
            }
            // UPDATED: Check for Multi-Select Mode
            if(isMultiSelectMode) {
                 showConfirmModal("‚ö†Ô∏è ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏¥‡∏î '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà' (‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤) ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏î", null, true);
                 return;
            }
            // UPDATED: Check for 3D Mode
            if(is3DMode) {
                toggleGlobeMode();
                showConfirmModal("‚ö†Ô∏è ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ 2 ‡∏°‡∏¥‡∏ï‡∏¥", "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏¢‡∏±‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà 2 ‡∏°‡∏¥‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏≤‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á", null, true);
                return;
            }
            // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô
            if (isEditMode) {
                toggleEditGeometry();
            }
            // Determine draw action based on type
            if(type === 'polygon' || type === 'polygon_freehand' || type === 'polygon_point') {
                // If polygon is requested via main button, open menu. If requested via sub-button, start drawing.
                if(type === 'polygon') {
                     window.toggleDrawMenu();
                } else if(type === 'polygon_freehand') {
                    window.startFreehandMode();
                } else if(type === 'polygon_point') {
                    window.startPointMode();
                }
            } else if(type === 'polyline') {
                window.startDrawPolyline();
            } else if(type === 'marker') {
                window.startDrawMarker();
            }
        }

        // --- NEW: Toggle Draw Menu ---
        window.toggleDrawMenu = () => {
             const menu = document.getElementById('draw-submenu');
             menu.classList.toggle('active');
        };

        // --- Helper: Hierarchy Logic ---
        function getAncestors(ent) {
            const ancestors = [];
            let current = ent;
            let depth = 0;
            while(current.parentId && depth < 20) {
                const parent = entities.find(e => e.id === current.parentId);
                if(parent) { ancestors.push(parent); current = parent; } else break;
                depth++;
            }
            return ancestors.reverse();
        }

        function getDescendants(parentIds) {
            let descendants = [];
            let queue = [...parentIds];
            let visited = new Set(parentIds);
            let depth = 0;
            while(queue.length > 0 && depth < 50) { // Add safety check
                const pid = queue.shift();
                const children = entities.filter(e => e.parentId === pid);
                children.forEach(c => {
                    if(!visited.has(c.id)) { visited.add(c.id); descendants.push(c); queue.push(c.id); }
                });
                depth++;
            }
            return descendants;
        }

        function getHighestOwner(entity) {
             let owner = entity;
             if(entity.occupiedBy) {
                // Find the actual sovereign state (one that is not annexed/vassal/colony to others)
                let sovereign = entities.find(e => e.id === entity.occupiedBy);
                if (sovereign) {
                    owner = sovereign;
                }
             }
             return owner;
        }
        
        // --- UPDATED FEATURE 2: New Color Mode Logic ---
        function getEntityVisuals(ent) {
            const colorMode = document.getElementById('color-mode-select').value;
            let fillColor = ent.color;
            let colorContext = { type: 'entity', value: '‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏Ç‡∏ï' };

            // Determine if this entity is a sub-layer that should be ignored for political colors
            const isSubLayer = ent.isSubLayer; 

            if (colorMode === 'religion') {
                fillColor = COLORS.religion[ent.religion] || '#ccc';
                colorContext = { type: 'religion', value: ent.religion };
            } else if (colorMode === 'government') {
                fillColor = COLORS.gov[ent.government] || '#ccc';
                colorContext = { type: 'gov', value: ent.government };
            } else if (colorMode === 'rank') {
                const h = HIERARCHY.find(x => x.id === ent.level);
                fillColor = h ? h.defaultColor : '#ccc';
                colorContext = { type: 'rank', value: h ? h.name : 'Unknown' };
            } else if (colorMode === 'political' && !isSubLayer) { // Apply political color only to main layers
                const owner = getHighestOwner(ent);
                fillColor = owner.color || '#ccc';
                colorContext = { type: 'political', value: `‡∏ú‡∏π‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á: ${owner.name}` };
            } else if (colorMode === 'political' && isSubLayer) {
                // Keep original color for sub-layers in political mode for visualization
                fillColor = ent.originalColor || ent.color;
                colorContext = { type: 'sub-layer', value: `‡πÄ‡∏Ç‡∏ï‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î: ${getHierarchyName(ent.level)}` };
            }

            if (ent.isWater) {
                fillColor = '#81D4FA';
                colorContext = { type: 'water', value: '‡∏ô‡πà‡∏≤‡∏ô‡∏ô‡πâ‡∏≥' };
            }
            
            return { fillColor, colorContext };
        }
        
        // --- FIX: Added missing filterEntities function ---
        function filterEntities() {
            const selectedLevels = new Set(Array.from(document.querySelectorAll('.filter-level:checked')).map(cb => cb.value));
            const selectedStatuses = new Set(Array.from(document.querySelectorAll('.filter-status:checked')).map(cb => cb.value));
            const searchQuery = document.getElementById('search-input')?.value.toLowerCase() || '';

            const visibleEntities = entities.filter(ent => {
                // Type Filter
                if (ent.type === 'area') {
                    if (!selectedLevels.has(ent.level)) return false;

                    // Status Filter
                    let status = 'independent';
                    if (ent.isAnnexed) status = 'annexed';
                    else if (ent.isVassal) status = 'vassal';
                    else if (ent.isColony) status = 'colony';
                    if (!selectedStatuses.has(status)) return false;
                }

                // Search Filter
                if (searchQuery) {
                    const matchName = ent.name?.toLowerCase().includes(searchQuery);
                    const matchRuler = ent.ruler?.toLowerCase().includes(searchQuery);
                    const matchLevel = getHierarchyName(ent.level)?.toLowerCase().includes(searchQuery);
                    if (!matchName && !matchRuler && !matchLevel) return false;
                }
                
                return true;
            });

            return { visibleEntities };
        }
        // --- END FIX ---


        function renderImportantIcons() { /* ... unchanged ... */ }
        window.searchIcons = async () => { /* ... unchanged ... */ }
        function selectIcon(url, element) { /* ... unchanged ... */ }
        function renderCesium() { /* ... unchanged ... */ }

        // --- Leaflet Rendering Logic (UPDATED FOR SUB-LAYERS) ---
        function renderMap() {
            if(!map || !drawnItems) return;
            drawnItems.clearLayers();
            
            const { visibleEntities } = filterEntities();
            const showRoads = document.getElementById('toggle-roads').checked;
            
            // Separate entities into main layers and sub-layers (Sub-layers render first)
            const mainLayers = visibleEntities.filter(e => !e.isSubLayer && e.type === 'area');
            const subLayers = visibleEntities.filter(e => e.isSubLayer && e.type === 'area');
            const markersAndRoads = visibleEntities.filter(e => e.type !== 'area');

            // Order: Sub-layers first, then Main layers (to render outlines on top)
            // Note: Must include the new merged layers (which are !isSubLayer) to ensure they render above their sub-layers
            const orderedEntities = [...subLayers, ...mainLayers, ...markersAndRoads];


            orderedEntities.forEach(ent => {
                try {
                    const geoJson = JSON.parse(ent.geoJson);
                    const visuals = getEntityVisuals(ent); 

                    if (ent.type === 'road' || ent.type === 'marker') {
                        if (ent.type === 'road' && !showRoads) return;
                         // Existing road/marker rendering logic
                        if (ent.type === 'road') {
                             const roadLayer = L.geoJSON(geoJson, {
                                style: { color: ent.color, weight: parseInt(ent.weight) || 4, dashArray: ent.roadType === 'army' ? '10, 15' : null, opacity: 0.8, lineCap: 'round' }
                            }).bindPopup(`
                                <div class="text-center">
                                    <div class="font-bold text-[#5D4037] text-lg cute-font">${ent.name}</div>
                                    <div class="text-xs text-gray-500 mb-2">${ent.roadType==='army'?'‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏±‡∏û':'‡∏ñ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤'}</div>
                                    <button onclick="window.confirmDelete('${ent.id}')" class="text-red-400 text-xs underline cursor-pointer">‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</button>
                                </div>
                            `).addTo(drawnItems);
                            roadLayer.eachLayer(l => l.options.entityId = ent.id);
                        } else if (ent.type === 'marker') {
                            const icon = L.divIcon({
                                className: 'custom-marker',
                                html: `<div style="position:relative; width:30px; height:30px;"><div style="position:absolute; top:0; left:0; width:100%; height:100%; background:${ent.color}; opacity:0.3; border-radius:50%; filter:blur(4px);"></div><img src="${ent.iconUrl}" style="width:30px; height:30px; position:relative; z-index:2; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));"></div>`,
                                iconSize: [30, 30], iconAnchor: [15, 15]
                            });
                            L.geoJSON(geoJson, { pointToLayer: (f, l) => L.marker(l, {icon: icon}) }).bindPopup(`
                                <div class="text-center font-bold text-[#5D4037]">
                                    <img src="${ent.iconUrl}" class="w-12 h-12 mx-auto mb-2">
                                    <div class="mb-1 text-lg cute-font">${ent.name}</div>
                                    <button onclick="window.confirmDelete('${ent.id}')" class="text-red-400 text-xs underline cursor-pointer">‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î</button>
                                </div>
                            `).addTo(drawnItems);
                        }
                        return;
                    }

                    // --- AREA LOGIC ---
                    let strokeColor = ent.isWater ? '#29B6F6' : globalStrokeColor;
                    let strokeWeight = ent.isSubLayer ? 0.5 : (ent.isWater ? 1 : 1.5); // Thinner stroke for sub-layers
                    if (ent.isAnnexed) strokeColor = visuals.fillColor; 
                    
                    // Logic for Selection Highlight (Used for Multi-Select Mode)
                    const isSelected = selectedIds.has(ent.id);
                    
                    // Thicker stroke for main layer outlines
                    if (!ent.isSubLayer) {
                         strokeWeight = isSelected ? 4 : (ent.isWater ? 1 : 1.5);
                    }


                    // Style for the layer
                    const layerStyle = {
                        color: isSelected ? '#FFD700' : strokeColor, // Gold if selected (Multi-Select)
                        weight: isSelected ? 4 : strokeWeight,
                        fillColor: visuals.fillColor,
                        fillOpacity: ent.isWater ? 0.5 : (ent.isSubLayer ? 1.0 : globalOpacity), // Sub-layers should be fully opaque or opaque on top of the merged layer
                        dashArray: isSelected ? '8, 8' : (ent.isColony ? '5, 10' : null),
                        // Add ZIndex to ensure main layers render *above* sublayers
                        // Note: Leaflet only uses zIndex for markers/paths of the same type.
                        // The rendering order above is crucial.
                        zIndex: ent.isSubLayer ? 1 : 10
                    };
                    
                    // Override stroke color/style if currently being edited
                    if (isEditMode && ent.id === editingLayerId) {
                         window.editingLayer = null; // Ensure the logic below re-enables it if layer is found
                         layerStyle.color = strokeColor; 
                         layerStyle.weight = ent.isWater ? 1 : 1.5;
                         layerStyle.dashArray = ent.isColony ? '5, 10' : null;
                    }


                    L.geoJSON(geoJson, {
                        style: layerStyle,
                         onEachFeature: (f, l) => {
                            l.options.entityId = ent.id;

                            // ** ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Layer ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö Layer reference ‡πÑ‡∏ß‡πâ **
                            if (isEditMode && ent.id === editingLayerId) {
                                window.editingLayer = l;
                                l.editing.enable();
                            }
                            
                            l.on('click', async (e) => {
                                // 1. Pop-up Blocking: ‡∏õ‡∏¥‡∏î Popup ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
                                map.closePopup();

                                // 2. Check Edit Mode: 
                                if (window.isEditMode) {
                                    L.DomEvent.stopPropagation(e); 
                                    if (ent.type !== 'area' && ent.type !== 'road') { showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ"); return; }
                                    
                                    if (window.editingLayer && window.editingLayer !== l) {
                                        window.editingLayer.editing.disable();
                                        const oldRef = doc(getEntityCollectionRef(), window.editingLayer.options.entityId);
                                        setDoc(oldRef, { geoJson: JSON.stringify(window.editingLayer.toGeoJSON()) }, { merge: true }).then(() => console.log("Old entity saved")).catch(e => console.error("Error saving old entity:", e));
                                        window.editingLayerId = null;
                                        window.editingLayer = null;
                                    }

                                    l.editing.enable();
                                    window.editingLayer = l;
                                    window.editingLayerId = ent.id; 
                                    renderMap(); 
                                    showToast(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ${ent.name} (‡∏î‡∏∂‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á)`);
                                    return; 
                                }

                                // 3. Check Multi-Select Mode: 
                                if (isMultiSelectMode && ent.type === 'area' && !ent.isWater) {
                                    L.DomEvent.stopPropagation(e); 
                                    
                                    // Sub-layers cannot be merged or annexed directly, only the main layer
                                    if (ent.isSubLayer) {
                                        showToast(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏¢‡πà‡∏≠‡∏¢ (${ent.name}) ‡πÑ‡∏î‡πâ`);
                                        return;
                                    }

                                    if (selectedIds.has(ent.id)) selectedIds.delete(ent.id);
                                    else selectedIds.add(ent.id);
                                    updateSelectionUI();
                                    renderMap();
                                    return;
                                }

                                // 4. Default Mode: 
                                l.bindPopup(createPopupContent(ent, visuals.fillColor, visuals.colorContext)).openPopup();
                            });


                            if (document.getElementById('toggle-created-labels').checked && !ent.isWater && getRank(ent.level) >= 3) {
                                const center = l.getBounds().getCenter();
                                let labelHtml = ent.name;
                                
                                let owner = getHighestOwner(ent);

                                if (ent.isAnnexed) {
                                    labelHtml = owner.name;
                                }

                                if (ent.isColony) {
                                    labelHtml += `<div class="text-[9px] font-bold mt-0 text-red-600">(‡∏≠‡∏≤‡∏ì‡∏≤‡∏ô‡∏¥‡∏Ñ‡∏°‡∏Ç‡∏≠‡∏á ${owner.name})</div>`;
                                } else if (ent.isVassal) {
                                    labelHtml += `<div class="text-[9px] font-bold mt-0 text-red-600">(‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä‡∏Ç‡∏≠‡∏á ${owner.name})</div>`;
                                } else if (ent.isSubLayer) {
                                     // Hide labels for sub-layers unless they are high rank (e.g. city)
                                     if (getRank(ent.level) < 3) return; 
                                } 

                                drawnItems.addLayer(L.marker(center, { icon: L.divIcon({ className: 'text-center pointer-events-none', html: `<span class="text-[10px] sm:text-xs font-bold drop-shadow-md whitespace-nowrap block" style="color:${ent.labelColor || '#4E342E'}; text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;">${labelHtml}</span>`, iconSize: [120, 20], iconAnchor: [60, 10] }) }));
                            }
                            
                        }
                    }).addTo(drawnItems);

                } catch (e) { console.error("Render error", e); }
            });
        }

        // --- Complex Promotion Logic ---
        function checkSpecialPromotions(parentId) {
            const parentEnt = entities.find(e => e.id === parentId);
            if (!parentEnt || parentEnt.ruler !== playerState.name || currentMode !== 'management') return;
            
            const children = entities.filter(e => e.parentId === parentId && !e.isWater && !e.isSubLayer);
            const buttonsContainer = document.getElementById('promotion-buttons');
            buttonsContainer.innerHTML = '';
            
            const currentRank = getRank(parentEnt.level);
            
            // 1. Promote Muban to Kwaeng (Requires 3 Muban)
            if (parentEnt.level === 'muban' && currentRank < getRank('kwaeng') && children.length >= 3) {
                 const newRank = HIERARCHY.find(h => h.id === 'kwaeng');
                 buttonsContainer.innerHTML += createPromotionButton(
                    parentId, 'kwaeng', `‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô ${newRank.name} (${children.length} ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô)`
                 );
                 return; // Only one promotion per click on the lowest level
            }

            // 2. Promote Tambon to ArchKhet (Requires all Muban/Kwaeng under it to be Kwaeng)
            if (parentEnt.level === 'tambon' && currentRank < getRank('archKhet')) {
                const subRanks = children.map(c => c.level);
                // Check if all children are Kwaeng (1.5) or higher (if they merged higher)
                const allKwaengOrHigher = subRanks.every(level => getRank(level) >= getRank('kwaeng'));
                if (allKwaengOrHigher) {
                    const newRank = HIERARCHY.find(h => h.id === 'archKhet');
                    buttonsContainer.innerHTML += createPromotionButton(
                        parentId, 'archKhet', `‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô ${newRank.name} (‡πÅ‡∏Ç‡∏ß‡∏á‡∏Ñ‡∏£‡∏ö)`
                    );
                }
            }

            // 3. Promote Amphoe to Muang (Requires all Tambon/ArchKhet under it to be ArchKhet)
            if (parentEnt.level === 'amphoe' && currentRank < getRank('muang')) {
                const subRanks = children.map(c => c.level);
                const allArchKhetOrHigher = subRanks.every(level => getRank(level) >= getRank('archKhet'));
                if (allArchKhetOrHigher) {
                     const newRank = HIERARCHY.find(h => h.id === 'muang');
                     buttonsContainer.innerHTML += createPromotionButton(
                         parentId, 'muang', `‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô ${newRank.name} (‡∏≠‡∏≤‡πÄ‡∏Ç‡∏ï‡∏Ñ‡∏£‡∏ö)`
                     );
                }
            }
            
            // 4. Promote Jangwat to Nakorn (Requires all Amphoe/Muang under it to be Muang)
            if (parentEnt.level === 'jangwat' && currentRank < getRank('nakorn')) {
                const subRanks = children.map(c => c.level);
                const allMuangOrHigher = subRanks.every(level => getRank(level) >= getRank('muang'));
                if (allMuangOrHigher) {
                     const newRank = HIERARCHY.find(h => h.id === 'nakorn');
                     buttonsContainer.innerHTML += createPromotionButton(
                         parentId, 'nakorn', `‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô ${newRank.name} (‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö)`
                     );
                }
            }

            if(buttonsContainer.innerHTML === '') {
                 buttonsContainer.innerHTML = '<p class="text-xs text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πâ‡∏ô‡πÜ)</p>';
            }
        }
        
        function createPromotionButton(id, targetLevelId, label) {
             const h = HIERARCHY.find(x => x.id === targetLevelId);
             if (!h) return '';
             return `<button onclick="confirmSpecialPromotion('${id}', '${targetLevelId}')" class="btn-cute bg-yellow-600 hover:bg-yellow-700 text-white text-xs py-2 px-4 shadow-lg border border-white/20">${label}</button>`;
        }
        
        window.confirmSpecialPromotion = (id, targetLevelId) => {
             const ent = entities.find(e => e.id === id);
             const targetRankName = getHierarchyName(targetLevelId);
             
             showConfirmModal(
                 `‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö ${ent.name} ‡πÄ‡∏õ‡πá‡∏ô ${targetRankName}`,
                 `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ${getHierarchyName(ent.level)}: ${ent.name} ‡πÄ‡∏õ‡πá‡∏ô ${targetRankName} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                 () => executeSpecialPromotion(id, targetLevelId)
             );
             closeModal('modal-sub-regions');
        }

        async function executeSpecialPromotion(id, targetLevelId) {
             if(!validateAuth()) return;
             const ent = entities.find(e => e.id === id);
             const newTitle = HIERARCHY.find(h => h.id === targetLevelId)?.rulerTitle || ent.ruler;
             
             try {
                // 1. Update the entity to the new rank
                await setDoc(doc(getEntityCollectionRef(), id), {
                    level: targetLevelId,
                    ruler: newTitle, // Set ruler to the new default title
                    originalRuler: newTitle, // Also update original ruler
                    color: HIERARCHY.find(h => h.id === targetLevelId)?.defaultColor || ent.color
                }, { merge: true });

                // 2. Update player state if this is the highest rank achieved
                playerState.highestRank = targetLevelId;
                playerState.title = HIERARCHY.find(h => h.id === targetLevelId)?.rulerTitle || playerState.title;
                await savePlayerState();

                // 3. Show Proclamation
                showProclamationModal(targetLevelId, ent.name, playerState.name);

             } catch (error) {
                 showConfirmModal("‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", error.message, null, true);
             }
        }


        // --- Multi-Select & Promotion (UPDATED for Fusion Logic) ---
        window.openUnionModal = () => {
            // UPDATED: Check for minimum selection
            if (selectedIds.size < 2) {
                showConfirmModal("‚ö†Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏û‡∏≠", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏ß‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏ô‡∏ß‡∏Å‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô", null, true);
                return;
            }

            const modal = document.getElementById('modal-union');
            modal.classList.remove('hidden');
            
            const selectedEnts = entities.filter(ent => selectedIds.has(ent.id));
            // Check for muban/kwaeng only
            const allVillages = selectedEnts.every(e => getRank(e.level) >= getRank('muban') && getRank(e.level) <= getRank('kwaeng'));
            
            const mergeLevelSelect = document.getElementById('merge-level');
            const mergeLevelNote = document.getElementById('merge-level-note');
            const mergeSubRankNote = document.getElementById('merge-sub-rank-note');
            const highestRank = playerState.highestRank;
            const highestRankObj = HIERARCHY.find(h => h.id === highestRank);
            
            // --- Setup Tab 1: Merge Level Dropdown ---
            mergeLevelSelect.innerHTML = '';
            
            // Determine possible target ranks
            const minRankOfSelected = Math.min(...selectedEnts.map(e => getRank(e.level)));
            const nextRankUp = HIERARCHY.find(h => h.rank > minRankOfSelected);
            const highestAllowedRank = HIERARCHY.find(h => h.rank === getRank(playerState.highestRank) + 1) || HIERARCHY.find(h => h.id === playerState.highestRank);

            HIERARCHY.sort((a,b) => b.rank - a.rank).forEach(h => {
                const opt = document.createElement('option'); opt.value = h.id; opt.text = h.name;
                
                if (currentMode === 'management') {
                    // Only allow target rank to be higher than the lowest selected, and no higher than the next rank up from player's current highest rank
                    const targetRankVal = getRank(h.id);
                    const isNextRank = nextRankUp && h.id === nextRankUp.id;

                    // Disable everything not directly related to promotion or already achieved by the player
                    if (targetRankVal <= minRankOfSelected) { // Must be a promotion
                         opt.disabled = true;
                    } else if (targetRankVal > getRank(highestAllowedRank.id)) { // Cannot jump more than one rank (Unless it's the specific Muban->Tambon merge)
                         if (!(allVillages && h.id === 'tambon')) opt.disabled = true;
                    } 
                    
                    if (allVillages && h.id === 'tambon') opt.selected = true;
                    else if (isNextRank && !opt.disabled) opt.selected = true;


                } else if(h.rank >= 7) { // Creative mode default
                     opt.selected = true; 
                }
                
                mergeLevelSelect.appendChild(opt);
            });

            // Update merge ruler/color defaults
            document.getElementById('merge-ruler').value = playerState.name || selectedEnts[0].ruler || '';
            document.getElementById('merge-color').value = highestRankObj.defaultColor;

            // Show notes for Fusion/Sub-Layer Logic
            const selectedMergeLevel = mergeLevelSelect.value;
            if (currentMode === 'management' && (allVillages || getRank(selectedMergeLevel) > getRank('muban'))) {
                 mergeSubRankNote.classList.remove('hidden');
            } else {
                 mergeSubRankNote.classList.add('hidden');
            }

            // Show note if it's a village-to-tambon promotion
            if (currentMode === 'management' && allVillages) {
                 mergeLevelSelect.value = 'tambon'; // Force select
                 mergeLevelSelect.disabled = true; // Lock selection
                 document.getElementById('merge-ruler').value = playerState.name; // Force ruler name
                 document.getElementById('merge-ruler').disabled = true;
                 mergeLevelNote.classList.remove('hidden');
            } else {
                 mergeLevelSelect.disabled = false;
                 document.getElementById('merge-ruler').disabled = false;
                 mergeLevelNote.classList.add('hidden');
            }


            // Setup Tab 2: Annex Leader Selector (unchanged)
            const leaderSelect = document.getElementById('annex-leader-select');
            leaderSelect.innerHTML = '';
            selectedIds.forEach(id => {
                const ent = entities.find(e => e.id === id);
                if(ent) {
                    const opt = document.createElement('option');
                    opt.value = ent.id;
                    opt.innerText = `${ent.name} (‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á: ${ent.ruler})`;
                    leaderSelect.appendChild(opt);
                }
            });

            switchUnionTab('merge');
        };

        // --- Merger Execution (Updated for Sub-Layer Creation and Sovereign/Proclamation Check) ---
        window.executeMerge = async (e) => {
            e.preventDefault();
            if(!window.userId || !currentMapSheetId) { showConfirmModal("Error", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", null, true); return; }

            const newLevel = document.getElementById('merge-level').value;
            const newRuler = document.getElementById('merge-ruler').value;
            const newName = document.getElementById('merge-name').value;
            const newColor = document.getElementById('merge-color').value;
            
            const selectedEnts = entities.filter(ent => selectedIds.has(ent.id));
            const allVillages = selectedEnts.every(e => getRank(e.level) >= getRank('muban') && getRank(e.level) <= getRank('kwaeng'));
            // Fusion logic applies to all promotions from the lowest rank up (e.g., all villages merging into something higher than muban)
            const isSubLayerMerge = currentMode === 'management' && getRank(newLevel) > getRank(selectedEnts[0].level);
            
            let villageToRename = null;
            let mergeLevelUp = false;

            if (currentMode === 'management' && allVillages && newLevel === 'tambon') {
                mergeLevelUp = true;
                villageToRename = selectedEnts.find(e => e.ruler === playerState.name);
                if (villageToRename) {
                     playerState.title = HIERARCHY.find(h => h.id === 'tambon')?.rulerTitle || '‡∏Å‡∏≥‡∏ô‡∏±‡∏ô';
                     playerState.highestRank = 'tambon';
                     document.getElementById('village-id-to-rename').value = villageToRename.id;
                     document.getElementById('village-to-rename').innerText = villageToRename.name;
                     document.getElementById('new-player-title').innerText = playerState.title;
                }
            }


            try {
                const polys = selectedEnts.map(ent => JSON.parse(ent.geoJson));

                // Turf Union Logic
                let mergedGeo = polys[0];
                for (let i = 1; i < polys.length; i++) {
                    mergedGeo = turf.union(mergedGeo, polys[i]);
                }

                const newDoc = {
                    name: newName,
                    ruler: newRuler,
                    color: newColor,
                    level: newLevel,
                    geoJson: JSON.stringify(mergedGeo),
                    type: 'area',
                    isWater: false,
                    createdAt: new Date().toISOString(),
                    originalName: newName,
                    originalRuler: newRuler,
                    originalColor: newColor,
                    mergedFrom: selectedEnts.map(e => e.name),
                    isSubLayer: false // New merged layer is the main layer
                };

                const batch = writeBatch(db);
                const colRef = getEntityCollectionRef();

                // 1. Create new merged layer
                const newRef = doc(colRef); 
                batch.set(newRef, newDoc);

                // 2. Handle old layers (Fusion Logic)
                selectedIds.forEach(id => {
                    const oldEnt = entities.find(e => e.id === id);
                    const oldRef = doc(colRef, id);

                    // If fusion is enabled (or required for promotion)
                    if (isSubLayerMerge) {
                        const isVillageToRename = villageToRename && id === villageToRename.id;

                        // Preserve the old entity as a sub-layer
                        const subLayerUpdates = {
                            parentId: newRef.id,
                            isSubLayer: true, // Mark it as a sub-layer
                            isAnnexed: false, isVassal: false, isColony: false, // Ensure sub-layers are 'independent' visually
                            originalColor: oldEnt.originalColor || oldEnt.color, // Keep original color for sub-layer distinction
                            ruler: isVillageToRename ? newRuler : oldEnt.ruler, // Update ruler if needed for promotion flow
                            // Keep all other properties (name, level, geoJson)
                        };

                        batch.update(oldRef, subLayerUpdates);
                    } else {
                        // Regular Merge: Delete old layers
                        batch.delete(oldRef);
                    }
                });
                
                // 3. Complete promotion steps
                if (mergeLevelUp) {
                     await savePlayerState();
                }

                await batch.commit();
                
                // --- Sovereign Check ---
                const newRankVal = getRank(newLevel);
                const isSovereignPromotion = newRankVal >= getRank('prathet'); 
                const playerIsNewRuler = newRuler === playerState.name;

                closeModal('modal-union');
                window.toggleMultiSelectMode(); // ‡πÉ‡∏ä‡πâ window. ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Global

                if (isSovereignPromotion && currentMode === 'management' && playerIsNewRuler) {
                     // 1. Prepare data for Sovereign Modal
                     document.getElementById('sovereign-new-id').value = newRef.id;
                     document.getElementById('sovereign-new-level').value = newLevel;
                     document.getElementById('sovereign-rank-display').innerText = getHierarchyName(newLevel);
                     document.getElementById('sovereign-ruler-name-input').value = playerState.name;
                     
                     // 2. Open Sovereign Modal instead of normal confirmation
                     document.getElementById('modal-sovereign-ruler').classList.remove('hidden');
                     updateSovereignRulerTitle(); // Initialize titles/label
                     
                } else if (currentMode === 'management' && playerIsNewRuler && mergeLevelUp) {
                    // Non-Sovereign Promotion Proclamation (muban to monrath)
                    showProclamationModal(newLevel, newName, playerState.name);

                    // If a village needs renaming, open the modal (this is for the Village Chief the player replaced)
                    if (villageToRename) {
                         document.getElementById('modal-village-ruler').classList.remove('hidden');
                    }
                } else {
                    // Standard confirmation for regular merge or non-player ruler promotion
                    showConfirmModal("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", `‡πÄ‡∏Ç‡∏ï‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á ${newName} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÅ‡∏•‡πâ‡∏ß!`, null, true);
                }

            } catch (err) {
                console.error(err);
                showConfirmModal("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏ß‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ (‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≤‡∏à‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)", null, true);
            }
        };

        // --- Annexation Logic (Updated for Fantasy Popup) ---
        window.executeAnnex = async (type) => {
            if(!window.userId || !currentMapSheetId) { showConfirmModal("Error", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", null, true); return; }
            
            const leaderId = document.getElementById('annex-leader-select').value;
            const leader = entities.find(e => e.id === leaderId);
            const targets = entities.filter(ent => selectedIds.has(ent.id));
            
            if(!leader) return;

            const batch = writeBatch(db);
            const colRef = getEntityCollectionRef();

            targets.forEach(target => {
                if(target.id === leaderId) return;

                const entRef = doc(colRef, target.id);
                const updates = {
                    isAnnexed: false, isVassal: false, isColony: false,
                    occupiedBy: leader.id,
                    annexedByName: leader.name,
                    ruler: leader.ruler, 
                    color: leader.color,
                    isSubLayer: false // Ensure annexed areas are main layers
                };

                if(type === 'annex') updates.isAnnexed = true;
                if(type === 'vassal') updates.isVassal = true;
                if(type === 'colony') updates.isColony = true;

                batch.update(entRef, updates);
                
                // Re-parent the target's sub-regions (if any) to the leader
                // This handles: A conquers B. B's direct children (C, D) now report to A.
                const targetChildren = entities.filter(e => e.parentId === target.id);
                targetChildren.forEach(child => {
                     batch.update(doc(colRef, child.id), { parentId: leader.id }, { merge: true });
                });
            });

            await batch.commit();
            
            closeModal('modal-union');
            window.toggleMultiSelectMode(); // ‡πÉ‡∏ä‡πâ window. ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Global

            // NEW: Fantasy Conquer Popup for Annex
            if (type === 'annex') {
                const targetRank = getHierarchyName(target.level);
                const attackerRank = getHierarchyName(attacker.level);
                
                const collapseMessage = `‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£${targetRank} ${target.name} ‡∏•‡πà‡∏°‡∏™‡∏•‡∏≤‡∏¢‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÇ‡∏î‡∏¢ ${attackerRank} ${attacker.name} ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏´‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏ô‡∏µ‡πâ‡∏°‡∏¥‡∏≠‡∏≤‡∏à‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏ß‡∏á‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏´‡πà‡∏á‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏á‡∏™‡∏á‡∏ö...`;
                
                // Apply dark/fantasy style
                document.getElementById('modal-confirm').querySelector('.modal-paper').classList.add('modal-paper-dark');
                document.getElementById('modal-confirm').querySelector('.modal-overlay').classList.add('modal-fantasy-dark');

                showConfirmModal(
                    `üåë ‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üåë`,
                    collapseMessage,
                    () => {
                         // Remove dark style after closing
                         document.getElementById('modal-confirm').querySelector('.modal-paper').classList.remove('modal-paper-dark');
                         document.getElementById('modal-confirm').querySelector('.modal-overlay').classList.remove('modal-fantasy-dark');
                    }, 
                    true
                );
            } else {
                showToast(`‚öîÔ∏è ‡∏¢‡∏∏‡∏ó‡∏ò‡∏Å‡∏≤‡∏£ ${type} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!`);
            }
        };

        // --- War Modal Logic (Updated for rank and Nakorn restrictions) ---
        window.openWarModal = (tid) => {
            const t = entities.find(e => e.id === tid);
            document.getElementById('war-target-id').value = tid;
            document.getElementById('war-target-name').innerText = t.name; 
            
            const sel = document.getElementById('war-attacker-select'); sel.innerHTML = '';
            
            // Filter attackers: Only areas ruled by the player and capable of war (Prathet, Anachak, MahaAnachak, Nakorn)
            const warCapableRanks = HIERARCHY.filter(h => h.warCapable).map(h => h.id);
            const playerAttackers = entities.filter(e => 
                 !e.isWater && e.type === 'area' && e.ruler === playerState.name && 
                 e.id !== tid && warCapableRanks.includes(e.level)
            );
            
            // UPDATED: Check for player's war capability rank
            if (playerAttackers.length === 0) {
                 showConfirmModal("‚öîÔ∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°", `‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö **‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® (Rank 7) ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ** ‡∏´‡∏£‡∏∑‡∏≠ **‡∏ô‡∏Ñ‡∏£ (Rank 4.5)** ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°‡πÑ‡∏î‡πâ ‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô ( ${getHierarchyName(playerState.highestRank)} ) ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠`, null, true);
                 return;
            }

            playerAttackers.forEach(e => {
                const opt = document.createElement('option'); opt.value = e.id; opt.text = `${e.name} (${getHierarchyName(e.level)})`; sel.appendChild(opt);
            });
            
            // Set button restrictions based on the selected attacker's rank (Nakorn restriction)
            sel.onchange = () => {
                 const attackerId = sel.value;
                 const attacker = entities.find(e => e.id === attackerId);
                 const attackerRank = HIERARCHY.find(h => h.id === attacker.level);
                 
                 document.getElementById('war-btn-annex').disabled = false;
                 document.getElementById('war-btn-vassal').disabled = false;
                 document.getElementById('war-btn-colony').disabled = false;

                 if (attackerRank?.warType === 'annexOnly') {
                     document.getElementById('war-btn-vassal').disabled = true;
                     document.getElementById('war-btn-colony').disabled = true;
                     // UPDATED: Show warning modal about Nakorn's restriction on button click
                     showConfirmModal("‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£", "‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£ (Nakorn) ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ó‡∏≤‡∏á‡∏¢‡∏∏‡∏ó‡∏ò‡∏Å‡∏≤‡∏£: ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á **‡∏ú‡∏ô‡∏ß‡∏Å‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô", null, true);
                 }
            }
            // Trigger initial check
            if (sel.options.length > 0) sel.onchange();

            document.getElementById('modal-war').classList.remove('hidden');
        }


        // --- Helper: Multi-Select Mode (Made Global) ---
        window.toggleMultiSelectMode = () => {
            isMultiSelectMode = !isMultiSelectMode;
            if (isMultiSelectMode) {
                document.getElementById('selection-bar').classList.remove('hidden');
                document.getElementById('btn-multi-select').classList.add('active');
            } else {
                selectedIds.clear();
                document.getElementById('selection-bar').classList.add('hidden');
                document.getElementById('btn-multi-select').classList.remove('active');
            }
            renderMap();
        };

        function updateSelectionUI() {
            document.getElementById('selection-count').innerText = selectedIds.size;
        }

        // --- Unchanged Functions ---
        window.showToast = (msg) => { /* ... unchanged ... */ }
        // The original filterEntities was missing. It has been added above.
        function createPopupContent(ent, displayColor, colorContext) { /* ... unchanged ... */ }
        function updateLegend(mode) { /* ... unchanged ... */ }
        window.startDrawPolygon = () => openAreaModal(); // Use the logic to open the modal
        window.startDrawPolyline = () => new L.Draw.Polyline(map).enable();
        window.startDrawMarker = () => new L.Draw.Marker(map).enable();
        window.toggleFullScreen = async () => { /* ... unchanged ... */ }
        window.startPointMode = () => new L.Draw.Polygon(map).enable(); // Direct call to start drawing polygon
        window.startFreehandMode = () => { /* ... unchanged ... */ }
        function onFreehandDown(e) { /* ... unchanged ... */ }
        function onFreehandMove(e) { /* ... unchanged ... */ }
        function onFreehandUp() { /* ... unchanged ... */ }

        function onDrawCreated(e) {
            // UPDATED: Check for Map Sheet
            if (!currentMapSheetId) { 
                drawnItems.removeLayer(e.layer);
                showConfirmModal("‚ö†Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏î (Map Sheet)", null, true);
                return;
            }

            currentDrawLayer = e.layer;
            drawnItems.addLayer(currentDrawLayer); 
            if (e.layerType === 'polygon') {
                openAreaModal(); 
            } else if (e.layerType === 'polyline') {
                document.getElementById('modal-road').classList.remove('hidden');
            } else if (e.layerType === 'marker') {
                document.getElementById('modal-marker').classList.remove('hidden');
            }
        }

        function onDrawEdited(e) {
            e.layers.eachLayer(async (layer) => {
                if(layer.options.entityId) await setDoc(doc(getEntityCollectionRef(), layer.options.entityId), { geoJson: JSON.stringify(layer.toGeoJSON()) }, { merge: true });
            });
        }

        window.saveRoad = async () => { /* ... unchanged ... */ }
        window.saveMarker = async () => { /* ... unchanged ... */ }
        window.saveArea = async (e) => {
            e.preventDefault();
            if(!validateAuth()) return;
            const id = document.getElementById('area-id').value;
            const isFirstMuban = currentMode === 'management' && id === '' && entities.filter(e => e.type === 'area' && !e.isWater).length === 0;
            
            const levelId = document.getElementById('inp-level').value;
            const rulerInput = isFirstMuban ? playerState.name : document.getElementById('inp-ruler').value;
            
            // Auto-set the appropriate ruler title if in management mode and not sovereign level
            let finalRulerName = rulerInput;
            if (currentMode === 'management' && getRank(levelId) < getRank('prathet') && !isFirstMuban) {
                 const rulerTitle = HIERARCHY.find(h => h.id === levelId)?.rulerTitle || '';
                 if (rulerInput.includes(playerState.name) && !rulerInput.includes(rulerTitle)) {
                      finalRulerName = `${rulerTitle} ${playerState.name}`; // Ensure title is always correct
                 } else if (rulerInput === playerState.name) {
                     finalRulerName = `${rulerTitle} ${playerState.name}`;
                 }
            }


            const data = {
                name: document.getElementById('inp-name').value,
                customId: document.getElementById('inp-custom-id').value,
                level: levelId,
                parentId: document.getElementById('inp-parent').value,
                ruler: isFirstMuban ? playerState.name : finalRulerName, // Use player name if first muban
                religion: document.getElementById('inp-religion').value,
                government: document.getElementById('inp-gov').value,
                color: document.getElementById('inp-color').value,
                labelColor: document.getElementById('inp-label-color').value,
                isWater: document.querySelector('input[name="areaType"]:checked').value === 'water',
                type: 'area',
                isSubLayer: false // New areas start as main layers
            };
            
            const img = document.getElementById('preview-flag');
            if(img.src && !img.src.includes(window.location.href)) data.flag = img.src;

            if(!id) {
                data.geoJson = JSON.stringify(currentDrawLayer.toGeoJSON());
                data.createdAt = new Date().toISOString();
                data.originalName = data.name; 
                data.originalRuler = data.ruler; 
                data.originalColor = data.color; 
            } else {
                 const oldEnt = entities.find(e => e.id === id);
                 if(oldEnt && !oldEnt.originalColor) data.originalColor = oldEnt.color;
            }

            await saveToFirestore(data, id);
            closeModal('modal-area'); currentDrawLayer = null;
            
            // If it's the very first village in management mode, show the proclamation/welcome
            if (isFirstMuban && currentMode === 'management') {
                 // Update player state to be Village Chief
                 playerState.highestRank = 'muban';
                 playerState.title = HIERARCHY.find(h => h.id === 'muban')?.rulerTitle || '‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô';
                 await savePlayerState();
                 showProclamationModal('muban', data.name, playerState.name);
            }
        }

        function validateAuth() { /* ... unchanged ... */ }
        async function saveToFirestore(data, id = null) { /* ... unchanged ... */ }
        
        // --- War Action (Updated to use selected Attacker) ---
        window.confirmWarAction = async (type) => {
            const tid = document.getElementById('war-target-id').value;
            const aid = document.getElementById('war-attacker-select').value;
            const attacker = entities.find(e => e.id === aid);
            const target = entities.find(e => e.id === tid);
            
            if (!attacker || !target) {
                 showToast("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÇ‡∏à‡∏°‡∏ï‡∏µ/‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                 return;
            }

            const updates = { isAnnexed: false, isVassal: false, isColony: false };
            
            if(type === 'annex') updates.isAnnexed = true;
            if(type === 'vassal') updates.isVassal = true;
            if(type === 'colony') updates.isColony = true;

            updates.annexedByName = attacker.name; 
            updates.occupiedBy = attacker.id; 
            updates.ruler = attacker.ruler;

            // Ensure the target is no longer a sub-layer if it was
            updates.isSubLayer = false; 

            if(type === 'colony') {
                updates.color = target.originalColor || target.color;
            } else {
                updates.color = attacker.color;
            }
            
            await setDoc(doc(getEntityCollectionRef(), tid), updates, {merge: true});
            closeModal('modal-war');
            
            // Re-parent the target's sub-regions (if any) to the leader
            const colRef = getEntityCollectionRef();
            const targetChildren = entities.filter(e => e.parentId === target.id);
            const reparentBatch = writeBatch(db);
            targetChildren.forEach(child => {
                 reparentBatch.update(doc(colRef, child.id), { parentId: attacker.id }, { merge: true });
            });
            await reparentBatch.commit();


            // NEW: Fantasy Conquer Popup for War
            if (type === 'annex') {
                const targetRank = getHierarchyName(target.level);
                const attackerRank = getHierarchyName(attacker.level);
                
                const collapseMessage = `‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£${targetRank} ${target.name} ‡∏•‡πà‡∏°‡∏™‡∏•‡∏≤‡∏¢‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÇ‡∏î‡∏¢ ${attackerRank} ${attacker.name} ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏´‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏ô‡∏µ‡πâ‡∏°‡∏¥‡∏≠‡∏≤‡∏à‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏ß‡∏á‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏´‡πà‡∏á‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏á‡∏™‡∏á‡∏ö...`;
                
                // Apply dark/fantasy style
                document.getElementById('modal-confirm').querySelector('.modal-paper').classList.add('modal-paper-dark');
                document.getElementById('modal-confirm').querySelector('.modal-overlay').classList.add('modal-fantasy-dark');

                showConfirmModal(
                    `üåë ‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üåë`,
                    collapseMessage,
                    () => {
                         // Remove dark style after closing
                         document.getElementById('modal-confirm').querySelector('.modal-paper').classList.remove('modal-paper-dark');
                         document.getElementById('modal-confirm').querySelector('.modal-overlay').classList.remove('modal-fantasy-dark');
                    }, 
                    true
                );
            } else {
                showToast(`‚öîÔ∏è ‡∏¢‡∏∏‡∏ó‡∏ò‡∏Å‡∏≤‡∏£ ${type} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!`);
            }
        }
        
        window.declareIndependence = (id) => { /* ... unchanged ... */ }
        window.confirmDelete = (id) => { /* ... unchanged ... */ }
        window.openEditModal = (id) => { /* ... unchanged ... */ }
        document.getElementById('form-login').onsubmit = async (e) => { /* ... unchanged ... */ }
        document.getElementById('form-register').onsubmit = async (e) => { /* ... unchanged ... */ }
        window.logoutUser = () => signOut(auth);
        window.cancelDraw = () => { /* ... unchanged ... */ }
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.showConfirmModal = (t, m, fn, alert=false) => { /* ... unchanged ... */ }
        window.executePendingConfirm = async () => { /* ... unchanged ... */ }
        window.toggleEditGeometry = async () => { 
             if (!currentMapSheetId) { 
                 showConfirmModal("‚ö†Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç", null, true);
                 return;
             }
             // ... (rest of the logic unchanged)
        }
        function updateParentSelect(rank) { /* ... unchanged ... */ }
        function getRank(id) { return HIERARCHY.find(x=>x.id===id)?.rank || 0; }
        function getHierarchyName(id) { return HIERARCHY.find(x=>x.id===id)?.name || id; }
        document.getElementById('inp-flag').onchange = (e) => { /* ... unchanged ... */ }
        
        // --- NEW: Open Sub Region Manager Logic (Added promotion checks) ---
        window.openSubRegionManager = (parentId) => {
            const parentEnt = entities.find(e => e.id === parentId);
            // Only show main layers as children for clarity in the list
            const children = entities.filter(e => e.parentId === parentId && !e.isWater && !e.isSubLayer).sort((a,b) => a.name.localeCompare(b.name));
            
            document.getElementById('sub-region-parent-id').value = parentId;
            document.getElementById('sub-region-parent-name').innerText = parentEnt.name;

            const listContainer = document.getElementById('sub-region-list');
            listContainer.innerHTML = '';

            if (children.length === 0) {
                listContainer.innerHTML = '<div class="text-center text-gray-400 p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ç‡∏ï‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</div>';
                document.getElementById('transfer-child-select').innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ç‡∏ï‡∏¢‡πà‡∏≠‡∏¢ --</option>';
            } else {
                let childOptions = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏¢‡πà‡∏≠‡∏¢ --</option>';
                children.forEach(c => {
                    // Check if this child itself has sub-layers (from fusion)
                    const isFused = entities.some(e => e.parentId === c.id && e.isSubLayer);
                    
                    listContainer.innerHTML += `
                        <div class="flex justify-between items-center p-2 rounded-lg bg-white shadow-sm border border-gray-100">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full" style="background-color:${c.color}"></span>
                                <span class="font-bold text-sm">${c.name}</span>
                                <span class="text-xs text-gray-500">(${getHierarchyName(c.level)})</span>
                                ${isFused ? '<span class="text-[10px] text-purple-500 font-bold ml-1"> (Fusion)</span>' : ''}
                            </div>
                            <button onclick="window.confirmDelete('${c.id}')" class="text-red-400 hover:text-red-600"><span class="material-icons-round text-sm">delete</span></button>
                        </div>
                    `;
                    childOptions += `<option value="${c.id}">${c.name} (${getHierarchyName(c.level)})</option>`;
                });
                document.getElementById('transfer-child-select').innerHTML = childOptions;
            }

            // Setup Target Selector (All areas with higher rank)
            const targetSelect = document.getElementById('transfer-target-select');
            targetSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡πÅ‡∏°‡πà‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á --</option>';
            const currentRank = getRank(parentEnt.level);
            
            entities.filter(e => getRank(e.level) > currentRank && !e.isWater && e.id !== parentId).forEach(p => {
                 targetSelect.innerHTML += `<option value="${p.id}">${p.name} (${getHierarchyName(p.level)})</option>`;
            });
            
            // Check for special promotions and render buttons
            checkSpecialPromotions(parentId);

            document.getElementById('modal-sub-regions').classList.remove('hidden');
        }

        window.executeTransfer = async () => { /* ... unchanged ... */ }
    </script>
</body>
</html>
