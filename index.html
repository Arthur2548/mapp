<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Map Creator: Enchanted Realm (Map Sheet Edition)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS/JS (2D Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet.Draw -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <!-- Turf.js (For Geometry Merging & Simplify) -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <!-- CesiumJS (3D Globe) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cesium/1.105.0/Cesium.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cesium/1.105.0/Widgets/widgets.css" rel="stylesheet">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@300;400;500;600;700&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

    <style>
        /* Custom Theme: Cute Fantasy */
        :root {
            --paper-bg: #FFFBF0;
            --wood-dark: #6D4C41;
            --wood-light: #A1887F;
            --gold-accent: #FFB74D;
            --text-main: #4E342E;
            --cute-pink: #FFAB91;
            --cute-blue: #81D4FA;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--paper-bg);
            color: var(--text-main);
            overflow: hidden;
            margin: 0; padding: 0;
        }

        h1, h2, h3, h4, .fantasy-font, .btn-ancient, .cute-font {
            font-family: 'Mali', cursive;
        }

        /* Map Container */
        #map-container {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
            background-color: #B3E5FC;
            position: absolute;
            top: 0; left: 0;
            transition: opacity 0.5s ease;
        }

        /* Custom Cursor for Freehand Mode */
        .cursor-pen {
            cursor: url('https://api.iconify.design/mdi:fountain-pen-tip.svg?color=%235D4037&width=32&height=32') 0 32, crosshair !important;
        }
        .cursor-pen .leaflet-interactive {
            cursor: url('https://api.iconify.design/mdi:fountain-pen-tip.svg?color=%235D4037&width=32&height=32') 0 32, crosshair !important;
        }
        
        /* NEW: Cursor for splitting (Knife) */
        .cursor-knife {
            cursor: url('https://api.iconify.design/mdi:knife.svg?color=%2300BCD4&width=32&height=32') 16 16, crosshair !important;
        }
        .cursor-knife .leaflet-interactive {
            cursor: url('https://api.iconify.design/mdi:knife.svg?color=%2300BCD4&width=32&height=32') 16 16, crosshair !important;
        }

        #cesiumContainer {
            height: 100%;
            width: 100%;
            z-index: 0;
            position: absolute;
            top: 0; left: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        /* Active/Inactive States */
        .mode-2d #map { z-index: 10; opacity: 1; pointer-events: auto; }
        .mode-2d #cesiumContainer { z-index: 0; opacity: 0; pointer-events: none; }
        
        .mode-3d #map { z-index: 0; opacity: 0; pointer-events: none; }
        .mode-3d #cesiumContainer { z-index: 10; opacity: 1; pointer-events: auto; }

        /* UI Containers */
        .sidebar-left {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 340px;
            background: rgba(255, 251, 240, 0.95);
            backdrop-filter: blur(12px);
            border-right: 2px dashed var(--wood-light);
            z-index: 1000;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 4px 0 25px rgba(93, 64, 55, 0.1);
            display: flex;
            flex-direction: column;
        }

        .sidebar-collapsed {
            transform: translateX(-340px);
        }

        .toggle-sidebar-btn {
            position: absolute;
            top: 20px;
            right: -40px;
            background: #fff;
            color: var(--wood-dark);
            width: 40px;
            height: 48px;
            border-radius: 0 16px 16px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 4px 2px 10px rgba(0,0,0,0.1);
            font-family: 'Mali', cursive;
            font-size: 1.2rem;
            transition: all 0.2s;
            border: 2px solid var(--wood-light);
            border-left: none;
        }
        .toggle-sidebar-btn:hover { background: var(--wood-dark); color: #fff; }

        /* Modern Toolbar */
        .toolbar-vertical {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
            align-items: flex-end; /* Align to right for submenu */
        }

        .tool-group {
            position: relative;
            display: flex;
            align-items: center;
            flex-direction: row;
            gap: 10px;
        }

        /* Submenu Animation */
        .tool-submenu {
            display: flex;
            gap: 8px;
            opacity: 0;
            transform: translateX(20px);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            margin-right: 4px;
        }
        .tool-submenu.active {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }

        .tool-btn {
            width: 48px;
            height: 48px;
            background: white;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(93, 64, 55, 0.15);
            color: var(--wood-dark);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 2px solid white;
            cursor: pointer;
            position: relative;
            z-index: 2;
        }
        .tool-btn:hover, .tool-btn.active {
            transform: scale(1.1) rotate(-5deg);
            color: var(--wood-light);
            border-color: var(--gold-accent);
        }
        .tool-btn span { font-size: 26px; }

        .tool-btn-sub {
            width: 40px; height: 40px;
            border-radius: 12px;
            background: #FFF8E1;
            border: 2px solid #FFE0B2;
            color: #5D4037;
        }
        .tool-btn-sub:hover {
            background: #FFECB3;
            transform: scale(1.1);
        }

        /* Compass - Moved down to allow Draw menu to open freely */
        .compass-container {
            position: absolute;
            top: 90px; /* Moved down from 20px */
            right: 80px;
            width: 60px;
            height: 60px;
            z-index: 950;
            transition: all 0.3s;
            cursor: pointer;
        }
        .compass-container:hover { transform: scale(1.1); }
        .compass-img {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
            transition: transform 0.1s;
        }
        .hidden-compass { opacity: 0; pointer-events: none; }
        
        .compass-tooltip {
            position: absolute;
            top: 140px; /* Adjusted position */
            right: 80px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .compass-container:hover + .compass-tooltip { opacity: 1; }

        /* Globe Toggle Button */
        .globe-toggle-btn {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: white;
            border: 4px solid var(--wood-dark);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }
        .globe-toggle-btn:hover {
            transform: scale(1.1) rotate(10deg);
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        }
        .globe-toggle-btn img { width: 100%; height: 100%; object-fit: cover; }
        .globe-tooltip {
            position: absolute;
            bottom: 100px;
            right: 30px;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--wood-dark);
            font-weight: bold;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        .globe-toggle-btn:hover + .globe-tooltip { opacity: 1; }

        .leaflet-draw { display: none !important; } 
        
        /* Modal & UI Elements */
        .modal-overlay {
            background-color: rgba(78, 52, 46, 0.4);
            backdrop-filter: blur(8px);
            transition: opacity 0.3s;
        }
        
        .modal-paper {
            background: #FFFBF0;
            border-radius: 30px;
            box-shadow: 0 25px 60px rgba(93, 64, 55, 0.25);
            border: 4px solid white;
            outline: 2px dashed #E0E0E0;
            animation: modalPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }

        .modal-paper-auth {
            background: linear-gradient(135deg, #FFFBF0 0%, #FFF3E0 100%);
            border: none;
            outline: none;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            position: relative;
        }

        @keyframes modalPop {
            0% { transform: scale(0.8) translateY(20px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        /* Animation for Bottom Bar */
        @keyframes bounceUp {
            0% { transform: translate(-50%, 100%); opacity: 0; }
            80% { transform: translate(-50%, -10%); opacity: 1; }
            100% { transform: translate(-50%, 0); opacity: 1; }
        }
        .animate-bounce-up { animation: bounceUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }

        /* Input Styling */
        .input-cute {
            background: #fff;
            border: 2px solid #EEE;
            border-radius: 16px;
            padding: 12px 16px;
            width: 100%;
            outline: none;
            transition: all 0.2s;
            font-size: 0.95rem;
            color: #5D4037;
            font-family: 'Sarabun', sans-serif;
        }
        .input-cute:focus {
            border-color: var(--cute-pink);
            box-shadow: 0 4px 12px rgba(255, 171, 145, 0.2);
            transform: translateY(-1px);
        }
        
        .input-group { position: relative; z-index: 1; }
        .input-group .icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #BCAAA4;
            transition: color 0.2s;
        }
        .input-group:focus-within .icon { color: var(--cute-pink); }
        .input-group input { padding-left: 44px; }

        /* Buttons */
        .btn-cute {
            background: linear-gradient(to right, #6D4C41, #5D4037);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            font-family: 'Mali', cursive;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 4px 10px rgba(93, 64, 55, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-cute:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 20px rgba(93, 64, 55, 0.3);
            filter: brightness(1.1);
        }
        .btn-cute:active { transform: translateY(1px); }

        .btn-cute-outline {
            background: white;
            color: #6D4C41;
            border: 2px solid #EEE;
        }
        .btn-cute-outline:hover {
            border-color: #6D4C41;
            background: #FFF8E1;
        }

        /* --- FANTASY POPUP STYLING (Used by Leaflet and Cesium) --- */
        .leaflet-popup-content-wrapper {
            background: rgba(255, 253, 245, 0.95);
            border-radius: 24px;
            padding: 0;
            overflow: visible;
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.2), 0 4px 10px rgba(0,0,0,0.1);
            border: 2px solid #FFF;
        }
        .leaflet-popup-content { margin: 0 !important; width: 320px !important; }
        .leaflet-popup-tip { background: #FFF; }
        
        /* Custom Cesium Popup */
        #cesium-popup {
            min-width: 320px;
            max-width: 320px;
            pointer-events: auto; /* Allow clicks */
            border-radius: 24px;
            background: rgba(255, 253, 245, 0.95);
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.2), 0 4px 10px rgba(0,0,0,0.1);
            border: 2px solid #FFF;
        }
        #cesium-popup .popup-container {
             /* Reuse the content wrapper style for consistency */
             margin: 0 !important;
             width: 100% !important;
        }
        #cesium-popup .popup-arrow {
            /* Custom arrow for Cesium popup */
            position: absolute;
            bottom: -8px; 
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            width: 16px; 
            height: 16px;
            background: #FFF;
            border-bottom: 2px solid #EEE;
            border-right: 2px solid #EEE;
            z-index: 10;
            pointer-events: none;
        }
        
        /* Sparkle Animation */
        @keyframes floatSparkle {
            0% { transform: translate(0, 0) scale(0); opacity: 0; }
            50% { opacity: 1; transform: translate(10px, -10px) scale(1); }
            100% { transform: translate(20px, -20px) scale(0); opacity: 0; }
        }
        .sparkle-icon {
            position: absolute;
            color: #FFB74D;
            font-size: 10px;
            animation: floatSparkle 2s infinite ease-in-out;
            pointer-events: none;
            z-index: 10;
        }
        .s1 { top: -5px; left: 10%; animation-delay: 0s; }
        .s2 { top: 10px; right: 5%; animation-delay: 0.5s; font-size: 14px; color: #FFD54F; }
        .s3 { bottom: 20%; left: -5px; animation-delay: 1s; font-size: 8px; }

        /* Icon Grid */
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 8px;
        }
        .icon-option {
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #eee; border-radius: 12px;
            cursor: pointer; transition: all 0.2s; background: white;
        }
        .icon-option img { width: 24px; height: 24px; object-fit: contain; }
        .icon-option:hover { background-color: #FFF3E0; border-color: #FFCC80; }
        .icon-option.selected {
            border-color: #6D4C41; background-color: #FFE0B2;
            transform: scale(1.1); box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .icon-category-title {
            font-size: 11px; font-weight: bold; color: #8D6E63;
            margin-top: 8px; margin-bottom: 4px; border-bottom: 1px dashed #D7CCC8; padding-bottom: 2px;
        }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #D7CCC8; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #BCAAA4; }

        /* Color Swatch in Popup */
        .color-tag {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 3px 10px; background: #FFF; border-radius: 12px;
            font-size: 11px; color: #616161; border: 1px solid #F0F0F0;
            font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .swatch-circle {
            width: 12px; height: 12px; border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.1); display: inline-block;
        }

        /* Hierarchy Path in Popup */
        .hierarchy-path {
            font-size: 10px; color: #795548; background-color: #FFF8E1;
            padding: 4px 8px; border-radius: 8px; margin-top: 4px;
            display: flex; flex-wrap: wrap; gap: 4px; align-items: center;
            border: 1px dashed #FFE0B2;
        }
        .h-node::after { content: "‚Ä∫"; margin-left: 4px; color: #BCAAA4; }
        .h-node:last-child::after { content: ""; }
        .h-node:last-child { font-weight: bold; color: #5D4037; }

        /* Cesium Widget Cleanups */
        .cesium-widget-credits { display: none !important; }
        .cesium-viewer-toolbar { display: none !important; }
        .cesium-viewer-animationContainer { display: none !important; }
        .cesium-viewer-timelineContainer { display: none !important; }

        /* Fix for Popups in Edit Mode (Disable pointer events on Map when in edit mode) */
        .leaflet-editing {
            cursor: default !important; /* Reset cursor when handles are active */
        }

        /* Custom style for selected path in edit mode (simulate gold dashed line) */
        /* NOTE: Leaflet Draw uses L.Path.SVG.prototype.setStyles, which overwrites these.
           The main logic must be applied via selectedPathOptions during L.Control.Draw init.
        */
        .leaflet-edit-marker-selected {
            /* This is the class for the vertices, not the path itself */
            border: 2px solid #FFD700 !important;
        }

        /* --- THAI DECREE MODAL STYLING --- */
        .decree-overlay {
            background-color: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(5px);
            transition: opacity 0.5s;
            z-index: 9999;
        }

        .decree-paper {
            background: linear-gradient(145deg, #1A1A1A 0%, #000000 100%);
            border-radius: 20px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.4), 0 0 10px rgba(0,0,0,0.5);
            border: 4px solid #333;
            animation: decreePop 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
            position: relative;
        }

        .decree-paper-coronation {
            background: linear-gradient(160deg, #300000 0%, #600000 50%, #300000 100%);
            border-color: #795548;
            box-shadow: 0 0 50px rgba(255, 165, 0, 0.5), 0 0 10px rgba(0,0,0,0.5);
        }
        
        @keyframes decreePop {
            0% { transform: scale(0.7) translateY(50px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        @keyframes goldPulse {
            0% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFB74D; }
            50% { text-shadow: 0 0 8px #FFF8E1, 0 0 15px #FFD700; }
            100% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFB74D; }
        }

        @keyframes goldSmoke {
            0% { transform: translateY(0) scale(1); opacity: 0.05; }
            50% { opacity: 0.1; }
            100% { transform: translateY(-30px) scale(1.1); opacity: 0.05; }
        }

        .decree-title {
            font-family: 'Mali', cursive;
            color: #FFD700;
            animation: goldPulse 3s infinite;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 20px rgba(255, 183, 77, 0.6);
            font-weight: 700;
        }

        .decree-text {
            font-family: 'Sarabun', sans-serif;
            font-weight: 500;
            color: #FFE0B2;
            text-shadow: 0 0 2px #5D4037;
            line-height: 1.8;
            letter-spacing: 0.5px;
        }
        
        /* Gold Mist Effect */
        .gold-mist::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at center, rgba(255, 215, 0, 0.1) 0%, rgba(0, 0, 0, 0) 70%);
            pointer-events: none;
            animation: goldSmoke 20s infinite alternate-reverse;
        }

        /* Gold Kannon Separator (Simplified with SVG-like line) */
        .kannon-divider {
            height: 3px;
            background: radial-gradient(circle, #FFF8E1 0%, #FFD700 50%, #5D4037 100%);
            border-radius: 3px;
            box-shadow: 0 0 5px #FFD700;
            margin-top: 10px;
            margin-bottom: 20px;
            position: relative;
        }
        
        /* Custom Button */
        .btn-decree {
            background: linear-gradient(to right, #212121, #000000);
            color: #FFD700;
            border: 2px solid #FFD700;
            border-radius: 12px;
            padding: 10px 30px;
            font-family: 'Mali', cursive;
            font-weight: 700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
            transition: all 0.3s;
        }
        .btn-decree:hover {
            box-shadow: 0 0 20px #FFD700, 0 0 5px #FFF8E1;
            transform: scale(1.05);
            background: linear-gradient(to right, #333333, #1A1A1A);
        }
        
    </style>
</head>
<body class="mode-2d">

    <!-- Left Sidebar -->
    <div id="sidebar-left" class="sidebar-left p-5">
        <div class="toggle-sidebar-btn" id="toggle-sidebar">‚óÄ</div>
        
        <!-- Header -->
        <div class="text-center mb-6 pb-4 border-b-2 border-dashed border-[#E0E0E0]">
            <h1 class="text-2xl font-bold text-[#5D4037] drop-shadow-sm mb-2 flex justify-center items-center gap-2">
                <span class="text-3xl">üó∫Ô∏è</span> ‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏£‡∏£‡∏î‡∏¥‡∏ô‡∏§‡∏°‡∏¥‡∏ï‡∏£‡πå
            </h1>
            
            <!-- Auth Status -->
            <div id="auth-container">
                <div id="logged-in-view" class="hidden animate-fade-in">
                    <div class="bg-white/50 rounded-2xl p-3 border border-white shadow-sm mb-2">
                         <p id="user-display-name" class="text-sm font-bold text-[#5D4037]">Lord ...</p>
                         <p id="user-id-display" class="text-[10px] text-gray-500 font-mono">ID: ...</p>
                    </div>
                    <button onclick="window.logoutUser()" class="text-xs text-red-400 hover:text-red-600 font-bold bg-red-50 px-3 py-1 rounded-full transition">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
                <div id="logged-out-view" class="space-y-2 px-2">
                    <button onclick="document.getElementById('modal-login').classList.remove('hidden')" class="btn-cute w-full text-sm py-2"><span class="material-icons-round text-sm">login</span> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button onclick="document.getElementById('modal-register').classList.remove('hidden')" class="btn-cute btn-cute-outline w-full text-sm py-2"><span class="material-icons-round text-sm">person_add</span> ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>

        <!-- NEW: Map Sheet Management -->
        <div class="bg-white/60 p-4 rounded-2xl border border-white shadow-sm transition hover:shadow-md mb-4">
            <h3 class="font-bold text-[#5D4037] mb-3 flex items-center gap-2 text-sm">
                <span class="material-icons-round text-blue-500">article</span> ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (Map Sheet)
            </h3>
            <div class="space-y-3">
                <div class="flex gap-2">
                    <select id="map-sheet-select" class="input-cute cursor-pointer text-sm flex-1" onchange="switchMapSheet(this.value)">
                        <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>
                    </select>
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÄ‡∏•‡πá‡∏Å) -->
                    <button id="btn-delete-map" onclick="confirmDeleteMapSheet()" class="w-10 h-10 rounded-xl bg-red-100 text-red-500 flex items-center justify-center hover:bg-red-200 transition" title="‡∏•‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ" disabled>
                        <span class="material-icons-round text-xl">delete</span>
                    </button>
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° (+) -->
                    <button onclick="document.getElementById('modal-new-map').classList.remove('hidden')" class="w-10 h-10 rounded-xl bg-[#5D4037] text-white flex items-center justify-center hover:bg-[#4E342E] transition" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà">
                        <span class="material-icons-round text-xl">add</span>
                    </button>
                </div>
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß -->
            </div>
        </div>

        <!-- Tools / Filters -->
        <div class="flex-1 overflow-y-auto space-y-4 pr-1 custom-scrollbar">
            <!-- Layer Control -->
            <div class="bg-white/60 p-4 rounded-2xl border border-white shadow-sm transition hover:shadow-md">
                <h3 class="font-bold text-[#5D4037] mb-3 flex items-center gap-2 text-sm">
                    <span class="material-icons-round text-amber-500">layers</span> ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á & ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                </h3>
                <div class="flex gap-2 mb-3 bg-gray-100 p-1 rounded-xl">
                    <button id="btn-map-nolabels" class="flex-1 text-xs py-1.5 rounded-lg bg-white text-[#5D4037] shadow-sm font-bold">‡∏™‡∏∞‡∏≠‡∏≤‡∏î</button>
                    <button id="btn-map-sat" class="flex-1 text-xs py-1.5 rounded-lg text-gray-500 hover:bg-gray-200 transition">‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°</button>
                </div>
                
                <div class="space-y-2 pl-1">
                     <div class="flex items-center">
                        <input type="checkbox" id="toggle-roads" checked class="accent-[#5D4037] mr-2 h-4 w-4 rounded cursor-pointer">
                        <label for="toggle-roads" class="text-sm cursor-pointer select-none text-[#5D4037] font-medium">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á/‡∏ñ‡∏ô‡∏ô</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="toggle-created-labels" checked class="accent-[#5D4037] mr-2 h-4 w-4 rounded cursor-pointer">
                        <label for="toggle-created-labels" class="text-sm cursor-pointer select-none text-gray-600">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</label>
                    </div>
                     <!-- NEW RANK LABEL TOGGLE -->
                    <div class="flex items-center">
                        <input type="checkbox" id="toggle-created-rank" checked class="accent-[#5D4037] mr-2 h-4 w-4 rounded cursor-pointer">
                        <label for="toggle-created-rank" class="text-sm cursor-pointer select-none text-gray-600">‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô)</label>
                    </div>
                     <!-- END NEW RANK LABEL TOGGLE -->
                    <div class="flex items-center">
                        <input type="checkbox" id="toggle-compass" checked class="accent-[#5D4037] mr-2 h-4 w-4 rounded cursor-pointer">
                        <label for="toggle-compass" class="text-sm cursor-pointer select-none text-gray-600">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏Ç‡πá‡∏°‡∏ó‡∏¥‡∏®</label>
                    </div>
                </div>
                
                <div class="mt-4 border-t border-gray-100 pt-3">
                    <div class="flex justify-between text-xs font-bold text-gray-400 mb-1">
                        <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</span>
                        <span id="opacity-val">60%</span>
                    </div>
                    <input type="range" id="opacity-slider" min="0" max="1" step="0.05" value="0.6" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-[#5D4037]">
                </div>

                <div class="mt-3">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold text-[#5D4037]">‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</span>
                        <div class="flex items-center gap-2 bg-white px-2 py-1 rounded border border-gray-200">
                            <input type="color" id="global-stroke-color" value="#5D4037" class="w-6 h-6 border-0 p-0 rounded cursor-pointer bg-transparent">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="bg-white/60 p-4 rounded-2xl border border-white shadow-sm transition hover:shadow-md">
                <h3 class="font-bold text-[#5D4037] mb-3 flex items-center gap-2 text-sm">
                    <span class="material-icons-round text-blue-400">filter_alt</span> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ & ‡∏Å‡∏£‡∏≠‡∏á
                </h3>
                <div class="input-group mb-3">
                    <span class="material-icons-round icon">search</span>
                    <input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á, ‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå..." class="input-cute py-2 text-sm">
                </div>
                
                <div class="mb-3">
                     <div class="font-bold text-[#8D6E63] text-[11px] uppercase tracking-wider mb-2 flex justify-between items-center">
                         <span>‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</span>
                         <button onclick="toggleAllLevels(true)" class="text-[9px] text-blue-500 hover:underline">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                     </div>
                     <div id="filter-levels-container" class="grid grid-cols-1 gap-1 max-h-40 overflow-y-auto custom-scrollbar pl-1"></div>
                </div>

                <!-- Status Filter -->
                <div class="mb-1 border-t border-dashed border-gray-200 pt-2 mt-2">
                     <div class="font-bold text-[#8D6E63] text-[11px] uppercase tracking-wider mb-2 flex justify-between items-center">
                         <span>‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
                         <button onclick="toggleAllStatuses(true)" class="text-[9px] text-blue-500 hover:underline">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                     </div>
                     <div class="grid grid-cols-2 gap-1 pl-1">
                        <label class="flex items-center text-xs cursor-pointer hover:bg-white/50 p-1 rounded"><input type="checkbox" checked class="filter-status accent-[#5D4037] mr-2" value="independent"> üïäÔ∏è ‡∏£‡∏±‡∏ê‡∏≠‡∏¥‡∏™‡∏£‡∏∞</label>
                        <label class="flex items-center text-xs cursor-pointer hover:bg-white/50 p-1 rounded"><input type="checkbox" checked class="filter-status accent-[#5D4037] mr-2" value="annexed"> üè≥Ô∏è ‡∏ñ‡∏π‡∏Å‡∏ú‡∏ô‡∏ß‡∏Å</label>
                        <label class="flex items-center text-xs cursor-pointer hover:bg-white/50 p-1 rounded"><input type="checkbox" checked class="filter-status accent-[#5D4037] mr-2" value="vassal"> üõ°Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä</label>
                        <label class="flex items-center text-xs cursor-pointer hover:bg-white/50 p-1 rounded"><input type="checkbox" checked class="filter-status accent-[#5D4037] mr-2" value="colony"> ‚öì ‡∏≠‡∏≤‡∏ì‡∏≤‡∏ô‡∏¥‡∏Ñ‡∏°</label>
                     </div>
                </div>
            </div>

            <!-- Color Modes -->
            <div class="bg-white/60 p-4 rounded-2xl border border-white shadow-sm transition hover:shadow-md">
                <h3 class="font-bold text-[#5D4037] mb-2 flex items-center gap-2 text-sm">
                    <span class="material-icons-round text-pink-400">palette</span> ‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏µ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                </h3>
                <select id="color-mode-select" class="input-cute text-sm cursor-pointer py-2">
                    <option value="entity">‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏õ‡∏Å‡∏ï‡∏¥)</option>
                    <option value="religion">‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏®‡∏≤‡∏™‡∏ô‡∏≤</option>
                    <option value="government">‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏≠‡∏ö‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</option>
                    <option value="rank">‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô)</option>
                </select>
            </div>

            <!-- New Credit Section -->
            <div class="mt-6 pt-4 border-t border-dashed border-[#E0E0E0] text-center opacity-70 pb-4">
                <div class="text-[10px] text-[#8D6E63] font-mono">‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢</div>
                <div class="text-sm font-bold text-[#5D4037] mt-1">‡∏ô‡∏≤‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏´‡∏°‡∏≤‡∏¢‡∏°‡∏±‡πà‡∏ô</div>
            </div>
        </div>
    </div>

    <!-- Compass UI -->
    <div id="compass" class="compass-container" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏¥‡∏®‡πÄ‡∏´‡∏ô‡∏∑‡∏≠">
        <img src="https://api.iconify.design/noto:compass.svg" class="compass-img" id="compass-icon">
    </div>
    <div class="compass-tooltip">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠ Reset ‡∏ó‡∏¥‡∏®</div>

    <!-- Vertical Toolbar -->
    <div class="toolbar-vertical">
        <!-- New Draw Menu Group -->
        <div class="tool-group">
            <div id="draw-submenu" class="tool-submenu">
                <!-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô startFreehandMode() ‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏î‡πÅ‡∏ö‡∏ö Polygon ‡∏≠‡∏¥‡∏™‡∏£‡∏∞ -->
                <div class="tool-btn tool-btn-sub" onclick="startFreehandMode()" title="‡∏ß‡∏≤‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤ (‡∏≠‡∏¥‡∏™‡∏£‡∏∞)">
                    <span class="material-icons-round text-amber-800">edit</span>
                </div>
                <!-- ‡∏ß‡∏≤‡∏î‡πÅ‡∏ö‡∏ö‡∏à‡∏∏‡∏î (Point-to-Point Polygon) -->
                <div class="tool-btn tool-btn-sub" onclick="startPointMode()" title="‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏à‡∏∏‡∏î (‡∏ó‡∏µ‡∏•‡∏∞‡∏à‡∏∏‡∏î)">
                    <span class="material-icons-round text-blue-600">timeline</span>
                </div>
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á -->
                <div id="btn-edit-geom" class="tool-btn tool-btn-sub" onclick="toggleEditGeometry()" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á (‡∏î‡∏∂‡∏á‡πÄ‡∏™‡πâ‡∏ô/‡∏Ç‡∏¢‡∏≤‡∏¢)">
                    <span class="material-icons-round text-pink-600">architecture</span>
                </div>
            </div>
            
            <div class="tool-btn" onclick="toggleDrawMenu()" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö)">
                <span class="material-icons-round text-emerald-500">terrain</span>
            </div>
        </div>

        <div class="tool-btn" onclick="checkModeAndDraw('polyline')" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á">
            <span class="material-icons-round text-amber-700">alt_route</span>
        </div>
        <div class="tool-btn" onclick="checkModeAndDraw('marker')" title="‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î">
            <span class="material-icons-round text-rose-500">place</span>
        </div>
        
        <!-- Feature ‡πÉ‡∏´‡∏°‡πà: Multi-Select / Union -->
        <div class="h-px bg-white/50 mx-2 my-1"></div>
        <div class="tool-btn" id="btn-multi-select" onclick="toggleMultiSelectMode()" title="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏£‡∏ß‡∏°/‡∏¢‡∏∂‡∏î)">
            <span class="material-icons-round text-purple-600">playlist_add_check</span>
        </div>
        
        <div class="h-px bg-white/50 mx-2 my-1"></div>
        <div class="tool-btn" onclick="toggleFullScreen()" title="‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠">
            <span class="material-icons-round text-gray-600">fullscreen</span>
        </div>
    </div>

    <!-- Map Area -->
    <div id="map-container">
        <div id="map"></div>
        <div id="cesiumContainer"></div>
        
        <!-- CUSTOM CESIUM POPUP (‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô Popup ‡∏Ç‡∏≠‡∏á Leaflet) -->
        <div id="cesium-popup" class="absolute hidden bg-white rounded-2xl shadow-2xl z-[2000] w-[320px] pointer-events-auto transition-opacity duration-200 border-2 border-white/50" onclick="document.getElementById('cesium-popup').classList.add('hidden')">
            <div id="cesium-popup-content" class="popup-container"></div>
            <div class="popup-arrow"></div> 
        </div>
    </div>

    <!-- Globe Toggle -->
    <div class="globe-toggle-btn" onclick="toggleGlobeMode()">
        <img src="https://api.iconify.design/noto:globe-showing-asia-australia.svg" id="globe-btn-icon">
    </div>
    <div class="globe-tooltip">‡∏™‡∏•‡∏±‡∏ö 2D / 3D</div>

    <!-- Selection Action Bar (NEW UI) -->
    <div id="selection-bar" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white/95 backdrop-blur px-6 py-3 rounded-2xl shadow-2xl z-[2000] hidden border border-purple-100 flex items-center gap-4 animate-bounce-up">
        <div class="text-[#5D4037]">
            <span class="text-xs font-bold text-gray-400 block">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>
            <div class="flex items-baseline gap-1">
                <span class="text-xl font-bold cute-font text-purple-600" id="selection-count">0</span>
                <span class="text-xs">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</span>
            </div>
        </div>
        <div class="h-8 w-px bg-gray-200"></div>
        <button onclick="openUnionModal()" class="btn-cute bg-gradient-to-r from-purple-600 to-indigo-600 text-white text-sm py-2 px-4 shadow-lg hover:shadow-purple-200">
            <span class="material-icons-round text-base">account_balance</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô
        </button>
        <button onclick="toggleMultiSelectMode()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 hover:bg-red-100 hover:text-red-500 flex items-center justify-center transition">
            <span class="material-icons-round text-sm">close</span>
        </button>
    </div>

    <!-- Legend Box -->
    <div id="legend-box" class="fixed bottom-6 right-32 bg-white/90 backdrop-blur p-4 rounded-2xl shadow-xl z-[900] hidden border border-white max-w-[200px] animate-fade-up">
        <div class="flex justify-between items-center mb-2 border-b border-gray-100 pb-2">
            <h4 class="font-bold text-[#5D4037] text-xs" id="legend-title">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏µ</h4>
            <button onclick="document.getElementById('legend-box').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><span class="material-icons-round text-sm">close</span></button>
        </div>
        <div id="legend-content" class="space-y-1.5 text-[11px]"></div>
    </div>

    <!-- Modal: Login -->
    <div id="modal-login" class="fixed inset-0 modal-overlay hidden z-[3000] flex items-center justify-center">
        <div class="modal-paper modal-paper-auth w-[380px] p-8">
            <button onclick="closeModal('modal-login')" class="absolute top-4 right-4 text-gray-400 hover:text-rose-500 transition z-10"><span class="material-icons-round">close</span></button>
            <div class="relative z-10 text-center">
                <div class="w-20 h-20 bg-white rounded-full mx-auto mb-4 flex items-center justify-center shadow-lg border-4 border-[#FFF3E0]">
                    <span class="material-icons-round text-4xl text-[#5D4037]">lock_open</span>
                </div>
                <h2 class="text-2xl text-[#5D4037] font-bold mb-1 cute-font">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤!</h2>
                <p class="text-gray-500 text-xs mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡πÅ‡∏´‡πà‡∏á‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                <form id="form-login" class="space-y-4">
                    <div class="input-group"><span class="material-icons-round icon">person</span><input type="text" id="login-username" class="input-cute" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ"></div>
                    <div class="input-group"><span class="material-icons-round icon">vpn_key</span><input type="password" id="login-password" class="input-cute" required placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"></div>
                    <button type="submit" class="btn-cute w-full mt-2 shadow-lg hover:shadow-xl">‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏°‡∏¥‡∏ï‡∏¥</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Register -->
    <div id="modal-register" class="fixed inset-0 modal-overlay hidden z-[3000] flex items-center justify-center">
        <div class="modal-paper modal-paper-auth w-[420px] p-8 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <button onclick="closeModal('modal-register')" class="absolute top-4 right-4 text-gray-400 hover:text-rose-500 transition z-10"><span class="material-icons-round">close</span></button>
            <div class="relative z-10">
                <h2 class="text-2xl text-[#5D4037] font-bold mb-6 text-center cute-font">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
                <form id="form-register" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏ä‡∏∑‡πà‡∏≠</label><input type="text" id="reg-firstname" class="input-cute" required></div>
                        <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="reg-lastname" class="input-cute" required></div>
                    </div>
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><div class="input-group"><span class="material-icons-round icon">email</span><input type="email" id="reg-email" class="input-cute" required placeholder="hello@example.com"></div></div>
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label><div class="input-group"><span class="material-icons-round icon">face</span><input type="text" id="reg-username" class="input-cute" required placeholder="Display Name"></div></div>
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><div class="input-group"><span class="material-icons-round icon">lock</span><input type="password" id="reg-password" class="input-cute" required placeholder="******"></div></div>
                    <button type="submit" class="btn-cute w-full mt-4 bg-gradient-to-r from-emerald-600 to-teal-600">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Create/Edit Area -->
    <div id="modal-area" class="fixed inset-0 modal-overlay hidden z-[2000] flex items-center justify-center">
        <div class="modal-paper w-full max-w-2xl p-6 relative max-h-[90vh] overflow-y-auto">
            <button onclick="cancelDraw()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition border-2 border-transparent hover:border-red-200 rounded-full w-8 h-8 flex items-center justify-center" title="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á"><span class="material-icons-round text-2xl">close</span></button>
            <h2 class="text-2xl text-[#5D4037] font-bold mb-6 flex items-center gap-2 border-b border-dashed border-[#E0E0E0] pb-3 cute-font"><span class="material-icons-round text-3xl text-amber-400">edit_location_alt</span><span id="modal-title">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Ç‡∏ï‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</span></h2>
            <form id="form-area" class="space-y-5">
                <input type="hidden" id="area-id">
                <div class="flex gap-6 items-start">
                    <div class="flex-shrink-0 flex flex-col items-center w-28">
                        <div class="relative group cursor-pointer w-24 h-24 rounded-full overflow-hidden border-4 border-white shadow-md bg-gray-50" onclick="document.getElementById('inp-flag').click()">
                            <img id="preview-flag" src="" class="w-full h-full object-cover hidden transition group-hover:brightness-90">
                            <div id="preview-flag-placeholder" class="w-full h-full flex flex-col items-center justify-center text-gray-300 group-hover:bg-gray-100 transition"><span class="material-icons-round text-3xl">add_photo_alternate</span><span class="text-[10px] mt-1">‡∏£‡∏π‡∏õ‡∏ò‡∏á/‡∏ï‡∏£‡∏≤</span></div>
                        </div>
                        <input type="file" id="inp-flag" class="hidden" accept="image/*">
                    </div>
                    <div class="flex-grow space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</label><input type="text" id="inp-name" class="input-cute font-bold text-[#5D4037]" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏Ñ‡∏£‡∏î‡∏£‡∏≤‡∏Å‡πâ‡∏≠‡∏ô"></div>
                            <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏£‡∏´‡∏±‡∏™ (ID)</label><input type="text" id="inp-custom-id" class="input-cute font-mono text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ZONE-01"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå</label><select id="inp-level" class="input-cute cursor-pointer"></select></div>
                             <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡πÄ‡∏Ç‡∏ï‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÅ‡∏°‡πà</label><select id="inp-parent" class="input-cute text-sm cursor-pointer"><option value="">-- ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞ / ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î --</option></select></div>
                        </div>
                         <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</label><input type="text" id="inp-ruler" class="input-cute" required></div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4 pt-2">
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏®‡∏≤‡∏™‡∏ô‡∏≤</label><select id="inp-religion" class="input-cute text-sm"><option>‡∏û‡∏∏‡∏ó‡∏ò</option><option>‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå</option><option>‡∏≠‡∏¥‡∏™‡∏•‡∏≤‡∏°</option><option>‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏ì‡πå‡∏Æ‡∏¥‡∏ô‡∏î‡∏π</option><option>‡∏®‡∏≤‡∏™‡∏ô‡∏≤‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°</option></select></div>
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏£‡∏∞‡∏ö‡∏≠‡∏ö‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</label><select id="inp-gov" class="input-cute text-sm"><option>‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå</option><option>‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ò‡∏¥‡∏õ‡πÑ‡∏ï‡∏¢</option><option>‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ß‡∏ô‡∏¥‡∏™‡∏ï‡πå</option><option>‡∏õ‡∏£‡∏¥‡∏°‡∏¥‡∏ï‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå</option></select></div>
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</label><div class="flex gap-2 mt-1"><label class="flex-1 flex items-center justify-center gap-1 cursor-pointer py-2 rounded-xl border border-gray-200 bg-white hover:bg-amber-50 transition"><input type="radio" name="areaType" value="land" checked class="accent-[#5D4037]"> <span class="text-xs font-bold">‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô</span></label><label class="flex-1 flex items-center justify-center gap-1 cursor-pointer py-2 rounded-xl border border-gray-200 bg-white hover:bg-blue-50 transition"><input type="radio" name="areaType" value="water" class="accent-[#2980B9]"> <span class="text-xs font-bold text-blue-600">‡∏ô‡πà‡∏≤‡∏ô‡∏ô‡πâ‡∏≥</span></label></div></div>
                </div>
                <div class="pt-4 grid grid-cols-2 gap-4 border-t border-dashed border-[#E0E0E0] mt-4">
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏Ç‡∏ï</label><div class="flex items-center gap-2 bg-white p-2 rounded-xl border border-gray-200"><input type="color" id="inp-color" class="w-10 h-8 border-0 rounded cursor-pointer bg-transparent"><span class="text-xs text-gray-500">‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡πà‡∏á‡πÅ‡∏¢‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</span></div></div>
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</label><div class="flex items-center gap-2 bg-white p-2 rounded-xl border border-gray-200"><input type="color" id="inp-label-color" class="w-10 h-8 border-0 rounded cursor-pointer bg-transparent" value="#4E342E"><span class="text-xs text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span></div></div>
                </div>
                <div class="flex justify-end items-center mt-6 gap-3">
                    <button type="button" onclick="cancelDraw()" class="px-5 py-2 text-gray-500 hover:text-gray-700 font-bold rounded-xl hover:bg-gray-100 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn-cute"><span class="material-icons-round text-sm">save</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal: Road -->
    <div id="modal-road" class="fixed inset-0 modal-overlay hidden z-[2000] flex items-center justify-center">
        <div class="modal-paper w-96 p-6 relative">
            <button onclick="cancelDraw()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition"><span class="material-icons-round">close</span></button>
            <h3 class="text-xl font-bold text-[#5D4037] mb-4 flex items-center gap-2 cute-font"><span class="material-icons-round text-amber-700">add_road</span> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</h3>
            <div class="space-y-3">
                <input type="hidden" id="road-id-hidden">
                <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</label><input type="text" id="road-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏ô‡∏ô / ‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏ß‡∏á..." class="input-cute"></div>
                <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="road-type" class="input-cute bg-white"><option value="trade">‡∏ñ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏∂‡∏ö)</option><option value="army">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏±‡∏û (‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞)</option></select></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</label><input type="color" id="road-color" value="#5D4037" class="w-full h-10 rounded-lg cursor-pointer border-2 border-white shadow-sm"></div>
                    <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤: <span id="road-weight-val">4</span></label><input type="range" id="road-weight" min="1" max="15" value="4" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-[#5D4037] mt-2"></div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="cancelDraw()" class="px-4 py-2 text-gray-500 text-sm font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveRoad()" class="btn-cute text-sm px-6">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <!-- Modal Marker -->
    <div id="modal-marker" class="fixed inset-0 modal-overlay hidden z-[2000] flex items-center justify-center">
        <div class="modal-paper w-[500px] p-6 relative max-h-[90vh] overflow-y-auto">
            <button onclick="cancelDraw()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition"><span class="material-icons-round">close</span></button>
            <h3 class="text-xl font-bold text-[#5D4037] mb-4 flex items-center gap-2 cute-font"><span class="material-icons-round text-rose-500">place</span> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</h3>
            <div class="space-y-4">
                <div class="input-group"><span class="material-icons-round icon">edit</span><input type="text" id="marker-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..." class="input-cute font-bold text-[#5D4037]"></div>
                
                <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <label class="text-xs font-bold text-[#8D6E63] ml-1 mb-2 block">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏î‡πà‡∏ß‡∏ô (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå)</label>
                    <div id="quick-icons-container" class="h-48 overflow-y-auto custom-scrollbar p-1 icon-grid"></div>
                </div>

                <div class="bg-white p-3 rounded-xl border border-gray-200">
                    <label class="text-[10px] font-bold text-gray-400 ml-1 mb-1 block">‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (Iconify)</label>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="icon-search-query" placeholder="‡πÄ‡∏ä‡πà‡∏ô dragon, sword, magic..." class="input-cute text-sm py-1.5 px-3">
                        <button onclick="searchIcons()" class="bg-[#5D4037] text-white rounded-xl px-3 hover:bg-[#4E342E]"><span class="material-icons-round">search</span></button>
                    </div>
                    <div id="icon-results" class="flex gap-2 overflow-x-auto pb-2 custom-scrollbar min-h-[40px]"></div>
                </div>

                <div><label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏™‡∏µ‡∏´‡∏°‡∏∏‡∏î</label><input type="color" id="marker-color" value="#E53935" class="w-full h-8 rounded-lg cursor-pointer border-2 border-white shadow-sm"></div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="cancelDraw()" class="px-4 py-2 text-gray-500 text-sm font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveMarker()" class="btn-cute text-sm px-6">‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="modal-confirm" class="fixed inset-0 modal-overlay hidden z-[3000] flex items-center justify-center">
        <div class="modal-paper w-80 p-6 text-center transform scale-100 transition-all">
            <div class="w-12 h-12 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-3"><span class="material-icons-round text-2xl">priority_high</span></div>
            <h3 class="text-lg font-bold text-[#5D4037] mb-2 cute-font" id="confirm-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</h3>
            <p class="text-sm text-gray-600 mb-6" id="confirm-msg">...</p>
            <div class="flex gap-2 justify-center">
                <button class="px-4 py-2 rounded-xl bg-gray-100 text-gray-600 text-sm font-bold hover:bg-gray-200 transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="executePendingConfirm()" class="px-4 py-2 rounded-xl bg-[#5D4037] text-white text-sm font-bold hover:bg-[#4E342E] shadow-lg transition">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>
    
    <!-- War Room Modal (Single Target) -->
    <div id="modal-war" class="fixed inset-0 modal-overlay hidden z-[2100] flex items-center justify-center">
        <div class="modal-paper w-96 p-6 relative">
            <button onclick="closeModal('modal-war')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition"><span class="material-icons-round">close</span></button>
            <h3 class="text-xl font-bold text-red-800 mb-4 flex items-center gap-2 border-b border-red-200 pb-2 cute-font"><span class="material-icons-round">sports_kabaddi</span> ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°</h3>
            <div class="space-y-4">
                <div class="bg-red-50 p-3 rounded-xl border border-red-100"><label class="text-xs font-bold text-red-700 block mb-1">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label><div id="war-target-name" class="font-bold text-gray-800 text-lg">---</div><input type="hidden" id="war-target-id"></div>
                <div class="text-center text-gray-300 font-bold text-xl my-1">VS</div>
                <div>
                    <label class="text-xs font-bold text-[#5D4037] block mb-1 ml-2">‡∏ù‡πà‡∏≤‡∏¢‡∏£‡∏∏‡∏Å (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)</label>
                    <div class="input-group mb-2">
                        <span class="material-icons-round icon">search</span>
                        <input type="text" id="war-attacker-search" oninput="filterAttackerOptions()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏∏‡∏Å‡∏£‡∏≤‡∏ô..." class="input-cute py-2 text-sm">
                    </div>
                    <select id="war-attacker-select" class="input-cute w-full bg-white cursor-pointer"></select>
                </div>
            </div>
            <div class="mt-6">
                <label class="text-xs font-bold text-gray-500 block mb-2 text-center">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</label>
                <div class="grid grid-cols-3 gap-2" id="war-actions-container">
                    <!-- Updated to 3 columns, removing Split Territory button -->
                    <button id="btn-annex" onclick="confirmWarAction('annex')" class="py-2 rounded-xl bg-red-500 text-white text-xs font-bold hover:bg-red-600 shadow transition flex flex-col items-center gap-1"><span class="material-icons-round text-base">flag</span> ‡∏ú‡∏ô‡∏ß‡∏Å</button>
                    <button id="btn-vassal" onclick="confirmWarAction('vassal')" class="py-2 rounded-xl bg-purple-500 text-white text-xs font-bold hover:bg-purple-600 shadow transition flex flex-col items-center gap-1"><span class="material-icons-round text-base">security</span> ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä</button>
                    <button id="btn-colony" onclick="confirmWarAction('colony')" class="py-2 rounded-xl bg-blue-500 text-white text-xs font-bold hover:bg-blue-600 shadow transition flex flex-col items-center gap-1"><span class="material-icons-round text-base">public</span> ‡∏≠‡∏≤‡∏ì‡∏≤‡∏ô‡∏¥‡∏Ñ‡∏°</button>
                    
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: The Grand Unification (New Feature) -->
    <div id="modal-union" class="fixed inset-0 modal-overlay hidden z-[3000] flex items-center justify-center">
        <div class="modal-paper w-[600px] p-0 overflow-hidden">
            <!-- Header Tabs -->
            <div class="flex bg-gray-50 border-b border-gray-200">
                <button onclick="switchUnionTab('merge')" id="tab-merge" class="flex-1 py-4 text-sm font-bold text-[#5D4037] border-b-2 border-[#5D4037] bg-white transition flex items-center justify-center gap-2">
                    <span class="material-icons-round text-amber-500">category</span> ‡∏´‡∏•‡∏≠‡∏°‡∏£‡∏ß‡∏° (Destructive)
                </button>
                <button onclick="switchUnionTab('elevate')" id="tab-elevate" class="flex-1 py-4 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:bg-gray-100 transition flex items-center justify-center gap-2">
                    <span class="material-icons-round text-blue-500">compare_arrows</span> ‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (Non-Destructive)
                </button>
                <button onclick="switchUnionTab('annex')" id="tab-annex" class="flex-1 py-4 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:bg-gray-100 transition flex items-center justify-center gap-2">
                    <span class="material-icons-round text-red-500">flag</span> ‡∏ú‡∏ô‡∏ß‡∏Å/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á
                </button>
            </div>

            <div class="p-6">
                <!-- Content: Merge (Destructive) -->
                <div id="content-merge" class="space-y-4">
                    <div class="bg-amber-50 p-3 rounded-xl border border-amber-100 text-xs text-amber-800">
                        <span class="font-bold">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:</span> ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏Ç‡∏ï‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô <b>1 ‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡πÉ‡∏´‡∏°‡πà</b> (Polygon ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) ‡πÅ‡∏•‡∏∞ <b>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö</b>
                    </div>
                    <form id="form-merge" onsubmit="executeMerge(event)">
                        <div class="space-y-3">
                            <div><label class="text-xs font-bold text-[#8D6E63] ml-2">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡πÉ‡∏´‡∏°‡πà</label><input type="text" id="merge-name" class="input-cute" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏´‡∏£‡∏≤‡∏ä‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£..."></div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs font-bold text-[#8D6E63] ml-2">‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</label><input type="text" id="merge-ruler" class="input-cute" required></div>
                                <div><label class="text-xs font-bold text-[#8D6E63] ml-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå</label><select id="merge-level" class="input-cute"></select></div>
                            </div>
                            <div><label class="text-xs font-bold text-[#8D6E63] ml-2">‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏Ç‡∏ï</label><input type="color" id="merge-color" class="w-full h-10 rounded-lg cursor-pointer border-2 border-white shadow-sm"></div>
                        </div>
                        <button type="submit" class="btn-cute w-full mt-6 bg-gradient-to-r from-amber-600 to-orange-600">‚ú® ‡∏£‡πà‡∏≤‡∏¢‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏´‡∏•‡∏≠‡∏°‡∏£‡∏ß‡∏°</button>
                    </form>
                </div>

                <!-- Content: Elevate (Non-Destructive Merge) -->
                 <div id="content-elevate" class="hidden space-y-4">
                    <div id="elevate-message-container">
                        <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-xs text-blue-800">
                            <span class="font-bold">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:</span> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏° **‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà** ‡πÅ‡∏ï‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô **‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡πÅ‡∏°‡πà‡πÉ‡∏´‡∏°‡πà** (‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô)
                            <div class="mt-2 text-gray-600 font-normal">‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Ç‡∏ï‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏¢‡πà‡∏≠‡∏¢‡∏´‡∏•‡∏≤‡∏¢‡∏´‡∏ô‡πà‡∏ß‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏ß‡∏°‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô *‡πÅ‡∏Ç‡∏ß‡∏á*</div>
                        </div>
                    </div>
                    <form id="form-elevate" onsubmit="executeAreaElevation(event)">
                        <div class="space-y-3">
                            <div><label class="text-xs font-bold text-[#8D6E63] ml-2">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏ï‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÅ‡∏°‡πà‡πÉ‡∏´‡∏°‡πà</label><input type="text" id="elevate-name" class="input-cute" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏Ç‡∏ß‡∏á‡∏°‡∏±‡∏á‡∏Å‡∏£, ‡πÅ‡∏Ç‡∏ß‡∏á‡πÑ‡∏Å‡πà"></div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs font-bold text-[#8D6E63] ml-2">‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</label><input type="text" id="elevate-ruler" class="input-cute" required></div>
                                <div><label class="text-xs font-bold text-[#8D6E63] ml-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡πÉ‡∏´‡∏°‡πà</label><select id="elevate-level" class="input-cute"></select></div>
                            </div>
                            <div><label class="text-xs font-bold text-[#8D6E63] ml-2">‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏Ç‡∏ï</label><input type="color" id="elevate-color" class="w-full h-10 rounded-lg cursor-pointer border-2 border-white shadow-sm"></div>
                        </div>
                        <button type="submit" id="btn-elevate-submit" class="btn-cute w-full mt-6 bg-gradient-to-r from-blue-600 to-cyan-600"><span class="material-icons-round text-sm">auto_graph</span> ‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</button>
                    </form>
                </div>

                <!-- Content: Annex -->
                <div id="content-annex" class="hidden space-y-4">
                    <div class="bg-red-50 p-3 rounded-xl border border-red-100 text-xs text-red-800">
                        <span class="font-bold">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:</span> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πà‡∏≠‡∏¢‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏°‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏Ç‡∏ï ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° <b>"‡∏ú‡∏π‡πâ‡∏ô‡∏≥"</b> ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-bold text-[#8D6E63] ml-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥ (Conqueror)</label>
                            <select id="annex-leader-select" class="input-cute w-full bg-white cursor-pointer"></select>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 pt-2">
                            <button onclick="executeAnnex('annex')" class="p-3 rounded-xl border-2 border-red-100 hover:border-red-500 bg-white hover:bg-red-50 transition text-center group col-span-1">
                                <span class="material-icons-round text-2xl text-red-400 group-hover:text-red-600 block mb-1">gavel</span>
                                <div class="text-xs font-bold text-gray-600">‡∏ú‡∏ô‡∏ß‡∏Å‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô</div>
                                <div class="text-[10px] text-gray-400">(‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)</div>
                            </button>
                            <button onclick="executeAnnex('vassal')" class="p-3 rounded-xl border-2 border-purple-100 hover:border-purple-500 bg-white hover:bg-purple-50 transition text-center group col-span-1">
                                <span class="material-icons-round text-2xl text-purple-400 group-hover:text-purple-600 block mb-1">security</span>
                                <div class="text-xs font-bold text-gray-600">‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä</div>
                                <div class="text-[10px] text-gray-400">(‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô)</div>
                            </button>
                             <button onclick="executeAnnex('colony')" class="p-3 rounded-xl border-2 border-blue-100 hover:border-blue-500 bg-white hover:bg-blue-50 transition text-center group col-span-1">
                                <span class="material-icons-round text-2xl text-blue-400 group-hover:text-blue-600 block mb-1">public</span>
                                <div class="text-xs font-bold text-gray-600">‡∏≠‡∏≤‡∏ì‡∏≤‡∏ô‡∏¥‡∏Ñ‡∏°</div>
                                <div class="text-[10px] text-gray-400">(‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á)</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="closeModal('modal-union')" class="absolute top-2 right-2 text-gray-400 hover:text-red-500"><span class="material-icons-round">close</span></button>
        </div>
    </div>
    
    <!-- Modal: New Map Sheet -->
    <div id="modal-new-map" class="fixed inset-0 modal-overlay hidden z-[3000] flex items-center justify-center">
        <div class="modal-paper w-96 p-6 relative">
            <button onclick="closeModal('modal-new-map')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition"><span class="material-icons-round">close</span></button>
            <h3 class="text-xl font-bold text-[#5D4037] mb-4 flex items-center gap-2 cute-font"><span class="material-icons-round text-blue-500">add_to_photos</span> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà</h3>
            <form id="form-new-map" onsubmit="createNewMapSheet(event)">
                <label class="text-xs font-bold text-[#8D6E63] ml-2 mb-1 block">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</label>
                <input type="text" id="new-map-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ú‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å, ‡∏¢‡∏∏‡∏Ñ‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°..." class="input-cute mb-4" required>
                <button type="submit" class="btn-cute w-full">‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
            </form>
        </div>
    </div>

    <!-- NEW DECREE MODAL - Generalized for Fusion, Coronation, and Appointment -->
    <div id="modal-decree" class="fixed inset-0 decree-overlay hidden flex items-center justify-center" onclick="closeModal('modal-decree')">
        <div id="decree-paper" class="decree-paper w-full max-w-lg p-8 relative gold-mist" onclick="event.stopPropagation()">
            
            <!-- Header/Emblem -->
            <div class="text-center mb-6 relative">
                <div class="w-24 h-24 mx-auto mb-4 relative z-10">
                    <div id="decree-emblem" class="w-full h-full rounded-full border-4 border-[#FFD700] p-1 shadow-[0_0_15px_rgba(255,215,0,0.8)] flex items-center justify-center bg-black/50">
                        <span class="material-icons-round text-6xl text-[#FFD700] rotate-45 opacity-80" style="text-shadow: 0 0 10px #FFD700;">satellite_alt</span>
                    </div>
                </div>
                
                <!-- Title: Rank + Name Collapse -->
                <h2 id="decree-title-text" class="text-3xl decree-title pt-2 mb-4 drop-shadow-lg">
                    {Title}
                </h2>

                <!-- Curved Gold Separator -->
                <div class="kannon-divider w-3/4 mx-auto"></div>
            </div>

            <!-- Decree Content -->
            <div class="decree-text text-center text-sm space-y-4 px-4 overflow-y-auto max-h-80 custom-scrollbar">
                <div class="text-base font-bold text-[#FFB74D]" id="decree-intro">
                    ‡πÇ‡∏î‡∏¢‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏´‡πà‡∏á‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô
                </div>
                <div id="decree-main-content">
                    <!-- Dynamic Content will be injected here -->
                </div>
            </div>
            
            <!-- Footer Button -->
            <div class="mt-8 text-center">
                <button onclick="closeModal('modal-decree')" class="btn-decree">
                    ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö
                </button>
                <div class="text-[10px] text-gray-600 mt-2">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î</div>
            </div>
        </div>
    </div>
    <!-- END DECREE MODAL -->

    <!-- Firebase SDK & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, onSnapshot, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('Debug');

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAaHROgav2BOEsqTZRNhTVdJPSKZoYoIVI",
            authDomain: "map2-d18dc.firebaseapp.com",
            projectId: "map2-d18dc",
            storageBucket: "map2-d18dc.firebasestorage.app",
            appId: "1:993020770694:web:281b572e2170f7f1209407"
        };
        const appId = firebaseConfig.projectId || "map2-d18dc";

        // Globals
        let db, auth, userId;
        let map, drawnItems; // Leaflet
        let viewer; // Cesium
        
        // ** NEW GLOBALS FOR EDIT MODE **
        let isEditMode = false;     // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°
        let editingLayer = null;    // ‡πÄ‡∏Å‡πá‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Layer ‡πÑ‡∏´‡∏ô‡∏≠‡∏¢‡∏π‡πà
        let editingLayerId = null;  // ID ‡∏Ç‡∏≠‡∏á Layer ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ highlight)
        // ********************************

        let entities = []; 
        let currentDrawLayer = null;
        let mapLayers = {};
        let globalOpacity = 0.6;
        let globalStrokeColor = '#5D4037';
        let selectedMarkerIconUrl = 'https://api.iconify.design/twemoji/round-pushpin.svg';
        let pendingConfirmAction = null; 
        let is3DMode = false;
        let selectedCesiumEntity = null;
        let cesiumBaseLayer = 'nolabels'; // Track the currently selected base layer mode ('nolabels' or 'sat')
        

        // --- NEW GLOBALS for Freehand ---
        let isFreehand = false;
        let freehandPath = [];
        let tempLine = null;

        // --- NEW GLOBALS for Unification ---
        let isMultiSelectMode = false;
        let selectedIds = new Set();
        
        // --- NEW GLOBALS for Map Sheets ---
        let currentMapSheetId = null; // ID of the currently selected map sheet
        let mapSheets = [];           // Array of all map sheets for the current user
        let unsubscribeMapListener = null; // To manage the dynamic map data listener
        
        // --- Split Territory Globals REMOVED ---
        // Removed: isSplitting, splitTargetId, splitLineLayer, cutPiecesGeoJsons, tempSplitLayers

        // --- UPDATED HIERARCHY ARRAY (Comprehensive list based on user specs) ---
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° 'title' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå
        const HIERARCHY = [
            // Country Level (Rank >= 9) - Title depends on Government
            { id: 'mahaAnachak', name: '‡∏°‡∏´‡∏≤‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£', rank: 11, defaultColor: '#884A51', parentReq: 'anachak', reqDesc: '‡∏ó‡∏∏‡∏Å‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏Ñ‡∏£', title: '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏à‡∏±‡∏Å‡∏£‡∏û‡∏£‡∏£‡∏î‡∏¥' },
            { id: 'anachak', name: '‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£', rank: 10, defaultColor: '#F1C40F', parentReq: 'prathet', reqDesc: '‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏Ñ‡∏£', title: '‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏ä‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ' },
            { id: 'prathet', name: '‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®/‡∏£‡∏≤‡∏ä‡∏£‡∏±‡∏ê', rank: 9, defaultColor: '#E74C3C', parentReq: 'monrath', reqDesc: '‡∏ó‡∏∏‡∏Å‡∏°‡∏ì‡∏£‡∏±‡∏ê‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á', title: '‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ' }, 
            
            // Regional Level (Rank 8-6) - Fixed Titles
            { id: 'monrath', name: '‡∏°‡∏ì‡∏£‡∏±‡∏ê', rank: 8, defaultColor: '#F39C12', parentReq: 'monthon', reqDesc: '‡∏ó‡∏∏‡∏Å‡∏°‡∏ì‡∏ë‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á', title: '‡∏£‡∏±‡∏ê‡∏≤‡∏ò‡∏¥‡∏Å‡∏£‡∏ì' },
            { id: 'nakorn', name: '‡∏ô‡∏Ñ‡∏£', rank: 7, defaultColor: '#C0392B', promoted: true, promoteFrom: 'jangwat', requiredChildrenLevel: 'muang', reqDesc: '‡∏ó‡∏∏‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÉ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á', title: '‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ô‡∏Ñ‡∏£‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏•' },
            { id: 'monthon', name: '‡∏°‡∏ì‡∏ë‡∏•', rank: 6, defaultColor: '#E91E63', parentReq: 'jangwat', reqDesc: '‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏Ñ‡∏£', title: '‡∏°‡∏ì‡∏ë‡∏•‡∏≤‡∏ò‡∏¥‡∏õ‡∏±‡∏ï‡∏¢‡πå' },
            
            // Provincial/District Level (Rank 5-3) - Fixed Titles
            { id: 'jangwat', name: '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î', rank: 5, defaultColor: '#2ECC71', parentReq: 'amphoe', reqDesc: '‡∏ó‡∏∏‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á', title: '‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î' },
            { id: 'muang', name: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á', rank: 4, defaultColor: '#A859A3', promoted: true, promoteFrom: 'amphoe', requiredChildrenLevel: 'arkhet', reqDesc: '‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡∏ö‡∏•‡πÉ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≤‡πÄ‡∏Ç‡∏ï', title: '‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á' },
            { id: 'amphoe', name: '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠', rank: 3, defaultColor: '#8E44AD', parentReq: 'tambon', reqDesc: '‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡∏ö‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≤‡πÄ‡∏Ç‡∏ï', title: '‡∏ô‡∏≤‡∏¢‡∏≠‡∏≥‡πÄ‡∏†‡∏≠' },
            
            // Sub-District Level (Rank 2.5 - 1.5) - Fixed Titles
            { id: 'arkhet', name: '‡∏≠‡∏≤‡πÄ‡∏Ç‡∏ï', rank: 2.5, defaultColor: '#C0D9D9', promoted: true, promoteFrom: 'tambon', requiredChildrenLevel: 'khwaeng', reqDesc: '‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ç‡∏ß‡∏á', title: '‡∏Å‡∏≥‡∏ô‡∏±‡∏ô' },
            { id: 'tambon', name: '‡∏ï‡∏≥‡∏ö‡∏•', rank: 2, defaultColor: '#95A5A6', parentReq: 'muban', reqDesc: '‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ç‡∏ß‡∏á', title: '‡∏Å‡∏≥‡∏ô‡∏±‡∏ô' },
            { id: 'khwaeng', name: '‡πÅ‡∏Ç‡∏ß‡∏á', rank: 1.5, defaultColor: '#34B7D1', promoted: true, promoteFrom: 'muban', requiredChildrenMerge: true, reqDesc: '‡∏£‡∏ß‡∏°‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô', title: '‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô' },
            
            // Village Level (Rank 1) - Fixed Title
            { id: 'muban', name: '‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô', rank: 1, defaultColor: '#3498DB', title: '‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô' }
        ];
        // --- END UPDATED HIERARCHY ARRAY ---

        const RANK_COLORS = {};
        HIERARCHY.forEach(h => RANK_COLORS[h.id] = h.defaultColor);

        const COLORS = {
            religion: { '‡∏û‡∏∏‡∏ó‡∏ò': '#F1C40F', '‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå': '#3498DB', '‡∏≠‡∏¥‡∏™‡∏•‡∏≤‡∏°': '#2ECC71', '‡∏û‡∏£‡∏≤‡∏´‡∏°‡∏ì‡πå‡∏Æ‡∏¥‡∏ô‡∏î‡∏π': '#E91E63', '‡∏®‡∏≤‡∏™‡∏ô‡∏≤‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°': '#95A5A6' },
            gov: { '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ò‡∏¥‡∏õ‡πÑ‡∏ï‡∏¢': '#2ECC71', '‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ß‡∏ô‡∏¥‡∏™‡∏ï‡πå': '#E74C3C', '‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå': '#8E44AD', '‡∏õ‡∏£‡∏¥‡∏°‡∏¥‡∏ï‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå': '#F39C12' },
            rank: RANK_COLORS
        };
        
        // Allowed attacker ranks: nakorn, prathet, anachak, mahaAnachak
        const ATTACK_RANKS = ['nakorn', 'prathet', 'anachak', 'mahaAnachak'];
        const ATTACK_RANK_VALUES = new Set(ATTACK_RANKS.map(id => getRank(id)));

        const IMPORTANT_ICONS = {
            "‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á": ['twemoji:house', 'twemoji:castle', 'twemoji:japanese-castle', 'twemoji:classical-building', 'twemoji:derelict-house', 'twemoji:hut', 'twemoji:tent', 'twemoji:stadium', 'twemoji:factory', 'twemoji:hospital', 'twemoji:school', 'twemoji:place-of-worship', 'twemoji:shinto-shrine'],
            "‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥": ['twemoji:deciduous-tree', 'twemoji:evergreen-tree', 'twemoji:palm-tree', 'twemoji:cactus', 'twemoji:sheaf-of-rice', 'twemoji:herb', 'twemoji:mountain', 'twemoji:snow-capped-mountain', 'twemoji:volcano', 'twemoji:rock', 'twemoji:ocean', 'twemoji:water-wave'],
            "‡∏Å‡∏≤‡∏£‡∏ó‡∏´‡∏≤‡∏£ & ‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á": ['twemoji:crossed-swords', 'twemoji:shield', 'twemoji:bow-and-arrow', 'twemoji:dagger', 'twemoji:crown', 'twemoji:skull-and-crossbones', 'twemoji:flag-in-hole', 'twemoji:chequered-flag', 'twemoji:triangular-flag', 'twemoji:fleur-de-lis'],
            "‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£ & ‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥": ['twemoji:gem-stone', 'twemoji:coin', 'twemoji:money-bag', 'twemoji:pick', 'twemoji:hammer-and-pick', 'twemoji:wood', 'twemoji:oil-drum', 'twemoji:fishing-pole', 'twemoji:anchor', 'twemoji:compass'],
            "‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå & ‡πÅ‡∏ü‡∏ô‡∏ï‡∏≤‡∏ã‡∏µ": ['twemoji:crystal-ball', 'twemoji:magic-wand', 'twemoji:sparkles', 'twemoji:star', 'twemoji:crescent-moon', 'twemoji:scroll', 'twemoji:book', 'twemoji:candle', 'twemoji:amphora', 'twemoji:coffin']
        };
        
        // Helper function to get the base collection reference for map sheets
        function getMapSheetCollectionRef() {
            if (!window.userId) return null;
            return collection(db, 'artifacts', appId, 'users', window.userId, 'map_sheets');
        }

        // Helper function to get the data collection reference for the current map sheet
        function getEntityCollectionRef() {
            if (!window.userId || !currentMapSheetId) return null;
            return collection(db, 'artifacts', appId, 'users', window.userId, 'map_sheets', currentMapSheetId, 'fantasy_empires');
        }
        
        // --- NEW: Helper to determine the correct ruler title ---
        function getRulerTitle(levelId, government) {
            const rankObj = HIERARCHY.find(x => x.id === levelId);
            if (!rankObj) return '‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á';
            
            // Check for country-level overrides (rank 9 or higher)
            if (rankObj.rank >= 9) {
                if (government === '‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå' || government === '‡∏õ‡∏£‡∏¥‡∏°‡∏¥‡∏ï‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå') return '‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå';
                if (government === '‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ò‡∏¥‡∏õ‡πÑ‡∏ï‡∏¢') return '‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ';
                if (government === '‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ß‡∏ô‡∏¥‡∏™‡∏ï‡πå') return '‡∏ó‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥';
            }
            
            // Default title from HIERARCHY
            return rankObj.title || '‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á';
        }


        // --- Initialization ---
        window.onload = async () => {
            initMap();
            setupUI();
            
            // Add temp layer for split pieces visualization
            // Removed: tempSplitLayers.addTo(map);

            if (location.hostname !== 'localhost' && !firebaseConfig.apiKey) {
                 showConfirmModal("‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î", null, true);
                 return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    toggleAuthUI(user);
                    if (user) {
                        window.userId = user.uid;
                        document.getElementById('user-display-name').innerText = `Lord ${user.displayName || user.email}`;
                        document.getElementById('user-id-display').innerText = `ID: ${window.userId.substring(0,6)}`;
                        
                        // Start listening for map sheets when user logs in
                        subscribeToMapSheets(); 

                    } else {
                        // Clear map when user logs out
                        mapSheets = [];
                        currentMapSheetId = null;
                        renderMapSheetSelect();
                        if (unsubscribeMapListener) unsubscribeMapListener();
                        drawnItems.clearLayers();
                        entities = [];
                    }
                });
            } catch (err) { console.error("Firebase connection failed:", err); }
        };

        function toggleAuthUI(user) {
            const loggedInView = document.getElementById('logged-in-view');
            const loggedOutView = document.getElementById('logged-out-view');
            const sheetSelect = document.getElementById('map-sheet-select');
            if(user) {
                loggedInView.classList.remove('hidden');
                loggedOutView.classList.add('hidden');
                sheetSelect.disabled = false;
            } else {
                loggedInView.classList.add('hidden');
                loggedOutView.classList.remove('hidden');
                sheetSelect.disabled = true;
            }
        }

        // --- Map Sheet Management ---

        function subscribeToMapSheets() {
            const sheetsRef = getMapSheetCollectionRef();
            if(!sheetsRef) return;

            onSnapshot(sheetsRef, (snap) => {
                mapSheets = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a, b) => a.name.localeCompare(b.name));
                
                let shouldSwitch = false;
                
                if (mapSheets.length > 0) {
                    const currentSheetExists = mapSheets.find(s => s.id === currentMapSheetId);
                    if (!currentMapSheetId || !currentSheetExists) {
                        // Automatically select the first map sheet if none is active or the current one was deleted
                        currentMapSheetId = mapSheets[0].id;
                        shouldSwitch = true;
                    }
                    document.getElementById('btn-delete-map').disabled = false;
                } else {
                    // Create a default sheet if none exist (Only if the user is logged in)
                    if (window.userId) {
                        createNewMapSheet(null, "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô");
                    }
                    document.getElementById('btn-delete-map').disabled = true;
                    currentMapSheetId = null; 
                }
                
                renderMapSheetSelect();
                if (shouldSwitch || (mapSheets.length > 0 && !unsubscribeMapListener)) {
                    switchMapSheet(currentMapSheetId);
                }
            });
        }
        
        function renderMapSheetSelect() {
            const select = document.getElementById('map-sheet-select');
            select.innerHTML = '';
            
            if (mapSheets.length === 0) {
                 select.innerHTML = '<option value="">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà</option>';
                 return;
            }

            mapSheets.forEach(sheet => {
                const opt = document.createElement('option');
                opt.value = sheet.id;
                opt.innerText = sheet.name;
                if (sheet.id === currentMapSheetId) opt.selected = true;
                select.appendChild(opt);
            });
        }

        window.switchMapSheet = (newId) => {
            if (!newId) return;
            if (newId === currentMapSheetId) return;
            
            currentMapSheetId = newId;
            // Clear map visuals immediately
            drawnItems.clearLayers();
            // Removed: tempSplitLayers.clearLayers();
            entities = [];
            
            // Re-subscribe to the new map's data
            subscribeToMapData();
            showToast(`‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: ${mapSheets.find(s => s.id === newId)?.name}`);
        };

        function subscribeToMapData() {
            // Unsubscribe from old listener if exists
            if (unsubscribeMapListener) unsubscribeMapListener();
            
            const areasRef = getEntityCollectionRef();
            if (!areasRef) {
                // If no currentMapSheetId (e.g., waiting for first sheet creation), do nothing
                return; 
            }
            
            // Set up new listener
            unsubscribeMapListener = onSnapshot(areasRef, (snap) => {
                entities = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderMap(); // 2D
                if(is3DMode) renderCesium(); // 3D
            }, (error) => {
                console.error("Error subscribing to map data:", error);
                entities = [];
                renderMap();
            });
        }

        window.createNewMapSheet = async (e, defaultName = null) => {
            if (e) e.preventDefault();
            if(!window.userId) { showConfirmModal("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà", null, true); return; }

            const nameInput = document.getElementById('new-map-name');
            const newName = defaultName || nameInput.value;
            
            if (!newName) return;
            
            closeModal('modal-new-map');
            if (e) nameInput.value = ''; // Only clear if not default creation
            
            try {
                const sheetsRef = getMapSheetCollectionRef();
                await addDoc(sheetsRef, { 
                    name: newName, 
                    createdAt: new Date().toISOString()
                });
                showToast(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà: ${newName} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            } catch (err) {
                showConfirmModal("‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", err.message, null, true);
            }
        };
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renameMapModal ‡πÅ‡∏•‡∏∞ renameMapSheet ‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å

        window.confirmDeleteMapSheet = () => {
             if (mapSheets.length <= 1) {
                  showConfirmModal("‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÅ‡∏ú‡πà‡∏ô", null, true);
                  return;
             }
             const currentSheet = mapSheets.find(s => s.id === currentMapSheetId);
             if (!currentSheet) return;
             
             showConfirmModal(`‡∏•‡∏ö '${currentSheet.name}'`, "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", 
                 () => deleteMapSheet(currentSheet.id)
             );
        }

        async function deleteMapSheet(sheetId) {
             if(!window.userId) return;
             
             try {
                // 1. Delete all entities in the sheet's subcollection
                const entityDocs = await getDocs(collection(db, 'artifacts', appId, 'users', window.userId, 'map_sheets', sheetId, 'fantasy_empires'));
                const batch = writeBatch(db);
                entityDocs.forEach((d) => batch.delete(d.ref));
                await batch.commit();

                // 2. Delete the map sheet document itself
                await deleteDoc(doc(getMapSheetCollectionRef(), sheetId));
                
                showToast("‡∏•‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                
                // onSnapshot will handle switching to the next available sheet
             } catch (err) {
                 showConfirmModal("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ${err.message}`, null, true);
             }
        }


        // --- Map Setup (2D) ---
        function initMap() {
            if (map) return;
            
            const noLabelsLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            });
            const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });

            const corner1 = L.latLng(-85, -180);
            const corner2 = L.latLng(85, 180);
            const bounds = L.latLngBounds(corner1, corner2);

            map = L.map('map', { 
                center: [13.7563, 100.5018], 
                zoom: 6, 
                zoomControl: false, 
                layers: [noLabelsLayer],
                maxBounds: bounds,
                maxBoundsViscosity: 1.0,
                minZoom: 3
            });

            mapLayers = { nolabels: noLabelsLayer, sat: satLayer };
            drawnItems = L.featureGroup().addTo(map);
            
            // NOTE: Leaflet.Draw is required for L.Draw.Event.EDITED/CREATED, even if we manually trigger draw modes.
            map.addControl(new L.Control.Draw({
                edit: { featureGroup: drawnItems },
                draw: { polygon: true, polyline: true, marker: true, rectangle: false, circle: false, circlemarker: false }
            }));

            map.on(L.Draw.Event.CREATED, onDrawCreated);
            map.on(L.Draw.Event.EDITED, onDrawEdited);
            
           // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Leaflet Draw ‡∏ú‡∏™‡∏°‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥ .editing ‡πÉ‡∏´‡πâ Layer ‡πÉ‡∏ô drawnItems
           // ** ‡∏õ‡∏£‡∏±‡∏ö style ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ **
           new L.EditToolbar.Edit(map, {
                featureGroup: drawnItems,
                selectedPathOptions: {
                    dashArray: '10, 10', // ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö
                    fill: true,
                    fillColor: '#FFD700', // ‡∏™‡∏µ‡∏ó‡∏≠‡∏á
                    fillOpacity: 0.1, // ‡πÉ‡∏™‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
                    color: '#FFD700', // ‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ó‡∏≠‡∏á
                    weight: 3, // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤
                    maintainColor: false
                }
            });

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î ESC ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠ Layer ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ editingLayer ‡∏ñ‡∏π‡∏Å reset)
            map.on('editable:disable', (e) => {
                 if (e.layer === editingLayer) {
                    editingLayer = null;
                    editingLayerId = null;
                    renderMap(); // Force re-render to remove highlight
                 }
            });
        }
        
        // ** NEW CESIUM IMAGERY PROVIDERS **
        const CARTO_IMAGERY_PROVIDER = new Cesium.UrlTemplateImageryProvider({
            url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png',
            subdomains: ['a', 'b', 'c', 'd'],
            credit: '&copy; OpenStreetMap &copy; CARTO'
        });

        const ESRI_IMAGERY_PROVIDER = new Cesium.ArcGisMapServerImageryProvider({
            url : 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer'
        });
        // ** END NEW CESIUM IMAGERY PROVIDERS **


        // --- Cesium Setup (3D) ---
        function initCesium() {
            if(viewer) return;

            // Use the initial selected base layer when initializing
            const initialProvider = cesiumBaseLayer === 'nolabels' ? CARTO_IMAGERY_PROVIDER : ESRI_IMAGERY_PROVIDER;

            // ‡∏õ‡∏¥‡∏î UI/Widget ‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
            viewer = new Cesium.Viewer('cesiumContainer', {
                animation: false,
                baseLayerPicker: false,
                fullscreenButton: false,
                vrButton: false,
                geocoder: false,
                homeButton: false,
                infoBox: false,
                sceneModePicker: false,
                selectionIndicator: true,
                timeline: false,
                navigationHelpButton: false,
                imageryProvider: initialProvider // Use CARTO or ESRI
            });
            
            // Hide default Cesium base layer text (names) if CARTO is selected
            if (cesiumBaseLayer === 'nolabels') {
                 viewer.scene.globe.showGroundAtmosphere = false;
            } else {
                 viewer.scene.globe.showGroundAtmosphere = true;
            }


            viewer.scene.globe.enableLighting = true;
            viewer.scene.screenSpaceCameraController.enableCollisionDetection = false;
            
            const popupDiv = document.getElementById('cesium-popup');
            const popupContent = document.getElementById('cesium-popup-content');
            
            // Cesium Click Handler for Popups and Selection
            viewer.screenSpaceEventHandler.setInputAction((click) => {
                const pickedObject = viewer.scene.pick(click.position);
                
                // Reset popup and selection
                selectedCesiumEntity = null;
                popupDiv.classList.add('hidden');
                
                if (Cesium.defined(pickedObject) && pickedObject.id && pickedObject.id.entityDataId) {
                    selectedCesiumEntity = pickedObject.id;
                    const ent = entities.find(e => e.id === selectedCesiumEntity.entityDataId);
                    
                    if (ent) {
                        const visuals = getEntityVisuals(ent);
                        // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Popup ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö Leaflet ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á
                        popupContent.innerHTML = createPopupContent(ent, visuals.fillColor, visuals.colorContext);
                        popupDiv.classList.remove('hidden');
                    }
                }
            }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

            // Post-Render Listener to update Popup position
            // REQ 2: This listener ensures the custom HTML popup follows the 3D entity center
            viewer.scene.postRender.addEventListener(() => {
                if (selectedCesiumEntity && !popupDiv.classList.contains('hidden')) {
                    let position;
                    // Cesium entities might have position or centerPosition defined
                    if(selectedCesiumEntity.position) {
                        position = selectedCesiumEntity.position.getValue(viewer.clock.currentTime);
                    } else if(selectedCesiumEntity.centerPosition) {
                        position = selectedCesiumEntity.centerPosition;
                    }

                    if (position) {
                        // Project 3D position to 2D screen coordinates
                        const canvasPosition = Cesium.SceneTransforms.wgs84ToWindowCoordinates(viewer.scene, position);
                        if (canvasPosition) {
                            // Calculate position based on popup size (320px width)
                            popupDiv.style.top = (canvasPosition.y - popupDiv.offsetHeight - 20) + 'px';
                            popupDiv.style.left = (canvasPosition.x - popupDiv.offsetWidth / 2) + 'px';
                        }
                    }
                }
            });

            syncCameraTo2D();
        }
        
        // ** NEW: Function to switch Cesium Base Layer **
        function switchCesiumBaseLayer(mode) {
             if (!viewer) return;
             
             cesiumBaseLayer = mode;
             viewer.scene.imageryLayers.removeAll();
             
             if (mode === 'nolabels') {
                 viewer.scene.imageryLayers.addImageryProvider(CARTO_IMAGERY_PROVIDER);
                 viewer.scene.globe.showGroundAtmosphere = false; // Hide names/labels from Cesium's default layer if present
             } else { // 'sat' mode
                 viewer.scene.imageryLayers.addImageryProvider(ESRI_IMAGERY_PROVIDER);
                 viewer.scene.globe.showGroundAtmosphere = true;
             }
        }


        function syncCameraTo2D() {
            if(!map || !viewer) return;
            const center = map.getCenter();
            viewer.camera.flyTo({
                destination : Cesium.Cartesian3.fromDegrees(center.lng, center.lat, 5000000),
                duration: 1.5
            });
        }

        window.toggleGlobeMode = () => {
            is3DMode = !is3DMode;
            const body = document.body;
            const btnIcon = document.getElementById('globe-btn-icon');
            
            // ‡∏ã‡πà‡∏≠‡∏ô Cesium Popup ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î
            document.getElementById('cesium-popup').classList.add('hidden');
            
            if(is3DMode) {
                body.classList.remove('mode-2d'); body.classList.add('mode-3d');
                btnIcon.src = "https://api.iconify.design/noto:map-of-japan.svg";
                if(!viewer) initCesium();
                switchCesiumBaseLayer(cesiumBaseLayer); // Ensure the correct base layer is loaded
                renderCesium();
                viewer.scene.postRender.addEventListener(updateCompass3D);
            } else {
                body.classList.remove('mode-3d'); body.classList.add('mode-2d');
                btnIcon.src = "https://api.iconify.design/noto:globe-showing-asia-australia.svg";
                if(viewer) viewer.scene.postRender.removeEventListener(updateCompass3D);
                document.getElementById('compass-icon').style.transform = 'rotate(0deg)';
                map.closePopup();
            }
        }

        function updateCompass3D() {
            if(!viewer) return;
            const heading = viewer.camera.heading;
            const deg = Cesium.Math.toDegrees(heading);
            document.getElementById('compass-icon').style.transform = `rotate(${-deg}deg)`;
        }

        // --- UI Setup ---
        function setupUI() {
            const toggleBtn = document.getElementById('toggle-sidebar');
            if(toggleBtn) toggleBtn.onclick = () => {
                const sb = document.getElementById('sidebar-left');
                sb.classList.toggle('sidebar-collapsed');
                toggleBtn.innerText = sb.classList.contains('sidebar-collapsed') ? '‚ñ∂' : '‚óÄ';
            };
            
            // --- UPDATED MAP LAYER BUTTONS ---
            document.getElementById('btn-map-nolabels').onclick = (e) => { 
                map.removeLayer(mapLayers.sat); map.addLayer(mapLayers.nolabels);
                cesiumBaseLayer = 'nolabels';
                if(is3DMode) switchCesiumBaseLayer('nolabels');
                updateLayerBtnStyle(e.target, document.getElementById('btn-map-sat'));
            };
            document.getElementById('btn-map-sat').onclick = (e) => { 
                map.removeLayer(mapLayers.nolabels); map.addLayer(mapLayers.sat); 
                cesiumBaseLayer = 'sat';
                if(is3DMode) switchCesiumBaseLayer('sat');
                updateLayerBtnStyle(e.target, document.getElementById('btn-map-nolabels'));
            };
            // --- END UPDATED MAP LAYER BUTTONS ---

            function updateLayerBtnStyle(active, inactive) {
                active.className = "flex-1 text-xs py-1.5 rounded-lg bg-white text-[#5D4037] shadow-sm font-bold";
                inactive.className = "flex-1 text-xs py-1.5 rounded-lg text-gray-500 hover:bg-gray-200 transition";
                
                // Ensure the map layers match the button state
                if (active.id === 'btn-map-nolabels') {
                    if (map.hasLayer(mapLayers.sat)) map.removeLayer(mapLayers.sat);
                    if (!map.hasLayer(mapLayers.nolabels)) map.addLayer(mapLayers.nolabels);
                } else if (active.id === 'btn-map-sat') {
                    if (map.hasLayer(mapLayers.nolabels)) map.removeLayer(mapLayers.nolabels);
                    if (!map.hasLayer(mapLayers.sat)) map.addLayer(mapLayers.sat);
                }
            }
            // Initialize layer buttons (assuming nolabels is the default)
            updateLayerBtnStyle(document.getElementById('btn-map-nolabels'), document.getElementById('btn-map-sat'));


            document.getElementById('toggle-created-labels')?.addEventListener('change', renderMap);
            document.getElementById('toggle-created-rank')?.addEventListener('change', () => { renderMap(); if(is3DMode) renderCesium(); }); // NEW: Rank Toggle Listener
            document.getElementById('toggle-roads')?.addEventListener('change', () => { renderMap(); if(is3DMode) renderCesium(); });
            document.getElementById('toggle-compass')?.addEventListener('change', (e) => {
                const compass = document.getElementById('compass');
                if(e.target.checked) compass.classList.remove('hidden-compass');
                else compass.classList.add('hidden-compass');
            });
            
            document.getElementById('compass').onclick = () => {
                if(is3DMode && viewer) {
                    const center = viewer.camera.positionCartographic;
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromRadians(center.longitude, center.latitude, center.height),
                        orientation: { heading: 0, pitch: -Cesium.Math.PI_OVER_TWO, roll: 0 },
                        duration: 1.0
                    });
                }
            };

            document.getElementById('opacity-slider')?.addEventListener('input', (e) => {
                globalOpacity = parseFloat(e.target.value);
                document.getElementById('opacity-val').innerText = Math.round(globalOpacity*100) + '%';
                renderMap();
                if(is3DMode) renderCesium();
            });
            
            document.getElementById('global-stroke-color')?.addEventListener('input', (e) => {
                globalStrokeColor = e.target.value;
                renderMap(); if(is3DMode) renderCesium();
            });

            document.getElementById('color-mode-select')?.addEventListener('change', (e) => {
                const mode = e.target.value;
                const legendBox = document.getElementById('legend-box');
                if (mode === 'religion' || mode === 'government' || mode === 'rank') {
                    legendBox.classList.remove('hidden'); updateLegend(mode);
                } else {
                    legendBox.classList.add('hidden');
                }
                renderMap();
                if(is3DMode) renderCesium();
            });

            // Hierarchy Filter Logic
            const filterContainer = document.getElementById('filter-levels-container');
            if(filterContainer && HIERARCHY) {
                filterContainer.innerHTML = '';
                // Filter out promoted ranks for the initial drawing dropdown (users draw base ranks)
                const baseRanks = HIERARCHY.filter(h => !h.promoted); 
                baseRanks.forEach(h => {
                    const div = document.createElement('div');
                    div.innerHTML = `<label class="flex items-center text-xs cursor-pointer hover:bg-white/50 p-1 rounded"><input type="checkbox" checked class="filter-level accent-[#5D4037] mr-2" value="${h.id}"> ${h.name}</label>`;
                    filterContainer.appendChild(div);
                });
                // Include all ranks for filtering
                document.querySelectorAll('.filter-level').forEach(el => el.addEventListener('change', () => { renderMap(); if(is3DMode) renderCesium(); }));
            }

            // Status Filter Listener
            document.querySelectorAll('.filter-status').forEach(el => el.addEventListener('change', () => { renderMap(); if(is3DMode) renderCesium(); }));


            const formArea = document.getElementById('form-area');
            if(formArea) formArea.onsubmit = saveArea;

            document.getElementById('road-weight')?.addEventListener('input', (e) => {
                document.getElementById('road-weight-val').innerText = e.target.value;
            });

            const levelSelect = document.getElementById('inp-level');
            if(levelSelect) {
                // Only populate with base ranks for drawing
                const baseRanks = HIERARCHY.filter(h => !h.promoted);
                levelSelect.innerHTML = '';
                baseRanks.forEach(h => {
                    const opt = document.createElement('option'); opt.value = h.id; opt.text = h.name; levelSelect.appendChild(opt);
                });
                levelSelect.onchange = (e) => {
                    const lvl = HIERARCHY.find(h => h.id === e.target.value);
                    if(lvl) document.getElementById('inp-color').value = lvl.defaultColor;
                    updateParentSelect(lvl ? lvl.rank : 0);
                };
            }
            
            // Setup merge/elevate level select (full hierarchy)
            const mergeLevelSelect = document.getElementById('merge-level');
            const elevateLevelSelect = document.getElementById('elevate-level'); // Add elevate select here
            
            [mergeLevelSelect, elevateLevelSelect].forEach(select => { // Apply to both selects
                select.innerHTML = '';
                HIERARCHY.sort((a, b) => b.rank - a.rank).forEach(h => {
                    const opt = document.createElement('option');
                    opt.value = h.id;
                    opt.text = h.name;
                    select.appendChild(opt);
                });
            });


            renderImportantIcons(); 
            document.getElementById('search-input')?.addEventListener('keyup', () => { renderMap(); if(is3DMode) renderCesium(); });
        }

        window.toggleAllLevels = (check) => {
            document.querySelectorAll('.filter-level').forEach(cb => cb.checked = check);
            renderMap(); if(is3DMode) renderCesium();
        };

        window.toggleAllStatuses = (check) => {
            document.querySelectorAll('.filter-status').forEach(cb => cb.checked = check);
            renderMap(); if(is3DMode) renderCesium();
        };

        // --- UPDATED checkModeAndDraw to handle 3D Mode switching ---
        window.checkModeAndDraw = (type) => {
            if (!currentMapSheetId) {
                showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î");
                return;
            }
            if(isMultiSelectMode) {
                 showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î");
                 return;
            }
            // ** REQ: ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ 2D ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ß‡∏≤‡∏î/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç **
            if(is3DMode) {
                toggleGlobeMode(); // ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ 2D
                showConfirmModal("‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î", "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏¢‡∏±‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà 2 ‡∏°‡∏¥‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏≤‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á", null, true);
                return;
            }
            
            // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô
            if (isEditMode) {
                toggleEditGeometry();
            }
            
            if(type === 'polygon') window.toggleDrawMenu(); 
            else if(type === 'polyline') window.startDrawPolyline();
            else if(type === 'marker') window.startDrawMarker();
            else if(type === 'edit') window.toggleEditGeometry(); // For toggleEditGeometry to be called
        }
        
        // --- NEW: Toggle Draw Menu ---
        window.toggleDrawMenu = () => {
             const menu = document.getElementById('draw-submenu');
             menu.classList.toggle('active');
        };

        // --- Helper: Hierarchy Logic ---
        function getAncestors(ent) {
            const ancestors = [];
            let current = ent;
            let depth = 0;
            while(current.parentId && depth < 20) {
                const parent = entities.find(e => e.id === current.parentId);
                if(parent) { ancestors.push(parent); current = parent; } else break;
                depth++;
            }
            return ancestors.reverse();
        }
        
        // NEW: Get direct children names
        function getDirectChildrenNames(parentId) {
            return entities.filter(e => e.parentId === parentId && e.type === 'area')
                           .map(e => `${getHierarchyName(e.level)} ${e.name}`);
        }

        function getDescendants(parentIds) {
            let descendants = [];
            let queue = [...parentIds];
            let visited = new Set(parentIds);
            let depth = 0;
            while(queue.length > 0 && depth < 1000) { // Safety break
                const pid = queue.shift();
                const children = entities.filter(e => e.parentId === pid);
                children.forEach(c => {
                    if(!visited.has(c.id)) { visited.add(c.id); descendants.push(c); queue.push(c.id); }
                });
                depth++;
            }
            return descendants;
        }
        
        // Function to get the rank object or a dummy
        function getRankObject(id) {
             return HIERARCHY.find(x => x.id === id);
        }

        function getEntityVisuals(ent) {
            const colorMode = document.getElementById('color-mode-select').value;
            let fillColor = ent.color;
            let colorContext = { type: 'entity', value: '‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏Ç‡∏ï' };
            const entRank = getRankObject(ent.level);

            if (colorMode === 'religion') {
                fillColor = COLORS.religion[ent.religion] || '#ccc';
                colorContext = { type: 'religion', value: ent.religion };
            } else if (colorMode === 'government') {
                fillColor = COLORS.gov[ent.government] || '#ccc';
                colorContext = { type: 'gov', value: ent.government };
            } else if (colorMode === 'rank') {
                fillColor = entRank ? entRank.defaultColor : '#ccc';
                colorContext = { type: 'rank', value: entRank ? entRank.name : 'Unknown' };
            }

            if (ent.isWater) {
                fillColor = '#81D4FA';
                colorContext = { type: 'water', value: '‡∏ô‡πà‡∏≤‡∏ô‡∏ô‡πâ‡∏≥' };
            }
            
            // Annexation/Vassal/Colony Logic
            if (colorMode === 'entity') {
                if (ent.isColony) {
                    fillColor = ent.originalColor || ent.color; 
                } else if (ent.isAnnexed || ent.isVassal) {
                    // Fill color is the conqueror's color (stored in ent.color)
                    fillColor = ent.color; 
                }
            }
            
            // Check if current entity is the one being edited
            if (isEditMode && ent.id === editingLayerId) {
                // Leaflet Draw handles the styling when enabled.
            }

            return { fillColor, colorContext };
        }

        function renderImportantIcons() {
            const container = document.getElementById('quick-icons-container');
            container.innerHTML = '';
            
            for (const [category, icons] of Object.entries(IMPORTANT_ICONS)) {
                const title = document.createElement('div');
                title.className = 'icon-category-title col-span-full';
                title.innerText = category;
                container.appendChild(title);

                icons.forEach(iconName => {
                    const url = `https://api.iconify.design/${iconName.replace(':','/')}.svg`;
                    const div = document.createElement('div');
                    div.className = 'icon-option flex-shrink-0';
                    div.innerHTML = `<img src="${url}" title="${iconName}">`;
                    div.onclick = () => selectIcon(url, div);
                    container.appendChild(div);
                });
            }
        }

        window.searchIcons = async () => {
            const query = document.getElementById('icon-search-query').value;
            if(!query) return;
            const container = document.getElementById('icon-results');
            container.innerHTML = '<div class="text-xs text-gray-500 p-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</div>';
            
            try {
                const res = await fetch(`https://api.iconify.design/search?query=${encodeURIComponent(query)}&limit=30`);
                const data = await res.json();
                container.innerHTML = '';
                
                if(data.icons && data.icons.length > 0) {
                    data.icons.forEach(iconName => {
                        const url = `https://api.iconify.design/${iconName.replace(':','/')}.svg`;
                        const div = document.createElement('div');
                        div.className = 'icon-option flex-shrink-0 w-10 h-10';
                        div.innerHTML = `<img src="${url}" title="${iconName}" class="w-6 h-6">`;
                        div.onclick = () => selectIcon(url, div);
                        container.appendChild(div);
                    });
                } else {
                    container.innerHTML = '<div class="text-xs text-gray-500 p-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</div>';
                }
            } catch(e) {
                container.innerHTML = '<div class="text-xs text-red-500 p-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>';
            }
        }

        function selectIcon(url, element) {
            selectedMarkerIconUrl = url;
            document.querySelectorAll('.icon-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
        }

        // --- Cesium Rendering Logic (UPDATED FOR LABEL PLACEMENT AND POPUP DATA) ---
        function renderCesium() {
            if(!viewer) return;
            
            viewer.selectedEntity = undefined;
            viewer.trackedEntity = undefined;
            
            viewer.entities.removeAll();
            
            const { visibleEntities } = filterEntities();
            const showRoads = document.getElementById('toggle-roads').checked;
            const showLabels = document.getElementById('toggle-created-labels').checked;
            const showRank = document.getElementById('toggle-created-rank').checked; // NEW: Rank Toggle Check
            
            visibleEntities.forEach(ent => {
                try {
                    const geoJson = JSON.parse(ent.geoJson);
                    const visuals = getEntityVisuals(ent);
                    
                    if (ent.type === 'road') {
                        if(!showRoads) return;
                        const flatCoords = [];
                        
                        // Safety Check: Ensure coordinates exist
                        if (!geoJson.geometry || !geoJson.geometry.coordinates) return;
                        
                        geoJson.geometry.coordinates.forEach(pt => { if(pt.length >= 2) flatCoords.push(pt[0], pt[1]); });
                        
                        // Safety Check: Need at least 2 points for a line
                        if (flatCoords.length < 4) return; 

                        const roadEnt = viewer.entities.add({
                            polyline: {
                                positions: Cesium.Cartesian3.fromDegreesArray(flatCoords),
                                width: parseInt(ent.weight) || 4,
                                // Use Dash Material for 'army' type roads
                                material: ent.roadType === 'army' 
                                          ? new Cesium.PolylineDashMaterialProperty({
                                                color: Cesium.Color.fromCssColorString(ent.color),
                                                dashLength: 8.0
                                            })
                                          : Cesium.Color.fromCssColorString(ent.color)
                            },
                            name: ent.name
                        });
                        roadEnt.entityDataId = ent.id; // Store ID for click handling
                        return;
                    }

                    if (ent.type === 'marker') {
                        const lon = geoJson.geometry.coordinates[0];
                        const lat = geoJson.geometry.coordinates[1];
                        
                        const markerEnt = viewer.entities.add({
                            position: Cesium.Cartesian3.fromDegrees(lon, lat),
                            billboard: {
                                image: ent.iconUrl,
                                scale: 1.0,
                                color: Cesium.Color.fromCssColorString(ent.color),
                                verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                            },
                            name: ent.name
                        });
                        markerEnt.entityDataId = ent.id; // Store ID for click handling
                        
                        // Marker Label
                        if(showLabels) {
                            markerEnt.label = {
                                text: ent.name,
                                font: 'bold 16px "Mali", sans-serif',
                                style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                                fillColor: Cesium.Color.WHITE,
                                outlineColor: Cesium.Color.fromCssColorString('#5D4037'),
                                outlineWidth: 4,
                                verticalOrigin: Cesium.VerticalOrigin.TOP,
                                pixelOffset: new Cesium.Cartesian2(0, 5),
                                distanceDisplayCondition: new Cesium.DistanceDisplayCondition(0, 1000000),
                                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                            };
                        }
                        return;
                    }

                    if(geoJson.geometry.type === 'Polygon' || geoJson.geometry.type === 'MultiPolygon') {
                         if(geoJson.geometry.type === 'Polygon' || geoJson.geometry.type === 'MultiPolygon') {
                             const flat = [];
                             
                             // Helper function to extract coordinates from MultiPolygon/Polygon
                             const extractCoords = (coords) => {
                                 if (coords && coords.length > 0) {
                                     // Check for MultiPolygon structure: [[[lon, lat], ...], ...]
                                     if (coords[0][0] && typeof coords[0][0][0] === 'number') {
                                         coords.forEach(poly => poly[0].forEach(pt => flat.push(pt[0], pt[1])));
                                     } 
                                     // Check for Polygon structure: [[lon, lat], ...]
                                     else if (coords[0][0] && typeof coords[0][0] === 'number') {
                                         coords[0].forEach(pt => flat.push(pt[0], pt[1]));
                                     }
                                 }
                             };

                             if (geoJson.geometry.type === 'MultiPolygon') {
                                extractCoords(geoJson.geometry.coordinates);
                             } else if (geoJson.geometry.type === 'Polygon') {
                                extractCoords([geoJson.geometry.coordinates]);
                             }
                             
                             // Safety Check: Need at least 3 points for a polygon (6 coords)
                             if (flat.length < 6) return;

                             let outlineColor = ent.isWater ? '#29B6F6' : globalStrokeColor;
                             
                             // REQ 1: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                             if (ent.isAnnexed) outlineColor = '#000000'; // ‡∏ñ‡∏π‡∏Å‡∏ú‡∏ô‡∏ß‡∏Å: ‡πÄ‡∏™‡πâ‡∏ô‡∏î‡∏≥
                             else if (ent.isVassal) outlineColor = visuals.fillColor; // ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä: ‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏∏‡∏Å‡∏£‡∏≤‡∏ô
    
                             const hierarchy = Cesium.Cartesian3.fromDegreesArray(flat);

                             // REQ 1: ‡∏ß‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (Polygon) ‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö (Outline)
                             const polyEnt = viewer.entities.add({
                                polygon: {
                                    hierarchy: hierarchy,
                                    // REQ 1: ‡∏™‡∏µ‡∏ñ‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏µ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏µ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏ï‡∏≤‡∏° Opacity slider
                                    material: Cesium.Color.fromCssColorString(visuals.fillColor).withAlpha(ent.isWater ? 0.5 : globalOpacity),
                                    outline: !ent.isColony, // ‡∏≠‡∏≤‡∏ì‡∏≤‡∏ô‡∏¥‡∏Ñ‡∏°‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡πÅ‡∏¢‡∏Å
                                    outlineColor: Cesium.Color.fromCssColorString(outlineColor),
                                    outlineWidth: 2,
                                    height: 0, // ‡∏û‡∏∑‡πâ‡∏ô‡∏ú‡∏¥‡∏ß‡πÇ‡∏•‡∏Å
                                    extrudedHeight: 0.1 // ‡πÉ‡∏´‡πâ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
                                },
                                name: ent.name
                             });
                             // REQ 2: ‡πÄ‡∏Å‡πá‡∏ö ID ‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pop-up
                             polyEnt.entityDataId = ent.id; 

                             // Colony Dashed Line Fix (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏ì‡∏≤‡∏ô‡∏¥‡∏Ñ‡∏°)
                             if (ent.isColony) {
                                 viewer.entities.add({
                                     polyline: {
                                         positions: hierarchy, 
                                         width: 2,
                                         material: new Cesium.PolylineDashMaterialProperty({
                                             color: Cesium.Color.fromCssColorString(globalStrokeColor),
                                             dashLength: 16.0
                                         }),
                                         clampToGround: true
                                     }
                                 });
                             }
                             
                             // Center Label Logic
                             try {
                                const center = turf.centerOfMass(geoJson);
                                // Set centerPosition property on the entity for popup positioning
                                polyEnt.centerPosition = Cesium.Cartesian3.fromDegrees(center.geometry.coordinates[0], center.geometry.coordinates[1]);

                                // Area Label
                                if (showLabels && !ent.isWater) { 
                                    const rankName = getHierarchyName(ent.level);
                                    let labelText = ent.name;
                                    let offset = 0;
                                    
                                    // NEW: Conditionally add rank name to the label
                                    if (showRank) {
                                         labelText = `${rankName}\n${labelText}`;
                                         offset = -15; // Shift label up for 2 lines
                                    }

                                    if (ent.isAnnexed) labelText = ent.annexedByName; // Main name becomes conqueror
                                    if (ent.isColony) labelText += ` (‡∏≠‡∏≤‡∏ì‡∏≤‡∏ô‡∏¥‡∏Ñ‡∏°‡∏Ç‡∏≠‡∏á ${ent.annexedByName})`;
                                    
                                    viewer.entities.add({
                                        position: polyEnt.centerPosition,
                                        label: {
                                            text: labelText,
                                            font: 'bold 14px "Mali", sans-serif',
                                            style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                                            fillColor: Cesium.Color.fromCssColorString(ent.labelColor || '#4E342E'),
                                            outlineColor: Cesium.Color.WHITE,
                                            outlineWidth: 3,
                                            verticalOrigin: Cesium.VerticalOrigin.TOP,
                                            pixelOffset: new Cesium.Cartesian2(0, offset), // Adjusted offset
                                            distanceDisplayCondition: new Cesium.DistanceDisplayCondition(0, 2000000),
                                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                                        }
                                    });
                                }
                             } catch(e) { console.error("Cesium label error:", e); }
                         }
                    }
                } catch(e) { console.error("Cesium render error for entity:", e); }
            });
        }

        // --- Leaflet Rendering Logic (UPDATED FOR LABEL PLACEMENT) ---
        function renderMap() {
            if(!map || !drawnItems) return;
            drawnItems.clearLayers();
            
            const { visibleEntities } = filterEntities();
            const showRoads = document.getElementById('toggle-roads').checked;
            const showLabels = document.getElementById('toggle-created-labels').checked;
            const showRank = document.getElementById('toggle-created-rank').checked; // NEW: Rank Toggle Check
            
            // Removed: Render the temporary split line if in splitting mode
            // Removed: Render temporary cut pieces if in the modal


            visibleEntities.forEach(ent => {
                try {
                    const geoJson = JSON.parse(ent.geoJson);
                    const visuals = getEntityVisuals(ent); 

                    if (ent.type === 'road') {
                        if(!showRoads) return;
                        const roadLayer = L.geoJSON(geoJson, {
                            style: { color: ent.color, weight: parseInt(ent.weight) || 4, dashArray: ent.roadType === 'army' ? '10, 15' : null, opacity: 0.8, lineCap: 'round' }
                        }).bindPopup(`
                            <div class="text-center">
                                <div class="font-bold text-[#5D4037] text-lg cute-font">${ent.name}</div>
                                <div class="text-xs text-gray-500 mb-2">${ent.roadType==='army'?'‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏±‡∏û':'‡∏ñ‡∏ô‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤'}</div>
                                <button onclick="window.confirmDelete('${ent.id}')" class="text-red-400 text-xs underline cursor-pointer">‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</button>
                            </div>
                        `).addTo(drawnItems);
                        roadLayer.eachLayer(l => l.options.entityId = ent.id);
                        return;
                    }
                    
                    if (ent.type === 'marker') {
                        const icon = L.divIcon({
                            className: 'custom-marker',
                            html: `<div style="position:relative; width:30px; height:30px;"><div style="position:absolute; top:0; left:0; width:100%; height:100%; background:${ent.color}; opacity:0.3; border-radius:50%; filter:blur(4px);"></div><img src="${ent.iconUrl}" style="width:30px; height:30px; position:relative; z-index:2; filter: drop-shadow(0 0px 0px rgba(0,0,0,0.3));"></div>`,
                            iconSize: [30, 30], iconAnchor: [15, 15]
                        });
                        L.geoJSON(geoJson, { pointToLayer: (f, l) => L.marker(l, {icon: icon}) }).bindPopup(`
                            <div class="text-center font-bold text-[#5D4037]">
                                <img src="${ent.iconUrl}" class="w-12 h-12 mx-auto mb-2">
                                <div class="mb-1 text-lg cute-font">${ent.name}</div>
                                <button onclick="window.confirmDelete('${ent.id}')" class="text-red-400 text-xs underline cursor-pointer">‡∏•‡∏ö‡∏´‡∏°‡∏∏‡∏î</button>
                            </div>
                        `).addTo(drawnItems);
                        return;
                    }

                    // --- AREA LOGIC ---
                    let strokeColor = ent.isWater ? '#29B6F6' : globalStrokeColor;
                    
                    // UPDATED REQ: ‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏ô‡∏ß‡∏Å‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏î‡∏≥
                    if (ent.isAnnexed) strokeColor = '#000000'; 
                    // Vassal stroke color remains conqueror's color (visuals.fillColor in old logic)
                    else if (ent.isVassal) strokeColor = visuals.fillColor; 
                    
                    // Logic for Selection Highlight (Used for Multi-Select Mode)
                    const isSelected = selectedIds.has(ent.id);
                    
                    // Style for the layer
                    const layerStyle = {
                        color: isSelected ? '#FFD700' : strokeColor, // Gold if selected (Multi-Select)
                        weight: isSelected ? 4 : (ent.isWater ? 1 : 1.5),
                        fillColor: visuals.fillColor,
                        fillOpacity: ent.isWater ? 0.5 : globalOpacity,
                        dashArray: isSelected ? '8, 8' : (ent.isColony ? '5, 10' : null)
                    };
                    
                    // Override stroke color/style if currently being edited
                    if (isEditMode && ent.id === editingLayerId) {
                         // Leaflet Draw handles the highlight (gold dash) when editing is enabled
                         // If it's the layer being edited, we don't apply the selection style from here
                         layerStyle.color = strokeColor; // Use original color when not selected in multi-select mode
                         layerStyle.weight = ent.isWater ? 1 : 1.5;
                         layerStyle.dashArray = ent.isColony ? '5, 10' : null;
                    }


                    L.geoJSON(geoJson, {
                        style: layerStyle,
                         onEachFeature: (f, l) => {
                            l.options.entityId = ent.id;

                            // ** ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Layer ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö Layer reference ‡πÑ‡∏ß‡πâ **
                            if (isEditMode && ent.id === editingLayerId) {
                                window.editingLayer = l;
                                l.editing.enable();
                            }
                            
                            l.on('click', async (e) => {
                                // 1. Pop-up Blocking: ‡∏õ‡∏¥‡∏î Popup ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
                                map.closePopup();

                                // 2. Check Edit Mode: ‡∏Å‡∏£‡∏ì‡∏µ 1: ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Click to Edit)
                                if (window.isEditMode) {
                                    L.DomEvent.stopPropagation(e); 
                                    
                                    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Area (Polygon) ‡πÅ‡∏•‡∏∞ Road (Polyline)
                                    if (ent.type !== 'area' && ent.type !== 'road') {
                                        showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ");
                                        return;
                                    }

                                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Layer ‡∏≠‡∏∑‡πà‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡πà‡∏≠‡∏ô
                                    if (window.editingLayer && window.editingLayer !== l) {
                                        window.editingLayer.editing.disable();
                                        const oldRef = doc(getEntityCollectionRef(), window.editingLayer.options.entityId);
                                        // ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ save ‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠
                                        setDoc(oldRef, { geoJson: JSON.stringify(window.editingLayer.toGeoJSON()) }, { merge: true }).then(() => console.log("Old entity saved")).catch(e => console.error("Error saving old entity:", e));
                                        window.editingLayerId = null;
                                        window.editingLayer = null;
                                    }

                                    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Layer ‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å
                                    l.editing.enable();
                                    window.editingLayer = l;
                                    window.editingLayerId = ent.id; // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ID ‡∏Ç‡∏≠‡∏á Layer ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                    
                                    // Force re-render ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Leaflet Draw ‡πÉ‡∏ä‡πâ style ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (gold dashed line)
                                    // ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Layer ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ style ‡∏õ‡∏Å‡∏ï‡∏¥
                                    renderMap(); 
                                    
                                    showToast(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ${ent.name} (‡∏î‡∏∂‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á)`);
                                    return; 
                                }

                                // 3. Check Multi-Select Mode: ‡∏Å‡∏£‡∏ì‡∏µ 2: ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏±‡∏ô (Multi-Select ‡πÄ‡∏î‡∏¥‡∏°)
                                if (isMultiSelectMode && ent.type === 'area' && !ent.isWater) {
                                    L.DomEvent.stopPropagation(e); 
                                    
                                    if (selectedIds.has(ent.id)) selectedIds.delete(ent.id);
                                    else selectedIds.add(ent.id);
                                    updateSelectionUI();
                                    renderMap();
                                    return;
                                }

                                // 4. Default Mode: ‡∏Å‡∏£‡∏ì‡∏µ 3: ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÅ‡∏™‡∏î‡∏á Popup Info)
                                l.bindPopup(createPopupContent(ent, visuals.fillColor, visuals.colorContext)).openPopup();
                            });


                            // REQ 2 & Label Placement: ‡πÉ‡∏ä‡πâ turf.centerOfMass ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏°‡∏ß‡∏• ‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏ô
                            // ** REQ 2: Update rank check to allow all ranks (rank >= 1) **
                            if (showLabels && !ent.isWater && getRank(ent.level) >= 1) {
                                
                                let skipLabel = false;
                                
                                // NEW: Label Visibility Hierarchy Logic (Parent hides label if children are visible)
                                // This applies to entities that ARE parents (have children)
                                const children = entities.filter(e => e.parentId === ent.id && e.type === 'area' && !e.isWater);
                                
                                if (children.length > 0) {
                                    const filterLevels = Array.from(document.querySelectorAll('.filter-level:checked')).map(cb => cb.value);
                                    
                                    // If ANY direct child is currently visible (i.e., its level is in the active filter list), hide the parent's label.
                                    const anyChildVisible = children.some(child => {
                                        return filterLevels.includes(child.level);
                                    });

                                    if (anyChildVisible) {
                                        skipLabel = true;
                                    }
                                }
                                
                                if(skipLabel) return;
                                
                                
                                let centerLatlng = l.getBounds().getCenter(); // Fallback to Leaflet center
                                
                                try {
                                    const center = turf.centerOfMass(geoJson);
                                    // ‡πÇ‡∏Ñ‡πâ‡∏î Turf ‡πÉ‡∏ä‡πâ [lon, lat] ‡πÅ‡∏ï‡πà Leaflet L.latLng ‡πÉ‡∏ä‡πâ (lat, lon)
                                    centerLatlng = L.latLng(center.geometry.coordinates[1], center.geometry.coordinates[0]);
                                } catch (e) { 
                                    // console.warn("Turf centerOfMass failed, using bounds center:", e); 
                                }
                                
                                let labelHtml = ent.name;
                                
                                if (ent.isAnnexed) {
                                    labelHtml = ent.annexedByName;
                                }

                                if (ent.isColony) {
                                    labelHtml += `<div class="text-[9px] font-bold mt-0 text-red-600">(‡∏≠‡∏≤‡∏ì‡∏≤‡∏ô‡∏¥‡∏Ñ‡∏°‡∏Ç‡∏≠‡∏á ${ent.annexedByName})</div>`;
                                } else if (ent.isVassal) {
                                    labelHtml += `<div class="text-[9px] font-bold mt-0 text-red-600">(‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä‡∏Ç‡∏≠‡∏á ${ent.annexedByName})</div>`;
                                } 
                                
                                // ** NEW: Conditionally add rank name to the label **
                                let rankLabelHtml = '';
                                if (showRank) {
                                     const rankName = getHierarchyName(ent.level);
                                     rankLabelHtml = `<div class="text-[9px] text-amber-800">${rankName}</div>`;
                                }
                                labelHtml = rankLabelHtml + labelHtml;


                                drawnItems.addLayer(L.marker(centerLatlng, { icon: L.divIcon({ className: 'text-center pointer-events-none', html: `<span class="text-[10px] sm:text-xs font-bold drop-shadow-md whitespace-nowrap block" style="color:${ent.labelColor || '#4E342E'}; text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;">${labelHtml}</span>`, iconSize: [120, 20], iconAnchor: [60, 10] }) }));
                            }
                            
                        }
                    }).addTo(drawnItems);

                } catch (e) { console.error("Render error", e); }
            });
        }

        // --- NEW: Custom Decree Modals ---

        /**
         * ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏§‡∏©‡∏é‡∏µ‡∏Å‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
         * @param {Object} ent - Entity ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á
         * @param {string} actionText - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô‡∏ß‡πÇ‡∏£‡∏Å‡∏≤‡∏™‡πÄ‡∏ñ‡∏•‡∏¥‡∏á‡∏ñ‡∏ß‡∏±‡∏•‡∏¢‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥, ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á)
         */
        function showAppointmentDecreeModal(ent, actionText) {
            const levelName = getHierarchyName(ent.level);
            const rulerTitle = getRulerTitle(ent.level, ent.government);
            const childrenNames = getDirectChildrenNames(ent.id).join(', ');

            // Set classes for general decree (dark theme)
            document.getElementById('decree-paper').className = 'decree-paper w-full max-w-lg p-8 relative gold-mist';

            // Set dynamic header
            document.getElementById('decree-title-text').innerText = `‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á`;
            document.getElementById('decree-intro').innerText = `‡πÇ‡∏î‡∏¢‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏´‡πà‡∏á‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô`;
            document.getElementById('decree-emblem').innerHTML = `<span class="material-icons-round text-6xl text-[#FFD700] opacity-80" style="text-shadow: 0 0 10px #FFD700;">gavel</span>`;

            // Construct main content
            const content = `
                <p class="text-lg font-bold text-amber-300">
                    ‡∏Ç‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏Å‡∏±‡∏ö <b class="decree-title text-xl">${ent.ruler}</b>
                </p>
                <p>
                    ‡πÉ‡∏ô‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô <b class="decree-title">${rulerTitle}</b> ‡πÅ‡∏´‡πà‡∏á ${levelName} <b class="decree-title">${ent.name}</b>
                </p>
                <p>
                    ${actionText}
                </p>
                <div class="kannon-divider w-1/3 mx-auto"></div>
                <p class="text-xs text-gray-400">
                    ‡∏≠‡∏±‡∏ô‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ï‡πâ‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÉ‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
                </p>
                <p class="text-sm font-bold text-teal-400">
                    ${childrenNames.length > 0 ? childrenNames : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ï‡πâ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ'}
                </p>
            `;

            document.getElementById('decree-main-content').innerHTML = content;
            document.getElementById('modal-decree').classList.remove('hidden');
        }

        /**
         * ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏§‡∏©‡∏é‡∏µ‡∏Å‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå/‡∏õ‡∏£‡∏∞‡∏ò‡∏≤‡∏ô‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)
         * @param {Object} ent - Entity ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
         */
        function showCoronationDecreeModal(ent) {
            const levelName = getHierarchyName(ent.level);
            const rulerTitle = getRulerTitle(ent.level, ent.government);
            const isMonarchy = ent.government === '‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå' || ent.government === '‡∏õ‡∏£‡∏¥‡∏°‡∏¥‡∏ï‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå';
            const countryType = isMonarchy ? '‡∏£‡∏≤‡∏ä‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£' : '‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏£‡∏±‡∏ê';
            
            // Set classes for Monarchy (red/gold theme)
            document.getElementById('decree-paper').className = 'decree-paper decree-paper-coronation w-full max-w-lg p-8 relative gold-mist';

            let titleText = '';
            let introText = '';
            let mainMessage = '';
            let emblemIcon = 'stars';
            
            if (isMonarchy) {
                titleText = `‡∏Ç‡∏≠‡∏ñ‡∏ß‡∏≤‡∏¢‡∏û‡∏£‡∏∞‡∏û‡∏£ ${ent.ruler}`;
                introText = `‡∏ì ‡∏ß‡πÇ‡∏£‡∏Å‡∏≤‡∏™‡πÄ‡∏ñ‡∏•‡∏¥‡∏á‡∏ñ‡∏ß‡∏±‡∏•‡∏¢‡∏£‡∏≤‡∏ä‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏õ‡πá‡∏ô ${rulerTitle} ‡πÅ‡∏´‡πà‡∏á ${countryType} ${ent.name}`;
                mainMessage = `
                    <p>
                        ‡∏ö‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏¥‡∏î‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏õ‡∏ê‡∏ß‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÅ‡∏´‡πà‡∏á‡∏ö‡∏∏‡∏ç‡∏ç‡∏≤‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á <b class="decree-title">${ent.ruler}</b>
                        ‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡∏Ø ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏¢‡πå‡πÄ‡∏õ‡πá‡∏ô ${rulerTitle} ‡πÅ‡∏´‡πà‡∏á ${countryType} <b class="decree-title">${ent.name}</b>
                    </p>
                    <p>
                        ‡∏Ç‡∏≠‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÅ‡∏´‡πà‡∏á‡πÑ‡∏û‡∏£‡∏µ‡∏û‡∏¥‡∏ô‡∏≤‡∏®‡∏à‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¢‡πå‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏π‡πà‡∏ö‡∏±‡∏•‡∏•‡∏±‡∏á‡∏Å‡πå ‡∏™‡∏ñ‡∏¥‡∏ï‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏¢‡∏¥‡πà‡∏á‡∏¢‡∏∑‡∏ô‡∏ô‡∏≤‡∏ô‡πÄ‡∏ó‡∏≠‡∏ç!
                    </p>
                `;
                emblemIcon = 'volunteer_activism'; // Crown or similar
            } else { // President/Leader
                titleText = `‡∏Ç‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏î‡∏µ ${ent.ruler}`;
                introText = `‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô ${rulerTitle} ‡πÅ‡∏´‡πà‡∏á ${countryType} ${ent.name}`;
                mainMessage = `
                    <p>
                        ‡∏Ç‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏ô‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ó‡∏µ‡πà <b class="decree-title">${ent.ruler}</b> ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß‡πâ‡∏ß‡∏≤‡∏á‡πÉ‡∏à‡∏à‡∏≤‡∏Å‡∏õ‡∏ß‡∏á‡∏ä‡∏ô
                        ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô ${rulerTitle} ‡πÅ‡∏´‡πà‡∏á ${countryType} <b class="decree-title">${ent.name}</b>
                    </p>
                    <p>
                        ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡πà‡∏≤‡∏ô‡∏à‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡∏ó‡∏£‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏° ‡∏ô‡∏≥‡∏û‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏ä‡∏≤‡∏ï‡∏¥‡∏™‡∏π‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏™‡∏∑‡∏ö‡πÑ‡∏õ
                    </p>
                `;
                emblemIcon = 'how_to_reg'; // Leader/Election icon
            }

            document.getElementById('decree-title-text').innerText = titleText;
            document.getElementById('decree-intro').innerText = introText;
            document.getElementById('decree-emblem').innerHTML = `<span class="material-icons-round text-6xl text-[#FFD700] opacity-80" style="text-shadow: 0 0 10px #FFD700;">${emblemIcon}</span>`;
            document.getElementById('decree-main-content').innerHTML = mainMessage;
            document.getElementById('modal-decree').classList.remove('hidden');
        }

        // Removed: showSplitDecreeModal function

        // --- War Room / Split Territory Logic (UPDATED FOR SPLIT CURSOR) ---

        // Removed: startSplitTerritoryMode function
        // Removed: cancelSplit function
        // Removed: onSplitLineDrawn function
        // Removed: performPolygonSplit function
        // Removed: openSplitModal function
        // Removed: saveSplitTerritory function


        // --- Map Display and General Logic ---

        window.toggleMultiSelectMode = () => {
            if (!currentMapSheetId) {
                showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà");
                return;
            }
            // ** REQ: ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ 2D ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô 3D **
            if(is3DMode) {
                toggleGlobeMode();
                showConfirmModal("‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î", "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏¢‡∏±‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà 2 ‡∏°‡∏¥‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà' ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á", null, true);
                return;
            }
            
            if (isEditMode) {
                // ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡πà‡∏≠‡∏ô
                toggleEditGeometry();
            }

            isMultiSelectMode = !isMultiSelectMode;
            selectedIds.clear();
            
            const btn = document.getElementById('btn-multi-select');
            const bar = document.getElementById('selection-bar');
            
            if (isMultiSelectMode) {
                btn.classList.add('bg-purple-100', 'text-purple-700', 'ring-2', 'ring-purple-400');
                bar.classList.remove('hidden');
                bar.classList.add('flex');
                
                if(currentDrawLayer) cancelDraw();
                showToast("üí° ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å");
            } else {
                btn.classList.remove('bg-purple-100', 'text-purple-700', 'ring-2', 'ring-purple-400');
                bar.classList.add('hidden');
                bar.classList.remove('flex');
            }
            
            updateSelectionUI();
            renderMap();
        };

        function updateSelectionUI() {
            document.getElementById('selection-count').innerText = selectedIds.size;
        }

        window.openUnionModal = () => {
            const selectedEnts = entities.filter(ent => selectedIds.has(ent.id));

            if (selectedIds.size < 2 || selectedEnts.length < 2) {
                showConfirmModal("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", null, true);
                return;
            }
            
            const firstRankId = selectedEnts[0].level;
            const selectedRank = getRank(firstRankId);
            const sameRank = selectedEnts.every(e => e.level === firstRankId);

            let canElevate = false;
            
            // ** REQ 3: Check if all selected entities are the same rank and share the same parent (or are all independent) **
            if (sameRank) {
                const uniqueParents = new Set(selectedEnts.map(e => e.parentId || 'independent'));
                if (uniqueParents.size === 1) {
                    canElevate = true;
                }
            }
            
            // Show/Hide Elevate Tab
            document.getElementById('tab-elevate').style.display = canElevate ? 'flex' : 'none';

            const modal = document.getElementById('modal-union');
            modal.classList.remove('hidden');
            
            // Setup Tab 1: Merge Level Dropdown
            const mergeLevelSelect = document.getElementById('merge-level');
            mergeLevelSelect.value = 'prathet'; 
            document.getElementById('merge-color').value = selectedEnts[0].color;
            document.getElementById('merge-ruler').value = selectedEnts[0].ruler;
            
            // Setup Tab 2: Elevate Level Dropdown (Only ranks higher than selected)
            const elevateLevelSelect = document.getElementById('elevate-level');
            elevateLevelSelect.innerHTML = '';
            
            const higherRanks = HIERARCHY.filter(h => h.rank > selectedRank && !h.promoted).sort((a, b) => a.rank - b.rank); // Only allow elevation to base ranks for simplicity
            
            higherRanks.forEach(h => {
                const opt = document.createElement('option');
                opt.value = h.id;
                opt.text = h.name;
                elevateLevelSelect.appendChild(opt);
            });
            
            elevateLevelSelect.value = higherRanks[0] ? higherRanks[0].id : ''; 
            document.getElementById('elevate-color').value = higherRanks[0] ? higherRanks[0].defaultColor : selectedEnts[0].color;
            document.getElementById('elevate-ruler').value = selectedEnts[0].ruler;


            // Setup Tab 3: Annex Leader Selector
            const leaderSelect = document.getElementById('annex-leader-select');
            leaderSelect.innerHTML = '';
            selectedIds.forEach(id => {
                const ent = entities.find(e => e.id === id);
                if(ent) {
                    const opt = document.createElement('option');
                    opt.value = ent.id;
                    opt.innerText = `${ent.name} (‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á: ${ent.ruler})`;
                    leaderSelect.appendChild(opt);
                }
            });

            // Switch to the most relevant tab
            if(canElevate) switchUnionTab('elevate');
            else switchUnionTab('merge');
        };

        window.switchUnionTab = (tab) => {
            const tabs = ['merge', 'elevate', 'annex'];
            tabs.forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const content = document.getElementById(`content-${t}`);
                if (t === tab) {
                    // Update button styling for the active tab
                    let borderColor = '#5D4037';
                    let textColorClass = 'text-[#5D4037]';
                    
                    if (t === 'annex') { borderColor = 'red-600'; textColorClass = 'text-red-600'; }
                    else if (t === 'elevate') { borderColor = 'blue-600'; textColorClass = 'text-blue-600'; }
                    else if (t === 'merge') { borderColor = 'amber-600'; textColorClass = 'text-amber-600'; }

                    btn.className = `flex-1 py-4 text-sm font-bold bg-white transition flex items-center justify-center gap-2 border-b-2 border-${borderColor} ${textColorClass}`;
                    content.classList.remove('hidden');
                } else {
                    btn.className = "flex-1 py-4 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:bg-gray-100 transition flex items-center justify-center gap-2";
                    content.classList.add('hidden');
                }
            });
        };

        // --- DESTRUCTIVE MERGE (Same as before) ---
        window.executeMerge = async (e) => {
            e.preventDefault();
            if(!window.userId || !currentMapSheetId) { showConfirmModal("Error", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", null, true); return; }

            try {
                const selectedEnts = entities.filter(ent => selectedIds.has(ent.id));
                const polys = selectedEnts.map(ent => JSON.parse(ent.geoJson));

                // Turf Union Logic
                let mergedGeo = polys[0];
                for (let i = 1; i < polys.length; i++) {
                    mergedGeo = turf.union(mergedGeo, polys[i]);
                }

                const newName = document.getElementById('merge-name').value;
                const newColor = document.getElementById('merge-color').value;
                const newRuler = document.getElementById('merge-ruler').value;
                const newLevel = document.getElementById('merge-level').value;
                const newGov = selectedEnts[0].government || '‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå'; // Inherit or default

                const newDoc = {
                    name: newName,
                    ruler: newRuler,
                    color: newColor,
                    level: newLevel,
                    government: newGov,
                    geoJson: JSON.stringify(mergedGeo),
                    type: 'area',
                    isWater: false,
                    createdAt: new Date().toISOString(),
                    originalName: newName,
                    originalRuler: newRuler,
                    originalColor: newColor,
                    mergedFrom: selectedEnts.map(e => e.name)
                };

                const batch = writeBatch(db);
                const colRef = getEntityCollectionRef();

                // Create new
                const newRef = doc(colRef); 
                batch.set(newRef, newDoc);

                // Delete old
                selectedIds.forEach(id => {
                    const oldRef = doc(colRef, id);
                    batch.delete(oldRef);
                });

                await batch.commit();
                
                closeModal('modal-union');
                toggleMultiSelectMode();
                showConfirmModal("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", `‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£ ${newName} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÅ‡∏•‡πâ‡∏ß!`, null, true);

            } catch (err) {
                console.error(err);
                showConfirmModal("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏ß‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ (‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≤‡∏à‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ)", null, true);
            }
        };
        
        // --- NEW: NON-DESTRUCTIVE ELEVATION (REQ 4) ---
        window.executeAreaElevation = async (e) => {
             e.preventDefault();
             if(!window.userId || !currentMapSheetId) { showConfirmModal("Error", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", null, true); return; }

             const selectedEnts = entities.filter(ent => selectedIds.has(ent.id));
             if (selectedEnts.length < 2) return; 

             try {
                const polys = selectedEnts.map(ent => JSON.parse(ent.geoJson));
                let mergedGeo = polys[0];
                for (let i = 1; i < polys.length; i++) { mergedGeo = turf.union(mergedGeo, polys[i]); }
                if (!mergedGeo) { throw new Error("Turf union failed to create single polygon."); }

                const newName = document.getElementById('elevate-name').value;
                const newColor = document.getElementById('elevate-color').value;
                const newRuler = document.getElementById('elevate-ruler').value;
                const newLevel = document.getElementById('elevate-level').value;
                const newGov = selectedEnts[0].government || '‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡∏≤‡∏ç‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏£‡∏≤‡∏ä‡∏¢‡πå'; 
                
                // Use the parentId of the first selected entity (they must all be the same/independent)
                const originalParentId = selectedEnts[0].parentId || null; 
                
                const colRef = getEntityCollectionRef();
                const batch = writeBatch(db);

                // 1. Create new Parent Entity (the Elevated Area)
                const newRef = doc(colRef); 
                const newParentId = newRef.id;

                const newDoc = {
                    name: newName,
                    ruler: newRuler,
                    color: newColor,
                    level: newLevel,
                    government: newGov,
                    geoJson: JSON.stringify(mergedGeo),
                    type: 'area',
                    isWater: false,
                    createdAt: new Date().toISOString(),
                    originalName: newName,
                    originalRuler: newRuler,
                    originalColor: newColor,
                    parentId: originalParentId, 
                    isSubLayer: true 
                };
                batch.set(newRef, newDoc);

                // 2. Update all selected children to point to the new parent
                selectedIds.forEach(id => {
                    const oldRef = doc(colRef, id);
                    // The children retain their old color/ruler for the required visual effect
                    batch.update(oldRef, { parentId: newParentId });
                });

                await batch.commit();
                
                closeModal('modal-union');
                toggleMultiSelectMode();
                
                // Trigger appointment decree for the new elevated entity
                const tempEntity = { ...newDoc, id: newParentId };
                showAppointmentDecreeModal(tempEntity, '‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà');

             } catch (err) {
                 console.error(err);
                 showConfirmModal("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ: " + err.message, null, true);
             }
        }

        window.executeAnnex = async (type) => {
            if(!window.userId || !currentMapSheetId) { showConfirmModal("Error", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", null, true); return; }
            
            const leaderId = document.getElementById('annex-leader-select').value;
            const leader = entities.find(e => e.id === leaderId);
            
            if(!leader) return;

            const batch = writeBatch(db);
            const colRef = getEntityCollectionRef();

            selectedIds.forEach(id => {
                if(id === leaderId) return;

                const entRef = doc(colRef, id);
                const target = entities.find(e => e.id === id); // Get target entity for original values
                
                const updates = {
                    isAnnexed: false, isVassal: false, isColony: false,
                    occupiedBy: leader.id,
                    annexedByName: leader.name,
                    ruler: leader.ruler, 
                    // Important: Store original color/ruler if not already set, before applying conqueror's color/ruler
                    originalColor: target.originalColor || target.color,
                    originalRuler: target.originalRuler || target.ruler,
                    originalName: target.originalName || target.name,
                };

                if(type === 'annex') {
                    updates.isAnnexed = true;
                    // REQ 1: ‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö/‡∏ñ‡∏° ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏∏‡∏Å‡∏£‡∏≤‡∏ô
                    updates.color = leader.color; 
                } else if (type === 'vassal') {
                    updates.isVassal = true;
                    updates.color = leader.color; 
                } else if (type === 'colony') {
                    updates.isColony = true;
                    // REQ: ‡∏≠‡∏≤‡∏ì‡∏≤‡∏ô‡∏¥‡∏Ñ‡∏°‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞
                    updates.color = updates.originalColor; 
                }

                batch.update(entRef, updates);
            });

            await batch.commit();
            
            closeModal('modal-union');
            toggleMultiSelectMode();
            showConfirmModal("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", `‡∏Å‡∏≤‡∏£‡∏ú‡∏ô‡∏ß‡∏Å‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ ${leader.name} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå`, null, true);
        };
        
        /**
         * Geometric Merge: Attacker absorbs Target, deleting both and creating a single new merged polygon.
         */
        window.executeGeometricMerge = () => {
             showConfirmModal("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏≠‡∏°‡∏£‡∏ß‡∏°‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô", "‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏£‡∏ß‡∏°‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡∏£‡∏∏‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏≠‡∏≠‡∏Å ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", 
                 async () => await performGeometricMerge()
             );
        };
        
        async function performGeometricMerge() {
            if(!window.userId || !currentMapSheetId) { showConfirmModal("Error", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", null, true); closeModal('modal-confirm'); return; }

            const tid = document.getElementById('war-target-id').value;
            const aid = document.getElementById('war-attacker-select').value;
            const attacker = entities.find(e => e.id === aid);
            const target = entities.find(e => e.id === tid);
            
            if(!attacker || !target) { 
                showConfirmModal("Error", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà)", null, true); 
                closeModal('modal-war');
                return;
            }

            // Check if both are Polygons (Area)
            if (attacker.type !== 'area' || target.type !== 'area') {
                 showConfirmModal("Error", "‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏≠‡∏°‡∏£‡∏ß‡∏°‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (Area) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô", null, true);
                 closeModal('modal-war');
                 return;
            }

            try {
                const attackerGeo = JSON.parse(attacker.geoJson);
                const targetGeo = JSON.parse(target.geoJson);
                
                let mergedGeo = turf.union(attackerGeo, targetGeo);

                // If turf.union fails or returns null/undefined (e.g., non-intersecting MultiPolygons)
                if (!mergedGeo) {
                    showConfirmModal("Error", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏•‡∏≠‡∏°‡∏£‡∏ß‡∏°‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡πÑ‡∏î‡πâ ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô", null, true);
                    return;
                }

                // Create new entity based on Attacker's details
                const newDoc = {
                    name: attacker.name,
                    ruler: attacker.ruler,
                    color: attacker.color,
                    level: attacker.level,
                    government: attacker.government,
                    geoJson: JSON.stringify(mergedGeo),
                    type: 'area',
                    isWater: false,
                    createdAt: new Date().toISOString(),
                    originalName: attacker.originalName || attacker.name,
                    originalRuler: attacker.originalRuler || attacker.ruler,
                    originalColor: attacker.originalColor || attacker.color,
                    mergedFrom: [attacker.name, target.name]
                };

                const batch = writeBatch(db);
                const colRef = getEntityCollectionRef();
                
                // 1. Create new merged entity
                const newRef = doc(colRef); 
                batch.set(newRef, newDoc);

                // 2. Delete old entities
                batch.delete(doc(colRef, aid)); // Delete Attacker (old geometry)
                batch.delete(doc(colRef, tid)); // Delete Target
                
                await batch.commit();
                
                closeModal('modal-war');
                // *** CALL NEW DECREE MODAL AFTER SUCCESS ***
                showFusionDecreeModal(attacker, target);

            } catch (err) {
                console.error("Geometric Merge Error:", err);
                showConfirmModal("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏ß‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ (‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≤‡∏à‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ): " + err.message, null, true);
            }
        }
        
        /**
         * Shows the dramatic ancient Thai decree modal for fusion.
         * @param {Object} attacker - The conquering entity.
         * @param {Object} target - The conquered entity.
         */
        function showFusionDecreeModal(attacker, target) {
            const targetRankName = getHierarchyName(target.level);
            
            // Set classes for fusion decree (gold/black theme)
            document.getElementById('decree-paper').className = 'decree-paper w-full max-w-lg p-8 relative gold-mist';

            // 1. Set dynamic text content
            document.getElementById('decree-title-text').innerText = `${targetRankName}${target.name} ‡∏•‡πà‡∏°‡∏™‡∏•‡∏≤‡∏¢`;
            document.getElementById('decree-intro').innerText = `‡πÇ‡∏î‡∏¢‡∏£‡∏≤‡∏ä‡πÇ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏´‡πà‡∏á‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô`;
            document.getElementById('decree-emblem').innerHTML = `<span class="material-icons-round text-6xl text-[#FFD700] rotate-45 opacity-80" style="text-shadow: 0 0 10px #FFD700;">satellite_alt</span>`;


            const content = `
                <p>
                    ‡∏ì ‡∏¢‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ó‡∏¥‡∏ß‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏ï‡∏£‡∏µ‡∏ö‡∏£‡∏£‡∏à‡∏ö‡∏Å‡∏±‡∏ô ‡∏ö‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Ç‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏Å‡πà‡∏´‡∏°‡∏π‡πà‡πÄ‡∏ó‡∏ß‡∏≤ ‡∏ü‡πâ‡∏≤‡∏î‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏£‡∏û‡∏ä‡∏ô‡∏ó‡∏±‡πà‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏ê‡∏°‡∏†‡∏û‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡πÇ‡∏î‡∏¢‡∏ó‡∏±‡πà‡∏ß‡∏Å‡∏±‡∏ô‡∏ß‡πà‡∏≤
                </p>
                <p>
                    ‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô <b id="decree-target-name" class="decree-title font-bold text-amber-300">${target.name}</b> ‡∏≠‡∏±‡∏ô‡πÄ‡∏Ñ‡∏¢‡∏ï‡∏±‡πâ‡∏á‡∏°‡∏±‡πà‡∏ô‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á ‡∏ö‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏•‡πà‡∏ß‡∏á‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ú‡∏±‡∏ô‡πÅ‡∏´‡πà‡∏á‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤
                </p>
                <p>
                    ‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏±‡∏¢‡∏ä‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏ä‡∏ò‡∏£‡∏£‡∏°‡∏≠‡∏±‡∏ô‡πÅ‡∏ú‡πà‡πÑ‡∏û‡∏®‡∏≤‡∏• ‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏´‡∏•‡∏≠‡∏°‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏≠‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö <b id="decree-attacker-name" class="decree-title font-bold text-amber-300">${attacker.name}</b>
                </p>
                <p>
                    ‡πÄ‡∏™‡πâ‡∏ô‡∏û‡∏£‡∏°‡πÅ‡∏î‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÅ‡∏ö‡πà‡∏á‡πÅ‡∏¢‡∏Å‡∏ö‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏ô‡∏´‡∏≤‡∏¢‡∏î‡∏±‡∏á‡∏´‡∏°‡∏≠‡∏Å‡πÉ‡∏ô‡∏≠‡∏£‡∏∏‡∏ì‡∏£‡∏∏‡πà‡∏á ‡∏ô‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏ô‡∏µ‡πâ‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏à‡∏±‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏õ‡∏ê‡∏ß‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏™‡∏∑‡∏ö‡πÑ‡∏õ
                </p>
            `;
            document.getElementById('decree-main-content').innerHTML = content;
            
            // 2. Display modal
            document.getElementById('modal-decree').classList.remove('hidden');
        }


        window.showToast = (msg) => {
            const div = document.createElement('div');
            div.className = "fixed top-20 left-1/2 -translate-x-1/2 bg-[#5D4037] text-white px-4 py-2 rounded-full shadow-lg text-sm z-[3000] animate-fade-in";
            div.innerText = msg;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        // --- Core Filtering Logic ---
        function filterEntities() {
            const searchTxt = document.getElementById('search-input').value.toLowerCase();
            const selectedLevels = Array.from(document.querySelectorAll('.filter-level:checked')).map(cb => cb.value);
            const selectedStatuses = Array.from(document.querySelectorAll('.filter-status:checked')).map(cb => cb.value);
            
            // Ensure all promoted ranks are also considered for filtering
            const allFilterLevels = new Set(selectedLevels);
            HIERARCHY.filter(h => h.promoted).forEach(h => {
                if(selectedLevels.includes(h.promoteFrom)) allFilterLevels.add(h.id);
            });
            

            const sorted = [...entities].sort((a, b) => getRank(b.level) - getRank(a.level));
            
            if (!searchTxt) {
                // No search text logic
                return { visibleEntities: sorted.filter(ent => {
                    if(ent.type !== 'area') return true;
                    // Use allFilterLevels to include promoted ranks if base rank is selected
                    if(!allFilterLevels.has(ent.level)) return false; 

                    // Status Logic
                    let status = 'independent';
                    if (ent.isColony) status = 'colony';
                    else if (ent.isVassal) status = 'vassal';
                    else if (ent.isAnnexed) status = 'annexed';

                    return selectedStatuses.includes(status);
                })};
            }

            const directMatches = sorted.filter(ent => {
                const nameMatch = ent.name.toLowerCase().includes(searchTxt);
                const annexMatch = ent.isAnnexed && ent.annexedByName && ent.annexedByName.toLowerCase().includes(searchTxt);
                const rulerMatch = ent.ruler && ent.ruler.toLowerCase().includes(searchTxt);
                const levelMatch = getHierarchyName(ent.level).toLowerCase().includes(searchTxt);
                return nameMatch || annexMatch || rulerMatch || levelMatch;
            });

            const directMatchIds = directMatches.map(e => e.id);
            const descendants = getDescendants(directMatchIds);
            const descendantIds = new Set(descendants.map(d => d.id));
            const allowedIds = new Set([...directMatchIds, ...descendantIds]);

            const result = sorted.filter(ent => {
                if (ent.type !== 'area') return true; 
                if (!allowedIds.has(ent.id)) return false;
                
                // Use allFilterLevels to include promoted ranks if base rank is selected
                if (!allFilterLevels.has(ent.level)) return false; 

                // Status Logic
                let status = 'independent';
                if (ent.isColony) status = 'colony';
                else if (ent.isVassal) status = 'vassal';
                else if (ent.isAnnexed) status = 'annexed';

                return selectedStatuses.includes(status);
            });

            return { visibleEntities: result };
        }
        
        // --- PROMOTION HELPER FUNCTIONS (Req 3) ---
        
        /**
         * Checks if an area entity meets the requirements to be promoted.
         * @param {string} entityId - ID of the potential parent entity.
         * @returns {object|null} The promoted rank object if eligible, otherwise null.
         */
        function checkChildrenStatus(entityId) {
            const parent = entities.find(e => e.id === entityId);
            if (!parent || parent.type !== 'area') return null;

            // Find the rank this entity can be promoted to
            const promotionCandidate = HIERARCHY.find(h => h.promoted && h.promoteFrom === parent.level);
            if (!promotionCandidate) return null;

            // Find all direct children
            const children = entities.filter(e => e.parentId === entityId && e.type === 'area');
            if (children.length === 0) return null; // Must have children to be promoted

            // Check if all children have the required promoted level
            const requiredLevel = promotionCandidate.requiredChildrenLevel;
            const allChildrenMatch = children.every(c => c.level === requiredLevel);
            
            if (allChildrenMatch) {
                // If it meets the promotion requirement, return the promotion rank object
                return promotionCandidate;
            }

            return null;
        }


        function createPopupContent(ent, displayColor, colorContext) {
            const flag = ent.flag || 'https://cdn-icons-png.flaticon.com/512/1458/1458514.png';
            
            let mainTitle = ent.name;
            let subStatus = "";
            let statusBadge = '<span class="bg-emerald-100 text-emerald-700 text-[10px] px-2 py-0.5 rounded-full border border-emerald-200">‡∏£‡∏±‡∏ê‡∏≠‡∏¥‡∏™‡∏£‡∏∞</span>';
            
            if (ent.isAnnexed) {
                statusBadge = '<span class="bg-amber-100 text-amber-700 text-[10px] px-2 py-0.5 rounded-full border border-amber-200">‡∏ñ‡∏π‡∏Å‡∏ú‡∏ô‡∏ß‡∏Å</span>';
                mainTitle = ent.annexedByName; 
                subStatus = `<div class="text-[10px] text-gray-500 mt-1">‡∏ú‡∏ô‡∏ß‡∏Å‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡∏à‡∏≤‡∏Å ${ent.originalName || ent.name}</div>`;
            } else if (ent.isVassal) {
                statusBadge = '<span class="bg-purple-100 text-purple-700 text-[10px] px-2 py-0.5 rounded-full border border-purple-200">‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä</span>';
                subStatus = `<div class="text-[11px] text-red-600 font-bold mt-1">(‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏£‡∏≤‡∏ä‡∏Ç‡∏≠‡∏á ${ent.annexedByName})</div>`;
            } else if (ent.isColony) {
                statusBadge = '<span class="bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded-full border border-blue-100">‡∏≠‡∏≤‡∏ì‡∏≤‡∏ô‡∏¥‡∏Ñ‡∏°</span>';
                subStatus = `<div class="text-[11px] text-red-600 font-bold mt-1">(‡∏≠‡∏≤‡∏ì‡∏≤‡∏ô‡∏¥‡∏Ñ‡∏°‡∏Ç‡∏≠‡∏á ${ent.annexedByName})</div>`;
            } else if (ent.isWater) {
                statusBadge = '<span class="bg-blue-50 text-blue-600 text-[10px] px-2 py-0.5 rounded-full border border-blue-100">‡∏ô‡πà‡∏≤‡∏ô‡∏ô‡πâ‡∏≥</span>';
            }

            let colorDesc = "‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏Ç‡∏ï";
            if(colorContext.type === 'religion') colorDesc = `‚ò∏Ô∏è ‡∏®‡∏≤‡∏™‡∏ô‡∏≤: ${colorContext.value}`;
            else if(colorContext.type === 'gov') colorDesc = `‚öñÔ∏è ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á: ${colorContext.value}`;
            else if(colorContext.type === 'rank') colorDesc = `üëë ‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå: ${getHierarchyName(ent.level)}`;
            else if(colorContext.type === 'water') colorDesc = `üåä ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ‡∏ô‡πà‡∏≤‡∏ô‡∏ô‡πâ‡∏≥`;

            const ancestors = getAncestors(ent);
            let hierarchyHtml = '';
            if(ancestors.length > 0) {
                hierarchyHtml = `<div class="hierarchy-path">`;
                ancestors.forEach(a => { hierarchyHtml += `<span class="h-node">${a.name}</span>`; });
                hierarchyHtml += `<span class="h-node">${ent.name}</span></div>`;
            } else {
                hierarchyHtml = `<div class="hierarchy-path"><span class="h-node">${ent.name} (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)</span></div>`;
            }
            
            // REQ 4: Promotion Button Logic
            let promotionButton = '';
            if (ent.type === 'area' && !ent.isWater) {
                const promotion = checkChildrenStatus(ent.id);
                if (promotion) {
                    promotionButton = `
                        <button onclick="window.confirmPromotion('${ent.id}', '${promotion.id}', '${promotion.name}', '${promotion.promoteFrom}')" 
                            class="px-3 h-8 rounded-full bg-yellow-500 text-white text-[10px] hover:bg-yellow-600 flex items-center gap-1 transition shadow-md hover:scale-105 border border-white/20">
                            <span class="material-icons-round text-sm">auto_graph</span> ‡∏¢‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${promotion.name}
                        </button>
                    `;
                }
            }
            
            // REQ 6: Undo Merge Button (for dependent layers)
            let undoMergeButton = '';
            if (ent.parentId && !ent.isAnnexed && !ent.isVassal && !ent.isColony) {
                // If it has a parent but is not a war dependent (meaning it was created via "‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà")
                undoMergeButton = `
                    <button onclick="window.confirmUndoMerge('${ent.id}')" class="px-3 h-8 rounded-full bg-red-700 text-white text-[10px] hover:bg-red-800 flex items-center gap-1 transition shadow-md hover:scale-105 border border-white/20">
                        <span class="material-icons-round text-sm">undo</span> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏° (‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å)
                    </button>
                `;
            }
            
            // --- UPDATED: REQ 2 - Get Ruler Title and use it as the section header ---
            const rulerTitle = getRulerTitle(ent.level, ent.government);


            return `
                <div class="relative font-sans overflow-visible group">
                    <span class="sparkle-icon s1">‚ú®</span>
                    <span class="sparkle-icon s2">‚ú®</span>
                    <span class="sparkle-icon s3">‚ú¶</span>
                    
                    <div class="h-20 bg-gradient-to-r from-[#FFF8E1] to-white rounded-t-2xl relative overflow-hidden">
                        <div class="absolute inset-0 bg-white/30 backdrop-blur-[1px]"></div>
                    </div>
                    
                    <div class="absolute top-4 left-1/2 transform -translate-x-1/2">
                        <div class="w-20 h-20 rounded-full p-1 bg-white shadow-lg relative z-10">
                            <img src="${flag}" class="w-full h-full rounded-full object-cover border border-gray-100">
                        </div>
                    </div>

                    <div class="pt-10 px-6 pb-6 text-center relative z-10">
                        <h3 class="text-xl font-bold text-[#5D4037] leading-tight cute-font mt-1 drop-shadow-sm">${mainTitle}</h3>
                        ${subStatus}
                        <div class="mt-2 mb-4 flex flex-col justify-center gap-2 items-center">
                            ${statusBadge}
                            <div class="color-tag"><span class="swatch-circle" style="background-color:${displayColor}"></span> ${colorDesc}</div>
                        </div>
                        
                        <div class="text-left text-xs bg-white/80 p-3 rounded-xl border border-[#EEE] space-y-2 shadow-sm">
                            <div class="pb-2 border-b border-dashed border-[#DDD]">
                                <span class="text-[#A1887F] block mb-1 text-[9px] uppercase tracking-wide font-bold">üè≥Ô∏è ‡∏™‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</span>
                                ${hierarchyHtml}
                            </div>
                            <div class="flex justify-between border-b border-dashed border-[#DDD] pb-2 pt-1">
                                <span class="text-gray-400">‡∏£‡∏∞‡∏î‡∏±‡∏ö</span>
                                <span class="font-bold text-[#8D6E63]">${getHierarchyName(ent.level)}</span>
                            </div>
                            <div class="pt-1">
                                <span class="text-gray-400 block text-[10px]">${rulerTitle}</span> 
                                <span class="font-bold text-[#5D4037] truncate block text-sm">${ent.ruler}</span>
                            </div>
                        </div>
                        
                        <div class="mt-5 flex flex-wrap gap-2 justify-center pt-2">
                            ${(!ent.isWater && ent.type === 'area') ? `
                                <button onclick="window.openEditModal('${ent.id}')" class="w-8 h-8 rounded-full bg-blue-50 text-blue-500 hover:bg-blue-100 flex items-center justify-center transition shadow-sm hover:scale-110" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•/‡∏™‡∏µ"><span class="material-icons-round text-sm">edit</span></button>
                                <button onclick="window.confirmDelete('${ent.id}')" class="w-8 h-8 rounded-full bg-red-50 text-red-500 hover:bg-red-100 flex items-center justify-center transition shadow-sm hover:scale-110" title="‡∏•‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà"><span class="material-icons-round text-sm">delete</span></button>
                            ` : ''}

                            ${(!ent.isWater && ent.type === 'area') ? `<button onclick="window.openWarModal('${ent.id}')" class="px-3 h-8 rounded-full bg-[#5D4037] text-white text-[10px] hover:bg-[#4E342E] flex items-center gap-1 transition shadow-md hover:scale-105 border border-white/20">‚öîÔ∏è ‡∏¢‡∏∏‡∏ó‡∏ò‡∏Å‡∏≤‡∏£</button>` : ''}
                            
                            ${(ent.isAnnexed || ent.isVassal || ent.isColony) ? `
                                <button onclick="window.declareIndependence('${ent.id}')" class="px-3 h-8 rounded-full bg-emerald-500 text-white text-[10px] hover:bg-emerald-600 flex items-center gap-1 transition shadow-md hover:scale-105 border border-white/20">üö© ‡∏Å‡∏π‡πâ‡πÄ‡∏≠‡∏Å‡∏£‡∏≤‡∏ä</button>
                            ` : ''}
                            
                            ${promotionButton}
                            ${undoMergeButton}
                        </div>
                    </div>
                </div>
            `;
        }

        window.confirmPromotion = async (id, newLevelId, newLevelName, oldLevelName) => {
            const ent = entities.find(e=>e.id===id);
            const promotionText = `‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å ${getHierarchyName(oldLevelName)} ‡πÄ‡∏õ‡πá‡∏ô ${newLevelName}`;

            showConfirmModal(`‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà`, 
                `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ${getHierarchyName(oldLevelName)} ${ent.name} ‡πÄ‡∏õ‡πá‡∏ô ${newLevelName} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, 
                async () => {
                    await performPromotion(id, newLevelId);
                    // Trigger decree after successful promotion
                    const promotedEnt = entities.find(e => e.id === id) || ent;
                    promotedEnt.level = newLevelId; // Update local state for decree
                    showAppointmentDecreeModal(promotedEnt, promotionText);
                }
            );
        };
        
        async function performPromotion(id, newLevelId) {
            if(!window.userId || !currentMapSheetId) return;
            // Check again to be safe
            if (!checkChildrenStatus(id)) {
                 showConfirmModal("‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏¢‡πà‡∏≠‡∏¢‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", null, true);
                 return;
            }
            try {
                await setDoc(doc(getEntityCollectionRef(), id), { level: newLevelId }, { merge: true });
                // showToast is now inside the confirm logic to ensure decree runs
            } catch(e) {
                 showConfirmModal("‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", e.message, null, true);
            }
        }
        
        window.confirmUndoMerge = (id) => {
            showConfirmModal("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏° (‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å)", 
                "‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞) ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà (Sub-Layer) ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏£‡∏ß‡∏°‡πÑ‡∏ß‡πâ‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏¢‡πà‡∏≠‡∏¢ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", 
                async () => await performUndoMerge(id)
            );
        };
        
        async function performUndoMerge(id) {
             if(!window.userId || !currentMapSheetId) return;
             
             try {
                // Find the entity and its original properties
                const ent = entities.find(e => e.id === id);
                if (!ent) return;
                
                // Reset parentId to null (independent)
                await setDoc(doc(getEntityCollectionRef(), id), {
                    parentId: null
                }, { merge: true });
                
                showToast(`üö© ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ${ent.name} ‡∏ñ‡∏π‡∏Å‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß!`);
             } catch (e) {
                showConfirmModal("‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", e.message, null, true);
             }
        }


        function updateLegend(mode) {
            const container = document.getElementById('legend-content');
            container.innerHTML = '';
            let data = {};
            let title = '';

            if (mode === 'religion') { data = COLORS.religion; title = '‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏®‡∏≤‡∏™‡∏ô‡∏≤'; }
            else if (mode === 'government') { data = COLORS.gov; title = '‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏ö‡∏≠‡∏ö‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á'; }
            else if (mode === 'rank') { 
                data = {};
                // Include all ranks for the legend
                HIERARCHY.sort((a, b) => b.rank - a.rank).forEach(h => data[h.name] = h.defaultColor);
                title = '‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á';
            }

            document.getElementById('legend-title').innerText = title;
            for (const [key, color] of Object.entries(data)) {
                container.innerHTML += `<div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full border border-gray-200" style="background-color: ${color}"></span><span class="truncate">${key}</span></div>`;
            }
        }

        // --- UPDATED Draw Functions to use checkModeAndDraw ---
        window.startDrawPolygon = () => checkModeAndDraw('polygon');
        window.startDrawPolyline = () => checkModeAndDraw('polyline');
        window.startDrawMarker = () => checkModeAndDraw('marker');
        window.toggleFullScreen = async () => {
             try {
                if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
                else await document.exitFullscreen();
             } catch(e) {
                 showConfirmModal("Fullscreen Error", "‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠", null, true);
             }
        }
        
        // --- NEW: Custom Draw Modes ---
        window.startPointMode = () => {
             if (!currentMapSheetId) { showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î"); return; }
             checkModeAndDraw('polygon'); // Check for 3D/Edit mode first
             
             // If in 2D and not in edit mode (checked by checkModeAndDraw), proceed
             if (!is3DMode && !isEditMode) {
                 window.toggleDrawMenu();
                 const drawer = new L.Draw.Polygon(map, {
                     shapeOptions: {
                         color: '#FFB74D',
                         weight: 2
                     }
                 });
                 drawer.enable();
                 
                 // Hook for Right Click Delete
                 const handler = (e) => {
                     // Check if enabled and has internal poly
                     if(drawer._enabled && drawer._poly && drawer._poly.getLatLngs().length > 0) {
                         drawer.deleteLastVertex();
                     }
                 };
                 
                 map.on('contextmenu', handler);
                 
                 // Remove hook when draw ends
                 map.once(L.Draw.Event.CREATED, () => map.off('contextmenu', handler));
             }
        };

        window.startFreehandMode = () => {
            if (!currentMapSheetId) { showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î"); return; }
            checkModeAndDraw('polygon'); // Check for 3D/Edit mode first

            // If in 2D and not in edit mode (checked by checkModeAndDraw), proceed
            if (!is3DMode && !isEditMode) {
                window.toggleDrawMenu();
                isFreehand = true;
                map.dragging.disable();
                // ** REQ: ‡πÄ‡∏Ñ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏£‡∏π‡∏õ‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤ **
                document.getElementById('map').classList.add('cursor-pen');
                map.on('mousedown', onFreehandDown);
                map.on('mouseup', onFreehandUp);
                showToast("‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏≠‡∏¥‡∏™‡∏£‡∏∞ (‡∏•‡∏≤‡∏Å‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏ö)");
            }
        };

        function onFreehandDown(e) {
            map.on('mousemove', onFreehandMove);
            freehandPath = [e.latlng];
            // Use a temporary layer on Leaflet to show the path
            tempLine = L.polyline(freehandPath, {color: '#FFB74D', weight: 3}).addTo(map);
        }

        function onFreehandMove(e) {
            freehandPath.push(e.latlng);
            tempLine.setLatLngs(freehandPath);
        }

        function onFreehandUp() {
            map.off('mousemove', onFreehandMove);
            map.off('mousedown', onFreehandDown);
            map.off('mouseup', onFreehandUp);
            
            // Close the loop
            if(freehandPath.length > 5) {
                 freehandPath.push(freehandPath[0]);
                 const poly = L.polygon(freehandPath);
                 const event = { layer: poly, layerType: 'polygon' };
                 onDrawCreated(event); // Treat as a created polygon
            } else {
                 showToast("‡∏ß‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏¢‡∏≤‡∏ß‡∏û‡∏≠‡∏™‡∏°‡∏Ñ‡∏ß‡∏£");
            }
            
            // Cleanup temp line and reset state
            if(tempLine) map.removeLayer(tempLine);
            map.dragging.enable();
            document.getElementById('map').classList.remove('cursor-pen');
            isFreehand = false;
        }


        function onDrawCreated(e) {
            if (!currentMapSheetId) { 
                drawnItems.removeLayer(e.layer);
                showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î"); 
                return;
            }

            currentDrawLayer = e.layer;
            drawnItems.addLayer(currentDrawLayer); 
            if (e.layerType === 'polygon') {
                document.getElementById('modal-area').classList.remove('hidden');
                document.getElementById('form-area').reset();
                document.getElementById('area-id').value = '';
                document.getElementById('inp-level').dispatchEvent(new Event('change'));
            } else if (e.layerType === 'polyline') {
                document.getElementById('modal-road').classList.remove('hidden');
            } else if (e.layerType === 'marker') {
                document.getElementById('modal-marker').classList.remove('hidden');
            }
        }

        function onDrawEdited(e) {
            e.layers.eachLayer(async (layer) => {
                if(layer.options.entityId) await setDoc(doc(getEntityCollectionRef(), layer.options.entityId), { geoJson: JSON.stringify(layer.toGeoJSON()) }, { merge: true });
            });
        }

        window.saveRoad = async () => {
            if(!validateAuth()) return;
            const weight = document.getElementById('road-weight').value;
            const data = {
                name: document.getElementById('road-name').value || '‡∏ó‡∏≤‡∏á‡πÑ‡∏£‡πâ‡∏ä‡∏∑‡πà‡∏≠',
                roadType: document.getElementById('road-type').value,
                color: document.getElementById('road-color').value,
                weight: weight,
                geoJson: JSON.stringify(currentDrawLayer.toGeoJSON()),
                type: 'road', level: 'road'
            };
            await saveToFirestore(data);
            closeModal('modal-road'); currentDrawLayer = null;
        }

        window.saveMarker = async () => {
            if(!validateAuth()) return;
            const data = {
                name: document.getElementById('marker-name').value || '‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç',
                iconUrl: selectedMarkerIconUrl,
                color: document.getElementById('marker-color').value,
                geoJson: JSON.stringify(currentDrawLayer.toGeoJSON()),
                type: 'marker', level: 'marker'
            };
            await saveToFirestore(data);
            closeModal('modal-marker'); currentDrawLayer = null;
        }

        window.saveArea = async (e) => {
            e.preventDefault();
            if(!validateAuth()) return;
            
            const isNew = !document.getElementById('area-id').value;
            const id = document.getElementById('area-id').value;

            const data = {
                name: document.getElementById('inp-name').value,
                customId: document.getElementById('inp-custom-id').value,
                level: document.getElementById('inp-level').value,
                parentId: document.getElementById('inp-parent').value,
                ruler: document.getElementById('inp-ruler').value,
                religion: document.getElementById('inp-religion').value,
                government: document.getElementById('inp-gov').value,
                color: document.getElementById('inp-color').value,
                labelColor: document.getElementById('inp-label-color').value,
                isWater: document.querySelector('input[name="areaType"]:checked').value === 'water',
                type: 'area'
            };
            
            const img = document.getElementById('preview-flag');
            if(img.src && !img.src.includes(window.location.href)) data.flag = img.src;

            if(isNew) {
                data.geoJson = JSON.stringify(currentDrawLayer.toGeoJSON());
                data.createdAt = new Date().toISOString();
                data.originalName = data.name; 
                data.originalRuler = data.ruler; 
                data.originalColor = data.color; 
            } else {
                 const oldEnt = entities.find(e => e.id === id);
                 // Preserve original properties only if editing an existing non-dependent area
                 if(oldEnt && !oldEnt.originalColor) data.originalColor = oldEnt.color;
                 if(oldEnt && !oldEnt.originalRuler) data.originalRuler = oldEnt.ruler;
                 if(oldEnt && !oldEnt.originalName) data.originalName = oldEnt.name;
            }

            // Perform save operation
            const savedId = await saveToFirestore(data, id);
            
            // Post-save decree check (only for new creation)
            if (isNew && getRank(data.level) >= 9) {
                 const tempEntity = { ...data, id: savedId || 'new-temp' }; // Use the actual ID if created, or a temp one
                 showCoronationDecreeModal(tempEntity);
            } else if (isNew) {
                 const tempEntity = { ...data, id: savedId || 'new-temp' };
                 showAppointmentDecreeModal(tempEntity, '‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà');
            }


            closeModal('modal-area'); currentDrawLayer = null;
        }

        function validateAuth() {
            if (!window.userId) {
                showConfirmModal("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", null, true);
                return false;
            }
            if (!currentMapSheetId) {
                showConfirmModal("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", null, true);
                return false;
            }
            return true;
        }

        async function saveToFirestore(data, id = null) {
            if (!currentMapSheetId) { showConfirmModal("Error", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", null, true); return null; }
            try {
                const colRef = getEntityCollectionRef();
                if(id) {
                    await setDoc(doc(colRef, id), data, {merge: true});
                    return id;
                }
                else {
                    const docRef = await addDoc(colRef, data);
                    return docRef.id;
                }
            } catch(e) { showConfirmModal("Error", e.message, null, true); return null; }
        }
        
        // Function to filter options in the attacker select dropdown
        window.filterAttackerOptions = () => {
             const searchInput = document.getElementById('war-attacker-search').value.toLowerCase();
             const select = document.getElementById('war-attacker-select');
             
             // Get the target entity ID to exclude it
             const tid = document.getElementById('war-target-id').value;
             
             // 1. Get all allowed attackers (re-filter from all entities)
             const allowedAttackers = entities.filter(e => 
                !e.isWater && 
                e.type === 'area' && 
                e.id !== tid && 
                ATTACK_RANK_VALUES.has(getRank(e.level))
             );
             
             // 2. Filter by search input
             const filteredAttackers = allowedAttackers.filter(e => 
                 e.name.toLowerCase().includes(searchInput) || 
                 e.ruler.toLowerCase().includes(searchTxt)
             );

             // 3. Update the select element
             select.innerHTML = '';
             filteredAttackers.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.id;
                opt.text = `${e.name} (${getHierarchyName(e.level)}) - ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á: ${e.ruler}`;
                select.appendChild(opt);
             });
             
             // Re-check restrictions after filtering
             checkWarActionRestrictions(select.value);
        }

        window.openWarModal = (tid) => {
            const t = entities.find(e => e.id === tid);
            document.getElementById('war-target-id').value = tid;
            document.getElementById('war-target-name').innerText = t.name; 
            document.getElementById('war-attacker-search').value = ''; // Clear search field
            
            // 1. Initial population and filtering of the attacker select dropdown
            window.filterAttackerOptions();
            
            // 2. Set event listener for attacker selection to check restrictions
            document.getElementById('war-attacker-select').onchange = (e) => checkWarActionRestrictions(e.target.value);
            
            // 3. Check restrictions for the first element
            checkWarActionRestrictions(document.getElementById('war-attacker-select').value);

            document.getElementById('modal-war').classList.remove('hidden');
        }
        
        function checkWarActionRestrictions(aid) {
             const attacker = entities.find(e => e.id === aid);
             const isNakorn = attacker && attacker.level === 'nakorn';

             // Nakorn can only '‡∏ú‡∏ô‡∏ß‡∏Å‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô' (Annex)
             document.getElementById('btn-vassal').style.display = isNakorn ? 'none' : 'flex';
             document.getElementById('btn-colony').style.display = isNakorn ? 'none' : 'flex';
             // Removed: document.getElementById('btn-split-territory').style.display = isNakorn ? 'none' : 'flex';
             document.getElementById('btn-annex').style.display = 'flex'; // Annex is always allowed
        }


        window.confirmWarAction = async (type) => {
            const tid = document.getElementById('war-target-id').value;
            const aid = document.getElementById('war-attacker-select').value;
            const attacker = entities.find(e => e.id === aid);
            const target = entities.find(e => e.id === tid);
            
            // Reinforce restriction check before execution
            if (attacker && attacker.level === 'nakorn' && type !== 'annex') {
                showConfirmModal("‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ô‡∏Ñ‡∏£", "‡∏ô‡∏Ñ‡∏£‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà '‡∏ú‡∏ô‡∏ß‡∏Å‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô' ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô", null, true);
                return;
            }
            
            const updates = { isAnnexed: false, isVassal: false, isColony: false };
            
            if(type === 'annex') updates.isAnnexed = true;
            if(type === 'vassal') updates.isVassal = true;
            if(type === 'colony') updates.isColony = true;

            updates.annexedByName = attacker.name; 
            updates.occupiedBy = attacker.id; 
            updates.ruler = attacker.ruler;

            // Preserve original properties
            updates.originalColor = target.originalColor || target.color;
            updates.originalRuler = target.originalRuler || target.ruler;
            updates.originalName = target.originalName || target.name;

            if(type === 'colony') {
                updates.color = updates.originalColor; // Colony keeps its original color (only dashed border changes)
            } else {
                updates.color = attacker.color; // Annex/Vassal take the conqueror's color
            }
            
            await setDoc(doc(getEntityCollectionRef(), tid), updates, {merge: true});
            closeModal('modal-war');
        }

        window.declareIndependence = (id) => {
            showConfirmModal("‡∏Å‡∏π‡πâ‡πÄ‡∏≠‡∏Å‡∏£‡∏≤‡∏ä", "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏≠‡∏¥‡∏™‡∏£‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°", async () => {
                const ent = entities.find(e => e.id === id);
                
                // Reset parentId, independence status, and affiliation
                await setDoc(doc(getEntityCollectionRef(), id), {
                    isAnnexed: false, isVassal: false, isColony: false,
                    color: ent.originalColor || ent.color, 
                    ruler: ent.originalRuler || ent.ruler,
                    occupiedBy: null, annexedByName: null,
                    parentId: null // Ensure it breaks free from all layers of control
                }, {merge: true});
            });
        }

        window.confirmDelete = (id) => {
             if (!currentMapSheetId) return;
             showConfirmModal("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?", async () => await deleteDoc(doc(getEntityCollectionRef(), id)));
        }

        window.openEditModal = (id) => {
            const ent = entities.find(e => e.id === id);
            document.getElementById('modal-area').classList.remove('hidden');
            document.getElementById('area-id').value = ent.id;
            document.getElementById('inp-name').value = ent.name; // Use current name, not original name
            document.getElementById('inp-custom-id').value = ent.customId || '';
            document.getElementById('inp-level').value = ent.level; // Use current level
            
            // Only show base ranks in the dropdown (if the current level is promoted, it will still show, but the list only contains base ranks)
            updateParentSelect(getRank(ent.level));
            document.getElementById('inp-parent').value = ent.parentId || "";
            document.getElementById('inp-ruler').value = ent.ruler; // Use current ruler
            document.getElementById('inp-religion').value = ent.religion;
            document.getElementById('inp-gov').value = ent.government;
            
            // For editing, use the area's current color, but prioritize original color if it exists for consistency
            document.getElementById('inp-color').value = ent.originalColor || ent.color; 
            document.getElementById('inp-label-color').value = ent.labelColor || '#4E342E';
            document.querySelector(`input[name="areaType"][value="${ent.isWater ? 'water' : 'land'}"]`).checked = true;

            if(ent.flag) {
                document.getElementById('preview-flag').src = ent.flag;
                document.getElementById('preview-flag').classList.remove('hidden');
                document.getElementById('preview-flag-placeholder').classList.add('hidden');
            } else {
                 document.getElementById('preview-flag').classList.add('hidden');
                 document.getElementById('preview-flag-placeholder').classList.remove('hidden');
                 document.getElementById('preview-flag').src = '';
            }
            
            document.getElementById('modal-title').innerText = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏Ç‡∏ï‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á: ${ent.name}`;
        }

        document.getElementById('form-login').onsubmit = async (e) => {
            e.preventDefault();
            try { await signInWithEmailAndPassword(auth, document.getElementById('login-username').value, document.getElementById('login-password').value); closeModal('modal-login'); }
            catch(err) { showConfirmModal("Login Failed", err.message, null, true); }
        }
        document.getElementById('form-register').onsubmit = async (e) => {
            e.preventDefault();
            try {
                const u = await createUserWithEmailAndPassword(auth, document.getElementById('reg-email').value, document.getElementById('reg-password').value);
                await updateProfile(u.user, { displayName: document.getElementById('reg-username').value });
                closeModal('modal-register');
            } catch(err) { showConfirmModal("Register Failed", err.message, null, true); }
        }
        window.logoutUser = () => signOut(auth);

        window.cancelDraw = () => { 
            if(currentDrawLayer && !document.getElementById('area-id').value) drawnItems.removeLayer(currentDrawLayer); 
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden')); 
            currentDrawLayer=null; 
        }
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.showConfirmModal = (t, m, fn, alert=false) => {
            document.getElementById('confirm-title').innerText = t; document.getElementById('confirm-msg').innerText = m; pendingConfirmAction = fn;
            const btns = document.querySelectorAll('#modal-confirm button');
            btns[0].style.display = alert ? 'none' : 'block'; 
            btns[1].innerText = alert ? '‡∏ï‡∏Å‡∏•‡∏á' : '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
            btns[1].onclick = alert ? () => closeModal('modal-confirm') : executePendingConfirm;
            document.getElementById('modal-confirm').classList.remove('hidden');
        }
        window.executePendingConfirm = async () => { if(pendingConfirmAction) await pendingConfirmAction(); closeModal('modal-confirm'); }
        
        /**
         * Toggles the geometry editing mode.
         * Enters/Exits edit mode and handles saving the currently edited layer.
         */
        window.toggleEditGeometry = async () => {
            if (!validateAuth()) return;
            // ** REQ: ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ 2D ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô 3D **
            if(is3DMode) {
                toggleGlobeMode();
                showConfirmModal("‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î", "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏¢‡∏±‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà 2 ‡∏°‡∏¥‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á' ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á", null, true);
                return;
            }

            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏´‡∏°
            const hasLayers = entities.some(e => e.type === 'area' || e.type === 'road');
            if (!hasLayers) {
                showConfirmModal("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç", null, true);
                return;
            }
            
            const btn = document.getElementById('btn-edit-geom');
            isEditMode = !isEditMode; // ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î

            if (isEditMode) {
                // --- ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ---
                if(document.getElementById('draw-submenu').classList.contains('active')) window.toggleDrawMenu();
                if(isMultiSelectMode) toggleMultiSelectMode(); // ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î Multi-Select ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
                
                btn.classList.add('bg-pink-100', 'ring-2', 'ring-pink-300');
                showToast("üîß ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏à‡∏¥‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÄ‡∏™‡πâ‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
                map.closePopup(); 
            } else {
                // --- ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å) ---
                if (window.editingLayer) {
                    window.editingLayer.editing.disable(); // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase
                    try {
                        const geoJson = JSON.stringify(window.editingLayer.toGeoJSON());
                        const docRef = doc(getEntityCollectionRef(), window.editingLayer.options.entityId);
                        await setDoc(docRef, { geoJson: geoJson }, { merge: true });
                        showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ");
                    } catch(e) {
                        console.error(e);
                        showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
                    }
                }
                
                // Clear state and re-render the map to ensure all layers are in normal mode
                window.editingLayer = null;
                window.editingLayerId = null;
                renderMap();

                btn.classList.remove('bg-pink-100', 'ring-2', 'ring-pink-300');
                showToast("‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç");
            }
        };
        
        function updateParentSelect(rank) {
            const s = document.getElementById('inp-parent'); s.innerHTML = '<option value="">-- ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞ --</option>';
            // Filter out promoted ranks and only allow higher rank selection
            entities.filter(e => !getRankObject(e.level)?.promoted && getRank(e.level) > rank && !e.isWater).forEach(p => s.innerHTML += `<option value="${p.id}\">${p.name}</option>`);
        }
        function getRank(id) { return HIERARCHY.find(x=>x.id===id)?.rank || 0; }
        function getHierarchyName(id) { return HIERARCHY.find(x=>x.id===id)?.name || id; }

        document.getElementById('inp-flag').onchange = (e) => {
            if(e.target.files[0]) {
                const r = new FileReader(); r.onload = (ev) => { 
                    document.getElementById('preview-flag').src = ev.target.result; 
                    document.getElementById('preview-flag').classList.remove('hidden');
                    document.getElementById('preview-flag-placeholder').classList.add('hidden');
                }; r.readAsDataURL(e.target.files[0]);
            }
        }
    </script>
</body>
</html>
